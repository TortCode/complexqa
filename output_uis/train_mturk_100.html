<crowd-form answer-format="flatten-objects">
  <section class="container-fluid" id="Relevancy">
    <div class="row">
      <div class="col-xs-12 col-md-12">
        <div class="panel panel-primary">
          <a class="panel-heading" href="javascript:void(0);" id="collapseTrigger">
            <strong>Annotation Instructions</strong>
            <span class="collapse-text">(Click to expand)</span>
          </a>
          <div class="panel-body" id="instructionBody">
            {{INSTRUCTIONS}}
            {{LINK}}
          </div>
        </div>
      </div>
    </div>

    Enable developer mode:
    <input type="checkbox" id="developer-mode">

    <h3>Document</h3>
    <div id="document-text" class="ann well well-sm">
      Live Updates: Boston Marathon Explosions 2306 UTC As the story starts to turn from the explosions to the investigation, stay with VOA as we continue our coverage. Nearly four hours after the <trigger id='trigger-0'>blasts</trigger> rocked the <role id='role-0-Place-0'trigno='0'>Boston</role> Marathon, here is what VOA knows: Two explosions near the finish <role id='role-1-Place-0'trigno='1'>line</role> <trigger id='trigger-1'>killed</trigger> two <role id='role-1-Victim-0'trigno='1'>people</role> and <trigger id='trigger-2'>wounded</trigger> more than <role id='role-2-Victim-0'trigno='2'>fifty</role>. A third incident took place at the nearby John F. Kennedy library about 90 minutes later, but police are not sure if it is related to the marathon blasts. President Obama says officals do not yet know who is responsible for the bombings, but that the U. S. will find out who did this and hold them accountable. No person or group has claimed responsiblity for the bombing. 2255 UTC This story is likely to dominate a lot of front pages around the world for several days. #Boston #Marathon dominates Tuesday's UK front pages twitter. com / suttonnick / sta …-via @ suttonnick #TomorrowsPapersToday #BBCPapers — BBC Breaking News (@ BBCBreaking) April 15, 2013 2252 UTC Due to the generosity of our donors we don't need blood at this time. Please schedule for a future donation redcrossblood. org #marathon — RedCrossEasternMA (@ RedCrossEastMA) April 15, 2013 2251 UTC Location of the marathon finish line in <role id='role-3-Place-0'trigno='3'>Boston</role>, Massachusetts, where two deadly <trigger id='trigger-3'>explosions</trigger> occurred. 2247 UTC Scene at BMC. It's calming down. #bostonmarathon #boston twitter. com / PDRosso / status … — Patrick D. Rosso (@ PDRosso) April 15, 2013 2233 UTC Flags over @ uscapitol being lowered to half-staff out of respect for the victims of Boston Marathon tragedy j. mp / YqJ8zj — Speaker John Boehner (@ SpeakerBoehner) April 15, 2013 2229 UTC The London Marathon, which is scheduled to be held on Sunday, April 21, has released the following statement: We are deeply saddened and shocked by the news from Boston. Our immediate thoughts are with the people there and their families. It is a very sad day for athletics and for our friends and colleagues in marathon running. Our security plan is developed jointly with the Metropolitan Police and we were in contact with them as soon as we heard the news. Met Police Chief Superintendent Julia Pendry said:"A security plan is in place for the London Marathon. We will be reviewing our security arrangements in partnership with London Marathon."2219 UTC More of President Obama's public statement: Obama said he is directing the full resources of federal government to help state and local authorities to protect our people and increase security around the country. He added,"We don’t yet have all the answers but we do know multiple people have been wounded, some gravely in the Boston marathon."He said he has spoken with FBI director Muller and Homeland Security director Naplitano and that they are mobilizing resources to respond. He added that he has updated leaders of congress in both parties. He said also said Boston police, firefighters and first responders as well as the national guard responded heroically and continue to do so as we speak."We still do not know who did this or why and people should not jump to conclusions without all the facts. We will get to the bottom of this. We will find out who did this and why they did this. Any responsible individual and responsible groups will feel the full weight of justice."2213 UTC President Obama says they do not yet know who is responsible for the bombings, but that the U. S. will find out who did this and hold them accountable. 2210 UTC Watch the president's statement from the White House. JOIN THE LIVE CHAT VISIT WHITEHOUSE. GOV 2208 UTC AT & T says it is leaving its WiFi on at the Boston Marathon. Boston customers may have issues w / wireless voice & data service due to spike in network activity. Our Wi-Fi remains on at #BostonMarathon. — AT & T (@ ATT) April 15, 2013 Interesting, is the digital equivalent of blood donation during crisis--open up WiFi to help connect loved ones? — Andrew Lih (@ fuzheado) April 15, 2013 2202 UTC Authorities now say <role id='role-4-Victim-0'trigno='4'>two</role> <trigger id='trigger-4'>dead</trigger> and at least <role id='role-5-Victim-0'trigno='5'>50</role> <trigger id='trigger-5'>injured</trigger> in the blasts. 2153 UTC Human nature at its best. The list of people offering a place to stay tonight: bit. ly / 106kZEN #bostonmarathon #explosion — Catherine Cloutier (@ cmcloutier) April 15, 2013 2149 UTC President Obama will make an address from the press room at the White House in about 30 minutes. No further details have been released yet. 2145 UTC Boston police say to expect more visible security: People should expect to see high policevisibility at key locations #tweetfromthebeat — Cheryl Fiandaca (@ CherylFiandaca) April 15, 2013 And people start seeing more security: Police w automatic weapons @ Brigham now #wcvb twitter. com / wcvbkelleyt / st … — Kelley Tuthill (@ wcvbkelleyt) April 15, 2013 2139 UTC Just got some numbers from the BAA: 23, 326 started the marathon. Of those, 17, 584 finished. 4, 496 did not. — Amalie Benjamin (@ AmalieBenjamin) April 15, 2013 2136 UTC Google has started a person finder for those looking for people who may have been at the Boston Marathon today. 2134 UTC Times Square right now twitter. com / clarerrrr / stat … — Clare Richardson (@ clarerrrr) April 15, 2013 2131 UTC The White House has released a photo of President Obama on the phone with officials in Boston today. 2123 UTC New from the Boston police: Update JFK incident appears to be fire related #tweetfromthebeat — Cheryl Fiandaca (@ CherylFiandaca) April 15, 2013 2118 UTC Via Computer World: A fixed camera captured the moment two explosions rocked the finish line of today's Boston Marathon. 2116 UTC Statement from Gov on #BostonMarathon tragedy: governor. ny. gov / press / 04152013 … There is heightened security @ #1WTC & on transit #MTA — Andrew Cuomo (@ NYGovCuomo) April 15, 2013 2114 UTC MARATHON EXPLOSIONS: Boston hospitals report more than 100 being treated after Marathon explosions. — The Boston Globe (@ BostonGlobe) April 15, 2013 2110 UTC Incredible video of the explosions as they happened from Boston. com 2106 UTC Cellphone service shut down in Boston to prevent remote detonations of explosives, official says: apne. ws / ZwBMKb-CC — The Associated Press (@ AP) April 15, 2013 2105 UTC Marathoners picking up their possessions at Bolston & Berkeley. twitter. com / taylordobbs / st … — Taylor Dobbs (@ taylordobbs) April 15, 2013 2103 UTC More from the police press conference: Police may continue blowing things up (controled explosions) in next couple of hours. Question: Is this a terrorist attack? Answer from Boston Police Commissioner Edward Davis:"We're not being definitive at this time but you can reach your own conclusions."2100 UTC From the Boston police department: Police stabilizing situation-checking packages #tweetfromthebeat — Cheryl Fiandaca (@ CherylFiandaca) April 15, 2013 2059 UTC #Bruins game vs. Ottawa has been postponed — The Boston Globe (@ BostonGlobe) April 15, 2013 2057 UTC More from the Boston press conference: Three incidents occurred. Two happened simultaneously. The third occurred at the JFK Library about half hour ago (approximately 4: 30 pm EST). People should be calm but they should understand this is an ongoing event. . . . Governor Deval Patrick said President Obama called him, offering any help needed. Encouraged people to stay out of crowds. Tourists should go back to hotels. A third incident at JFK library. Not certain related-but BPD treating like they are #tweetfromthebeat — Cheryl Fiandaca (@ CherylFiandaca) April 15, 2013 2054 UTC From the police press conference in Boston: Edward Davis, Boston Police Commissioner, says the blasts occurred 50 to 100 yards apart. Multiple casualties. All victims been removed from scene. Sent officers to hospitals to be in touch with family members and possible witnesses. Immediately activated system of resposnse that the commonwealth of Massachusettes has in place. First calls were to FBI and state police. There is a third incident, an explosion at the JFK Library. But authorities are not certain incidents are related. Recommending people stay home. Anyone with information should call 1-800-494-TIPS 2052 UTC The FAA has imposed a no-fly zone over the site of the Boston Marathon explosions. 2050 UTC RT @ mediaite: WATCH LIVE: Boston Officials Hold Press Conference On Marathon Explosions mediaite. com / online / watch-l … via @ mediaite — WhiteHousePressCorps (@ whpresscorps) April 15, 2013 2049 UTC Register here to find loved ones. Also-make sure they know you're safe. redcross. org / find-help — RedCrossEasternMA (@ RedCrossEastMA) April 15, 2013 2044 UTC The White House says President Obama has called Boston Mayor Tom Menino and Massachusetts Governor Deval Patrick and told them his administration would provide whatever assistance is necessary in the investigation and response. 2040 UTC Security officials confirm at least two more explosive devices were found near the scene and were being dismantled. Police telling people on scene of Boston Marathon #explosions to not use cell phones because could set off other devices — ABC News (@ ABC) April 15, 2013 2037 UTC Families with signs hoping to find their runners twitter. com / megansarahj / st … — Megan Johnson (@ megansarahj) April 15, 2013 2031 UTC News conference in 15 minutes Westin Hotel #tweetfromthebeat — Cheryl Fiandaca (@ CherylFiandaca) April 15, 2013 BREAKING: Multiple explosive devices found, at least 2 which exploded, officials tell NBC News — NBC Nightly News (@ nbcnightlynews) April 15, 2013 BREAKING NEWS: Police getting multiple reports of unexploded devices around Boston — The Boston Globe (@ BostonGlobe) April 15, 2013 2030 UTC Runners reuniting with family on Berkeley st by back bay hotel. Lots of oh Thank gods. twitter. com / megansarahj / st … — Megan Johnson (@ megansarahj) April 15, 2013 2028 UTC Director of emergency services at Mass General describes injuries as"from a war zone"#WCVB #bostonexplosion #Boston #marathon — Liam Martin (@ LiamWCVB) April 15, 2013 BPD aggressively moving ppl now. Saying anyone nearby is in danger. #BostonMararthon #wbz yfrog. us / gvffshboivhhua … — Jim Armstrong (@ JimArmstrongWBZ) April 15, 2013 2026 UTC The New York Times just published a very useful graphic of the explosion locations. Meanwhile, New York City is stepping up security at various locations in response to the blasts in Boston. NYPD is stepping up security at hotels and prominent locations in NYC until more is known about #BostonMarathon. — NYC Mayor's Office (@ NYCMayorsOffice) April 15, 2013 2023 UTC If you are concerned for a friend that ran the #BostonMarathon today, you can see their last check-in here: raceday. baa. org / individual. html — NowThis News (@ nowthisnews) April 15, 2013 2020 UTC At least one college in the Boston area is sending out alerts to its students. Explosions reported at Boston Marathon Finish Line. Please stay away from Copley Square area. Please remain on campus until further notice. — Emerson College (@ EmersonCollege) April 15, 2013 2016 UTC Runners emerging from Comm. Ave. tunnel. They're telling me they won't be allowed to finish. Spectators applaud. twitter. com / taylordobbs / st … — Taylor Dobbs (@ taylordobbs) April 15, 2013 2014 UTC More pictures of the aftermath from Twitter. Police react in aftermath of explosion #bostonmarathon #boylstonst (John Tlumacki photo) twitter. com / BGlobeSports / s … — Boston Globe Sports (@ BGlobeSports) April 15, 2013 Photo from our John Tlumacki of explosion on #BoylstonSt #BostonMarathon twitter. com / BGlobeSports / s … — Boston Globe Sports (@ BGlobeSports) April 15, 2013 2010 UTC In a post on Facebook, Boston marathon says:"There were two <role id='role-6-ExplosiveDevice-0'trigno='6'>bombs</role> that <trigger id='trigger-6'>exploded</trigger> near the finish line in today's <role id='role-6-Place-0'trigno='6'>Boston</role> Marathon. We are working with law enforcement to understand what exactly has happened."Boston police say 2 are dead and 23 were injured by the explosions. Update 23 injuries2 dead #tweetfromthebeat — Cheryl Fiandaca (@ CherylFiandaca) April 15, 2013 2000 UTC A spokeswoman for Massachusetts General Hospital said four <role id='role-7-Patient-0'trigno='7'>patients</role> were being <trigger id='trigger-7'>treated</trigger> <role id='role-7-Place-0'trigno='7'>there</role>. A New York City Police Department spokesman said the city has stepped up security around landmarks in Manhattan, including near prominent hotels, in response to the blast. Here are some early pictures and video of the explosions. Explosion at coply twitter. com / Boston_to_a_T / … — Boston to a T (@ Boston_to_a_T) April 15, 2013 The first #photo from the scene of the #Boston Marathon. #Breaking twitter. com / theinquisitr / s … — The Inquisitr (@ theinquisitr) April 15, 2013 This claims to be a video of the explosion at the Boston marathon:
    </div>

    <div id='events-data' hidden>
      [{"event_id": "48_VOA_EN_NW_2013.04.15.1641943-E1", "text": "blasts", "offset": 35, "length": 1, "template": "[Attacker] detonated or exploded [ExplosiveDevice] explosive device using [Instrument] to attack [Target] target at [Place] place", "role_text_map": [{"role": "Attacker", "tokens": []}, {"role": "Target", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "ExplosiveDevice", "tokens": []}, {"role": "Place", "tokens": [{"text": "Boston", "entity_id": "48_VOA_EN_NW_2013.04.15.1641943-T307", "offset": 38, "length": 1}]}]}, {"event_id": "48_VOA_EN_NW_2013.04.15.1641943-E2", "text": "killed", "offset": 53, "length": 1, "template": "[Victim] died at [Place] place from [MedicalIssue] medical issue, killed by [Killer] killer", "role_text_map": [{"role": "Victim", "tokens": [{"text": "people", "entity_id": "48_VOA_EN_NW_2013.04.15.1641943-T250", "offset": 55, "length": 1}]}, {"role": "Place", "tokens": [{"text": "line", "entity_id": "48_VOA_EN_NW_2013.04.15.1641943-T247", "offset": 52, "length": 1}]}, {"role": "Killer", "tokens": []}, {"role": "MedicalIssue", "tokens": []}]}, {"event_id": "48_VOA_EN_NW_2013.04.15.1641943-E3", "text": "wounded", "offset": 57, "length": 1, "template": "[Victim] was injured by [Injurer] using [Instrument] in [BodyPart] body part with [MedicalCondition] medical issue at [Place] place", "role_text_map": [{"role": "Victim", "tokens": [{"text": "fifty", "entity_id": "48_VOA_EN_NW_2013.04.15.1641943-T249", "offset": 60, "length": 1}]}, {"role": "Injurer", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "BodyPart", "tokens": []}, {"role": "MedicalCondition", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "48_VOA_EN_NW_2013.04.15.1641943-E4", "text": "explosions", "offset": 253, "length": 1, "template": "[Attacker] detonated or exploded [ExplosiveDevice] explosive device using [Instrument] to attack [Target] target at [Place] place", "role_text_map": [{"role": "Attacker", "tokens": []}, {"role": "Target", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "ExplosiveDevice", "tokens": []}, {"role": "Place", "tokens": [{"text": "Boston", "entity_id": "48_VOA_EN_NW_2013.04.15.1641943-T102", "offset": 246, "length": 1}]}]}, {"event_id": "48_VOA_EN_NW_2013.04.15.1641943-E5", "text": "dead", "offset": 803, "length": 1, "template": "[Victim] died at [Place] place from [MedicalIssue] medical issue, killed by [Killer] killer", "role_text_map": [{"role": "Victim", "tokens": [{"text": "two", "entity_id": "48_VOA_EN_NW_2013.04.15.1641943-T110", "offset": 802, "length": 1}]}, {"role": "Place", "tokens": []}, {"role": "Killer", "tokens": []}, {"role": "MedicalIssue", "tokens": []}]}, {"event_id": "48_VOA_EN_NW_2013.04.15.1641943-E6", "text": "injured", "offset": 808, "length": 1, "template": "[Victim] was injured by [Injurer] using [Instrument] in [BodyPart] body part with [MedicalCondition] medical issue at [Place] place", "role_text_map": [{"role": "Victim", "tokens": [{"text": "50", "entity_id": "48_VOA_EN_NW_2013.04.15.1641943-T109", "offset": 807, "length": 1}]}, {"role": "Injurer", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "BodyPart", "tokens": []}, {"role": "MedicalCondition", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "48_VOA_EN_NW_2013.04.15.1641943-E7", "text": "exploded", "offset": 2318, "length": 1, "template": "[Attacker] detonated or exploded [ExplosiveDevice] explosive device using [Instrument] to attack [Target] target at [Place] place", "role_text_map": [{"role": "Attacker", "tokens": []}, {"role": "Target", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "ExplosiveDevice", "tokens": [{"text": "bombs", "entity_id": "48_VOA_EN_NW_2013.04.15.1641943-T229", "offset": 2316, "length": 1}]}, {"role": "Place", "tokens": [{"text": "Boston", "entity_id": "48_VOA_EN_NW_2013.04.15.1641943-T226", "offset": 2327, "length": 1}]}]}, {"event_id": "48_VOA_EN_NW_2013.04.15.1641943-E8", "text": "treated", "offset": 2388, "length": 1, "template": "[Treater] treater treated [Patient] patient for [MedicalIssue] medical issue with [Instrument] means at [Place] place", "role_text_map": [{"role": "Treater", "tokens": []}, {"role": "Patient", "tokens": [{"text": "patients", "entity_id": "48_VOA_EN_NW_2013.04.15.1641943-T298", "offset": 2385, "length": 1}]}, {"role": "MedicalIssue", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "Place", "tokens": [{"text": "there", "entity_id": "48_VOA_EN_NW_2013.04.15.1641943-T299", "offset": 2389, "length": 1}]}]}]
    </div>

    <div id='relations-data' hidden>
      []
    </div>

    <div id="strategyB-tuples" hidden>
      ${strategyB-tuples}
    </div>

    <p>
      You can navigate all of the events by clicking the following buttons. <br>
      You have to finish all the events before submitting. (Remember that you can't refresh the page otherwise
      the progress will be gone, <br>
      to prevent this from happening, we suggest that you write the QA pairs in the google doc and copy paste them
      here)
    </p>
    <!-- Tabs for each trigger -->
    <div class="btn-toolbar" id="button-bar">
    </div>

    <div class="strategies">
      <span id="strategy-btns">
        <button id="selectA" class="btn btn-default" type="button">
          Strategy A</button>
        <button id="selectB" class="btn btn-default" type="button">
          Strategy B</button>
      </span>
      <select id="tuple-select">
      </select>
      <div class="ann-component">
        <em>
          KAIROS event arguments for triggers
        </em>
        <div id='template-area' class='ann well well-sm'>
        </div>
      </div>
      <div class="strategy" id="strategyA">
        <div class="ann-component">
          <em>
            These are relations between events.
          </em>
          <div id='relations-area' class='ann well well-sm'>
          </div>
        </div>
      </div>
      <div class="strategy" id="strategyB">
      </div>
    </div>
    <div id="input-area">
    </div>
    <div title="Fill all fields before submitting">
      <button id="save" class="btn btn-default" type="button">Save</button>
      <button id="submitButton" class="btn btn-default" type="button">Submit</button>
    </div>
  </section>


  <link crossorigin="anonymous" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
    integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" rel="stylesheet" />
  <style>.mg-15 {
    margin-left: 15px;
    margin-right: 15px;
}

.mg-5 {
    margin: 5px;
}

.container-fluid {
    max-width: 1800px;
    margin: 30px;
}

.btn-container {
    display: inline-block;
    margin: 10px;
}

.strategies {
    margin: 15px;
}

.ann-component {
    margin: 5px;
}


#collapseTrigger {
    color: #fff;
    display: block;
    text-decoration: none;
}

#submitButton {
    white-space: normal;
}

#input-area {
    display: block;
    margin: 10px;
}

.input-fields {
    margin: 10px;
    padding: 10px;
    background-color: #ffe3e3;
    border-radius: 15px;
}

#template-area {
    background-color: #eee;
    display: flex;
}

#relations-area {
    display: flex;
    flex-direction: column;
    row-gap: 5px;
}

.template-map {
    border: 1px solid gray;
    padding: 5px;
}

.btn-container>button {
    min-width: 3em;
}

trigger {
    display: inline;
}

role {
    display: inline;
}

.highlight-trigger {
    background-color: lightgoldenrodyellow;
}

.highlight-role {
    background-color: lightblue;
}

.highlight-role1 {
    background-color: rgba(255, 255, 0, 0.5);
}

.highlight-role2 {
    background-color: rgba(0, 255, 255, 0.5);
}

.highlight-role3 {
    background-color: rgba(255, 0, 255, 0.5);
}

.btn-group {
    vertical-align: middle;
}

.content {
    margin-bottom: 15px;
}

.ann {
    font-size: 16px;
}

.disp {
    font-size: 20px;
}

.ann>span.token {
    cursor: pointer;
}

.ann>span.token:hover {
    text-decoration: underline;
}

.ann>strong.annotation:hover {
    text-decoration: line-through;
}

input[disabled] {
    color: #000
}

.question-input, .answer-input {
    vertical-align: middle;
}</style>
  <script src="https://code.jquery.com/jquery-3.1.0.min.js"
    integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
    integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>
  <script>// ---------------------------------------------------------
// Global
// ---------------------------------------------------------

var page_num_set = new Set();
let strategy = '';
let developer_mode = false;

// ---------------------------------------------------------
// Create jQuery elements
// ---------------------------------------------------------

var submit = $('#submitButton');

// list of text/offset objects 
const events_data = JSON.parse($('#events-data').text().trim());
const relations_data = JSON.parse($('#relations-data').text().trim());
const strategyB_tuples = [["road_ied_8-E1", "road_ied_8-E2", "road_ied_8-E3"]];//JSON.parse($('#strategyB-tuples').text().trim());

const empty_template_map = function () {
    return $('<div class="template-map">');
}

const save_record = {
    A: {
        relations: relations_data,
        qapairs: [],
    },
    B: {
        qapairs: [],
    },
};

const strategyA_template = function (tno, event1, event2) {
    return {
        question: '',
        answer: '',
    }
}

const template_record = [];
events_data.forEach(function (ei, i) {
    template_record[i] = empty_template_map();
    events_data.forEach(function (ej, j) {
        if (i >= j) return;

        for (let tno = 1; tno <= 4; tno++){
            {
                const { question, answer } = strategyA_template(tno, ei, ej);
                save_record.A.qapairs.push({
                    event1_id: ei.event_id,
                    event2_id: ej.event_id,
                    templateno: tno,
                    question,
                    answer,
                });
            }
            {
                const { question, answer } = strategyA_template(tno, ej, ei);
                save_record.A.qapairs.push({
                    event1_id: ej.event_id,
                    event2_id: ei.event_id,
                    templateno: tno,
                    question,
                    answer,
                });
            }
        }
    });
});

function strategyB_template(event1_id, event2_id, event3_id) {
    const question = 'What is the participant in the event that interviews the transporter that flew the place that gone off the explosive device. ';
    const answer = '';
    return {
        question, answer
    };
}

strategyB_tuples.forEach(function (tuple, i) {
    const { question, answer } = strategyB_template(tuple[0], tuple[1], tuple[2]);
    save_record.B.qapairs.push({
        event1_id: tuple[0],
        event2_id: tuple[1],
        event3_id: tuple[2],
        question,
        answer,
    });
});

// implementation of string formatting
if (!String.prototype.format) {
    String.prototype.format = function () {
        var args = arguments;
        return this.replace(/{(\d+)}/g, function (match, number) {
            return typeof args[number] != 'undefined'
                ? args[number]
                : match
                ;
        });
    };
}

// ---------------------------------------------------------
// Create elements
// ---------------------------------------------------------

var makeDom = function () {
    recoverUserInput();
    console.log(page_num_set);
    highlightEvent();
};

var highlightEvent = function () {
    /* highlight trigger within document */
    const pagenos = Array.from(page_num_set);
    pagenos.sort((a, b) => events_data[a].offset - events_data[b].offset);

    // remove previous highlights
    $('trigger').removeClass('highlight-trigger');
    $('role').removeClass('highlight-role1 highlight-role2 highlight-role3');

    pagenos.forEach(trigger_num => {
        // highlight trigger
        $('#trigger-' + trigger_num).addClass('highlight-trigger');
        $('role[trigno=' + trigger_num + ']').addClass('highlight-role'+(trigger_num+1));
    })
}

const relationTypes = [
    "BEFORE",
    "AFTER",
    "OVERLAPS",
    "EQUAL",
    "CONTAINS",
    "CONTAINED BY",
    "CAUSES",
    "CAUSED BY",
]

// restore input from other trigger
var recoverUserInput = function () {
    const inputArea = $('#input-area');
    inputArea.empty();
    page_num_set.clear();

    let pagenos = [];
    if (strategy === 'A') {
        // questions
        const event_pair = $('#tuple-select').val().split(',').map(x => parseInt(x));
        page_num_set.add(event_pair[0]);
        page_num_set.add(event_pair[1]);

        pagenos = event_pair;
        pagenos.sort((a, b) => events_data[a].offset - events_data[b].offset);

        // relations
        const relationsArea = $('#relations-area');
        relationsArea.empty();
        pagenos.forEach(i => {
            pagenos.forEach(j => {
                if (i >= j) return;

                const event1 = events_data[i];
                const event2 = events_data[j];
                relationsArea.append(makeRelationSelect(event1, event2));
                relationsArea.append(makeRelationSelect(event2, event1));
            })
        })

        const matching_pairs = save_record.A.qapairs.filter(qa => {
            return (
                (qa.event1_id === events_data[event_pair[0]].event_id &&
                qa.event2_id === events_data[event_pair[1]].event_id) ||
                (qa.event1_id === events_data[event_pair[1]].event_id &&
                qa.event2_id === events_data[event_pair[0]].event_id)
            );
        });
        matching_pairs.forEach((qa, i) => {
            add_qa_input(qa.question, qa.answer, qa);
            if (i % 2 === 1 && i < matching_pairs.length - 1)
                inputArea.add($('<hr>'));
        });
    } else if (strategy === 'B') {
        const tuple = save_record.B.qapairs[$('#tuple-select').val()];
        console.log("TUPLE", tuple)
        page_num_set.add(events_data.findIndex(e => e.event_id === tuple.event1_id));
        page_num_set.add(events_data.findIndex(e => e.event_id === tuple.event2_id));
        page_num_set.add(events_data.findIndex(e => e.event_id === tuple.event3_id));
        pagenos = Array.from(page_num_set);
        pagenos.sort((a, b) => events_data[a].offset - events_data[b].offset);
        add_qa_input(tuple.question, tuple.answer, null, false);
        add_qa_input('', '', tuple, true);
    }
    // templates
    const templateArea = $('#template-area');
    templateArea.empty()
    pagenos.forEach(trigger_num => {
        const div = $('<div>')
            .append($('<p>').text(describeEvent(events_data[trigger_num])))
            .append(template_record[trigger_num]);
        templateArea.append(div);
    });
};

function describeEvent(event) {
    return (developer_mode ? `ID: ${event.event_id} | ` : "") + `${event.text} @ ${event.offset}`;
}

function makeRelationSelect(event1, event2) {
    const id1 = event1.event_id;
    const id2 = event2.event_id;
    const relation = relations_data.find(r =>
        r.event1_id == id1 &&
        r.event2_id == id2
    );

    const selectInput =
        $('<select class="relation-select mg-5">');
    relationTypes.forEach(type => {
        const option = $(`<option value="${type}">${type.toLowerCase()}</option>`);
        selectInput.append(option);
    });
    selectInput.append($('<option value="NONE">none</option>'));
    selectInput.val(relation?.type ?? "NONE");
    selectInput.on('change', function () {
        const type = $(this).val();
        const event1_id = id1;
        const event2_id = id2;
        const relation = relations_data.find(r =>
            r.event1_id == event1_id &&
            r.event2_id == event2_id
        );
        if (relation) {
            relation.type = type;
        } else {
            relations_data.push({
                event1_id,
                event2_id,
                type,
            });
        }
    });

    const div = $('<div>')
        .append($('<label>').text(describeEvent(event1)))
        .append(selectInput)
        .append($('<label>').text(describeEvent(event2)))

    return div;
}

// ensure something is in the input box
var canSubmit = function () {
    return true;
};

// template role fields
const make_role_mapping_element = function (role, text) {
    const role_text = $('<label>').html('<b>' + role + '</b>:');
    const role_field = $('<span>')
        .addClass('role-field')
        .attr({
            role: role,
            rows: 1,
        })
        .text(text)

    const role_div = $('<div>')
        .addClass('role-container')
        .append(role_text)
        .append(role_field);

    return role_div;
}


const add_qa_input = function (question = '', answer = '', ref = null, editable = true) {
    let question_text = $('<label>').text('question:');
    let question_input = $('<textarea>')
        .addClass('question-input')
        .addClass('mg-15')
        .attr({
            placeholder: 'write down your question',
            rows: 2,
            cols: 80,
        })
        .text(question);
    question_input.on("input", function () {
        console.log('q', ref)
        if (ref != null)
            ref.question = $(this).val();
        show();
    });
    let answer_text = $('<label>').text('answer:');
    let answer_input = $('<textarea>')
        .addClass('answer-input')
        .addClass('mg-15')
        .attr({
            placeholder: 'write down your answer',
            rows: 2,
            cols: 80,
        })
        .text(answer);
    answer_input.on("input", function () {
        console.log('a', ref)
        if (ref != null)
            ref.answer = $(this).val();
        show();
    });

    if (!editable) {
        question_input.attr('disabled', 'disabled');
        answer_input.attr('disabled', 'disabled');
    }

    const input_fields = $('<div>')
        .addClass('input-fields')
        .append(question_text)
        .append(question_input)
        .append(answer_text)
        .append(answer_input)

    $('#input-area').append(input_fields);

    show();
};

var enable_button = function (button) {
    button.removeAttr("disabled");
    button.removeClass("btn-default");
    button.addClass("btn-success");
};

var disable_button = function (button) {
    button.attr("disabled", "disabled");
    button.removeClass("btn-success");
    button.addClass("btn-default");
};

var select_button = function (button) {
    button.removeClass("btn-default");
    button.addClass("btn-primary");
};

var deselect_button = function (button) {
    button.removeClass("btn-primary");
    button.addClass("btn-default");
};

var is_wh_question = function (question) {
    let tokens = question.split(' ');
    if (tokens.length <= 1) {
        return false;
    }

    // let wh_pattern = /^Wh\|wh\|How\|how/;
    let wh_pattern = /^wh|Wh|how|How/;
    // console.log(question.match(wh_pattern));
    return !!question.match(wh_pattern);
};


var show = function () {
    for (button of document.getElementById('button-bar').getElementsByTagName('*')) {
        if (page_num_set.has(parseInt(button.getAttribute('page-no'))))
            select_button($(button));
        else
            deselect_button($(button));
    }

};

// dynamically create buttons for each SRL arg
events_data.forEach(function (event, i) {
    if (event.text.trim()) {
        var button = document.createElement("button");
        button.setAttribute("type", "button");
        button.setAttribute("id", "button-page-" + i);
        button.setAttribute("page-no", i);
        button.setAttribute("class", "btn btn-default");
        button.innerHTML = describeEvent(event);
        button.onclick = function () {
            // const pageno = parseInt(this.getAttribute("page-no"));
            // // toggle button
            // if (button.classList.contains('btn-default'))
            //     page_num_set.add(pageno);
            // else
            //     page_num_set.delete(pageno);
            // makeDom();
            // let instruction = $('#instructionBody');
            // if (instruction.is(':visible')) {
            //     instruction.toggle();
            // }
            // //window.scrollTo(0, 0); // scroll to top
            // show();
        }
        document.getElementById('button-bar').appendChild(button);
    }

    // format template area with role mappings
    // if template not null or undefined
    if (event.template !== null) {
        const template_area = template_record[i];
        const template = $('<p>').text(event.template);
        template_area.append(template);
        event.role_text_map.forEach(function (pairing) {
            template_area.append(make_role_mapping_element(pairing.role, pairing.tokens.map(tk => tk.text).join('/')));
        });
    }
})

// ---------------------------------------------------------
// Initialize
// ---------------------------------------------------------

var submit_form = function (event) {
    event.preventDefault();
    if (!window.confirm("Are you sure you want to submit?")) return;
    save_all();

    const urlParams = new URLSearchParams(window.location.search)

    // create the form element and point it to the correct endpoint
    const form = document.createElement('form')
    form.action = (new URL('mturk/externalSubmit', urlParams.get('turkSubmitTo'))).href
    form.method = 'post'

    // attach the assignmentId
    const inputAssignmentId = document.createElement('input')
    inputAssignmentId.name = 'assignmentId'
    inputAssignmentId.value = urlParams.get('assignmentId')
    inputAssignmentId.hidden = true
    form.appendChild(inputAssignmentId)

    // attach data I want to send back
    const inputResults = document.createElement('input')
    inputResults.name = 'results'
    inputResults.value = JSON.stringify(save_record)
    inputResults.hidden = true
    form.appendChild(inputResults)

    // attach the form to the HTML document and trigger submission
    document.body.appendChild(form)
    form.submit()
}

//$('#save').on('click', save_all);
submit.on('click', submit_form);

var popup_alert = function (alert_box, text) {
    alert_box.html(text);
    alert_box.css({
        'background-color': 'fec5bb',
        'padding': '5px',
        'border': '1px solid lightgray',
        'border-radius': '10px',
        'margin-top': '10px',
        'margin-bottom': '10px'
    });
    displaying = true;
    setTimeout(function () {
        alert_box.html('');
        alert_box.css({
            'padding': '0px',
            'border': '0px'
        });
        displaying = false;
    }, 7000);
};

const selectA = $('#selectA');
const selectB = $('#selectB');

const tupleSelect = $('#tuple-select');


function makeSelectionOptions() {
    if (strategy === 'A') {
        tupleSelect.empty();
        events_data.forEach(function (ei, i) {
            events_data.forEach(function (ej, j) {
                if (i >= j) return;
                const opt = $('<option>')
                    .attr({
                        value: `${i},${j}`,
                    })
                    .text(`${describeEvent(ei)} & ${describeEvent(ej)}`);
                tupleSelect.append(opt);
            });
        });
        tupleSelect.children()[0].selected = true;
    } else {
        tupleSelect.empty();
        function describeEventById(id) {
            const event = events_data.find(e => e.event_id === id);
            return describeEvent(event);
        }
        strategyB_tuples.forEach(function (tuple, i) {
            const opt = $('<option>')
                .attr({
                    value: i,
                })
                .text(`${describeEventById(tuple[0])}, ${describeEventById(tuple[1])}, ${describeEventById(tuple[2])}`);
            tupleSelect.append(opt);
        });
        tupleSelect.children()[0].selected = true;
    }
}

selectA.on('click', function () {
    if (strategy === 'A') return;
    strategy = 'A';
    $('#strategyA').show();
    select_button(selectA);
    $('#strategyB').hide();
    deselect_button(selectB);
    makeSelectionOptions();
    makeDom();
    show();
});

selectB.on('click', function () {
    if (strategy === 'B') return;
    strategy = 'B';
    $('#strategyA').hide();
    deselect_button(selectA);
    $('#strategyB').show();
    select_button(selectB);
    makeSelectionOptions();
    makeDom();
    show();
});

selectA.click();

tupleSelect.on('change', function () {
    makeDom();
    show();
});

$('#developer-mode').on('change', function () {
    developer_mode = this.checked;
    makeSelectionOptions();
    makeDom();
    show();
});

// Instructions expand/collapse
var content = $('#instructionBody');
var instructions_trigger = $('#collapseTrigger');
// content.hide();
$('.collapse-text').text('(Click to collapse)');
instructions_trigger.click(function () {
    content.toggle();
    var isVisible = content.is(':visible');
    if (isVisible) {
        $('.collapse-text').text('(Click to collapse)');
    } else {
        $('.collapse-text').text('(Click to expand)');
    }
});

console.log(save_record)
show();
</script>
</crowd-form>