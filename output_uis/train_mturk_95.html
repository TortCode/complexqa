<crowd-form answer-format="flatten-objects">
  <section class="container-fluid" id="Relevancy">
    <div class="row">
      <div class="col-xs-12 col-md-12">
        <div class="panel panel-primary">
          <a class="panel-heading" href="javascript:void(0);" id="collapseTrigger">
            <strong>Annotation Instructions</strong>
            <span class="collapse-text">(Click to expand)</span>
          </a>
          <div class="panel-body" id="instructionBody">
            {{INSTRUCTIONS}}
            {{LINK}}
          </div>
        </div>
      </div>
    </div>

    Enable developer mode:
    <input type="checkbox" id="developer-mode">

    <h3>Document</h3>
    <div id="document-text" class="ann well well-sm">
      Multiple outlets, law enforcement officials, and President Obama responded throughout a manic Monday with news that a horrific looking scene made clear in downtown Boston, even as a frenzied search for more potential explosive devices continued and hospitals rushed to help survivors: The crowd at the finish line of the <role id='role-0-Target-0'trigno='0'>Boston Marathon</role> was <trigger id='trigger-0'>bombed</trigger> twice in what is being described as both a coordinated"event"and"an act of terror"with more than 140 <role id='role-1-Victim-0'trigno='1'>people</role> brutally <trigger id='trigger-1'>injured</trigger> at eight Boston hospitals and at least three dead, including a young child. Indeed, even as a city and a nation came together amidst the chaotic scene, there was not much good news in Boston this April 15 — the annual Patriot Day, a Massachusetts festival holiday with schools and offices closed for the marathon and, on this particular day, tragedy in the happiest of places. The <role id='role-2-Investigator-0'trigno='2'>FBI</role> has taken over"a potential <role id='role-2-Defendant-0'trigno='2'>terrorist</role> <trigger id='trigger-2'>investigation</trigger>,"FBI special agent in charge <role id='role-3-Communicator-0'trigno='3'><role id='role-2-Investigator-1'trigno='2'>Richard DesLauriers</role></role> <trigger id='trigger-3'>said</trigger> at a Monday evening press conference."There is no suspect"at the hospital, Boston Police commissioner Ed Davis said at the briefing, despite reports to the contrary — and speculation that there was still one or multiple persons of interest being questioned at the hospital. When asked if there was a person of interest at the hospital, DeLaurio declined to comment; he also declined to comment on a Wall Street Journal report that there were five additional devices, which was soon clarified to note that"investigators now doubt the devices were bombs"— just one of many conflicting reports citing anonymous law enforcement officials as the investigation began. (And that's not counting the conspiracy theories. ) After the death toll had stood at two for much of the day, <role id='role-4-Communicator-0'trigno='4'>Davis</role> <trigger id='trigger-4'>confirmed</trigger> at the evening <role id='role-4-Place-0'trigno='4'>event</role> that"at least three <role id='role-5-Victim-0'trigno='5'>people</role> have <trigger id='trigger-5'>died</trigger>"in the marathon bombing. Governor <role id='role-6-Communicator-0'trigno='6'>Deval Patrick</role> <trigger id='trigger-6'>said</trigger>"we are asking that everyone be at a state of heightened vigilance"as Boston planned to re-open on Tuesday, though he said it"will not be business as usual."Boston police and the FBI were scheduled to hold another news conference at 9: 30 a. m. Tuesday morning. At a late afternoon press conference with Patrick, <role id='role-7-Communicator-0'trigno='7'>Davis</role> initially <trigger id='trigger-7'>reported</trigger> a third <trigger id='trigger-8'>explosion</trigger> at <role id='role-8-Target-0'trigno='8'>JFK Library</role> in <role id='role-8-Place-0'trigno='8'>Boston</role>, which has since been given the all-clear as a separate fire. At a second police briefing, <role id='role-9-Communicator-0'trigno='9'>Davis</role> <trigger id='trigger-9'>said</trigger>"we have no <role id='role-9-Topic-0'trigno='9'>suspect</role> in custody,"as <role id='role-10-Communicator-0'trigno='10'><role id='role-9-Recipient-0'trigno='9'>CNN</role></role> <trigger id='trigger-10'>reported</trigger> that the FBI had classified the event as a terrorist attack. Senate Intelligence Committee Chair Dianne Feinstein classified it as a"terrorist incident"that"could be be foreign, could be homegrown."At a White House briefing shortly after 6 p. m. Eastern time on a quiet day in Washington, President Obama reiterated that federal and local <role id='role-11-Investigator-0'trigno='11'>investigators</role> are still in the <trigger id='trigger-11'>investigation</trigger> phase. He did not use the words"terror"or"terrorist"or"attack,"instead using the words"unnecessary loss"—"America will say a prayer for Boston tonight,"he said — before delivering a more forceful message: We don't yet have all the answers. . . We still do not know who did this or why. . . But make no mistake we will get to the bottom of this. We will find out who did this. . . and any responsible groups will feel the full weight of justice. <role id='role-12-Communicator-0'trigno='12'>NBC News</role> and <role id='role-12-Communicator-1'trigno='12'>others</role> <trigger id='trigger-12'>reported</trigger> that the <role id='role-12-Recipient-0'trigno='12'>White House</role> said the bombings would be"approached as an act of terror."Both <role id='role-13-Participant-1'trigno='13'><role id='role-13-Participant-1'trigno='13'>Obama</role></role> and Vice President <role id='role-13-Participant-0'trigno='13'><role id='role-13-Participant-0'trigno='13'>Joe Biden</role></role> will <trigger id='trigger-13'>meet</trigger> with Secretary of Defense <role id='role-13-Participant-2'trigno='13'><role id='role-13-Participant-2'trigno='13'>Chuck Hagel</role></role> on Tuesday. As the investigation continues and news reports continue to make sense of the fallout, you can follow the Boston police scanner, the Boston Globe live blog, and the local CBS, ABC, and Fox stations — as well as some solid Twitter lists. The basic details of the bombings, however, are starting to come into focus. After two explosions hit at around 2: 50 p. m. Boston Police would go on to confirm at least <role id='role-14-Victim-0'trigno='14'>three</role> <trigger id='trigger-14'>dead</trigger> — NBC News cited law enforcement officials as saying one was an eight-year-old <role id='role-14-Victim-1'trigno='14'>child</role>, a report confirmed by the Boston Globe — and 141 injuries. As for the two bombs that caused the carnage, it appears they were fairly unsophisticated devices, perhaps pipe bombs stuffed with ball bearings, which doctors later reported pulling out of victims'flesh. ABC News reported that the explosions were triggered by remote detonation, but there's still strikingly little known about the other specifics. Meanwhile, there were gruesome images and raw footage from Copley Square area to makeshift tents, from Boston hospitals to Instagram feeds, of lost limbs, hair on fire, children with severe burns, and worse. Scroll down for all the details on the victims, the persons of interest, the moment of horror, and eyewitness accounts. You can follow all of The Atlantic Wire's ongoing Boston Marathon bomb coverage right here — and our Day Two aftermath updates here. The Casualties The Boston Marathon is tracking runners here, and for those looking for information on loved ones, here are the best ways online. Also, phone numbers: for families of victims, call 617-635-4500; for tips, call 1-800-494-TIPS. The Boston chapter of the American Red Cross said on Monday evening that there was no need for additional blood donations"at this time"as their shelves were full. The Red Cross also opened a disaster response center for the recovery effort. Reports of casualties are largely unconfirmed and varying, but here they are, updated in relative real time. In a Monday night press conference, Dr. Peter Fagenholz, a trauma surgeon at Mass. General Hospital, explained that most of the casualties were vascular, bone-related or soft tissue injuries, and that there had been"several"amputees. Fagenholz explained that he started his day in surgery at 8 a. m. , and after the explosion worked nonstop until the press conference. Other local hospitals — some of the best in the nation — are flooded: Injury count as of 745 pm by hospital: Boston Children’s 8; Brigham 27; BMC 23; MGH 22; BI 21; St E's, 15; Tufts 9 — The Boston Globe (@ BostonGlobe) April 16, 2013 An update at the official law enforcement press conference Monday night put the casualty count at 141 injured, at least 15 of them critically. CNN reported that at least ten limbs were lost due to the explosions and doctors were picking ball bearings, a common shrapnel generator in pipe bombs, out of victims. The New York Post reported 12 casualties, and is further reporting that authorities say a suspect in detention is a Saudi national — officials have not confirmed this and Boston PD has not confirmed this. <role id='role-15-Communicator-0'trigno='15'>CBS News</role> is <trigger id='trigger-15'>reporting</trigger> that <role id='role-15-Recipient-0'trigno='15'>Boston PD</role> has <role id='role-15-Topic-0'trigno='15'>video</role> of someone"bringing multiple backpacks to blast site."There are various reports on Twitter of a suspect being detained, but Davis, the police commissioner, maintainted taht"we have no suspect in custody,"seeming to cast doubt on reports quoting a federal law enforcement official in the Post and elsewhere. Among the reported 141 injured a nine-year-old girl, a seven-year-old boy, a 12-year-old, and a two-year-old, according to The Boston Globe. Of the three dead, one is reportedly an eight-year-old boy. The"Person of Interest"For now, Boston Police say that there are no suspects, but when asked about scattered reports about a person of interest, officials — including the new FBI investigator — would not comment, though law enforcement officials maintain, however anonymously, that there are several active leads. Throughout the day and ahead of other media outlets, a law enforcement official kept telling the New York Post about a"Saudi national"as a potential suspect or person of interest, leading to many questions as well as similar reports from Fox News. Another report in the Los Angeles Times said one person — not a"suspect,"but apparently a Saudi national — was being questioned."A federal law enforcement officials said authorities were questioning a Saudi national who was taken to a Boston hospital with injuries,"the report reads."The person was not identified as a suspect."Later on Monday evening The Globe reported that authorities were"questioning person of interest in Marathon bombings at Brigham and Women's Hospital"but did not provide any details about the person's nationality. However, the paper maintains,"The situation remains fluid and it remains too early to establish the cause and motivation."Officials didn't offer much more clarity at the official press conference on Monday night and appear to be approaching the situation with caution. The New York Times reports,"Although investigators confirmed that they were speaking to a Saudi citizen, several law enforcement officials took pains to note that no one was being held in custody."Meanwhile, the FBI is asking for people to send in any info — photos, video, tips — or to call 1-800-CALL-FBI with information regarding the explosions. The investigation remains in the early stages, and the public is clearly pouncing on any sign of a lead. Reports of a police search at a Revere, Mass. condo complex between five and six on Monday night lit up Twitter. However, it's unclear if the search was related to a bombing or not. The Other Devices Soon after the initial explosions, Boston Globe photographer David L. Ryan reported that he heard but did not see a third explosion, and Boston police were scrambling to contain the scene."There were two booms heard from near the finish line"reports the AP. A spokeswoman at the Fairmont Copley Plaza Hotel, close to the explosion, says that it was around two blocks away, while The Boston Globe said that police were conducting a"controlled explosion"on the 600 block of Boylston Street. Over the course of the afternoon and evening, police say they found five additional devices along the marathon route, though a police source later said it was unclear if they were actually bombs. That number does not include numerous reports of suspicious packages around Boston and neighboring cities. The Boston Globe reported another device found near Harvard, and there was a bomb threat phoned in near the Financial District. There were also reports of undetonated devices being found as far away as Newton, though local police have denied those claims. Again, the Journal walked back its initial claim of the five unexploded devices. And then there was the library fire, which had a whole back-and-forth narrative of its own. Here's an updated interactive map of the at times confounding activity, including multiple reported incidents about unconfirmed devices, fires, and all the explosions throughout Monday, both alleged and confirmed, for a sense of scale in downtown Boston and beyond — even as the day seemed to settle on the two explosions near the finish line: The FBI said on Monday evening that local police and federal agents would sweep the entire length of the course to look for evidence and additional devices. Meanwhile, the Navy has sent an Explosive Ordnance Disposal team to help with the effort. The Pictures and Video of the Explosion Here are a couple of many images to flow in from social media early on: Explosion at coply twitter. com / Boston_to_a_T / … — Boston to a T (@ Boston_to_a_T) April 15, 2013 And one more: Just heard that bombs went off at #boston marathon finish line twitter. com / chanyasulkit / s … — Chris Chanyasulkit (@ chanyasulkit) April 15, 2013 Here is perhaps the most shocking, dramatic, and up-close video from the bombings, via the Globe: Here is the moment of impact for the first of the two confirmed explosions, by way of Twitter's Vine, right near the sidewalk (scroll down for video of both): We're going to link to these next two shots (WARNING — they are graphic) since they show the chaos and some of the injuries, and there are a few very graphic images that have been uploaded to Reddit. NECN's Jackie Bruno reports that the injuries there are gruesome: I saw people's legs blown off. Horrific. Two explosions. Runners were coming in and saw unspeakable horror. — Jackie Bruno (@ JackieBrunoNECN) April 15, 2013 To be sure, this is a time to be good to each other. Because there are as many unconfirmed reports and speculative ideas (CBS News reported that certain terrorist target areas are being monitored in Boston, and the Secret Service set up a perimeter around the White House) as there are graphic images. There are amputations. Here are some of the first photos to hit the AP wire (WARNING — it is graphic): This photo from Reuters photographer John Tlumacki quickly became the iconic image of the day: Check out this Tumblr post where you can see Tlumacki taking the photo. And one more from The Boston Globe: boston marathon explosion twitter. com / GlobeDavidLRya … — David L. Ryan (@ GlobeDavidLRyan) April 15, 2013 Here are more photos from The Atlantic's In Focus blog. Here's video of the first explosion: And another close-up video from the explosion: Here's how a marathon runner saw things: And here's another angle with a second explosion in the distance. Here is the photo of Obama on the phone with FBI Director Robert Mueller (official White House photo by Pete Souza): Here is text of President Obama's full remarks at the White House. Adding further heartbreak to utter tragedy, the 26th mile marker in this year's marathon was actually dedicated to the victims of Newtown. The Eyewitness Accounts The size of the crowd has yielded countless eyewitness accounts of the horrific scene. One of the more powerful ones we've read comes from The New York Times, which spoke to Rhode Island state trooper and former Marine Roupen Bastajian."These runners just finished and they don’t have legs now,"said Bastajian."So many of them. There are so many people without legs. It's all blood. There's blood everywhere. You got bones, fragments. It's disgusting."Several of those reporting on the explosions were actually runners in the marathon, so there is no shortage of eyewitness accounts. Two worth reading come from The Wall Street Journal reporter Coleen McCain Nelson and Boston Globe photographer John Tlumacki. Our own Richard Lawson, a Boston native, describes what the scene of the end of the marathon is like on a typical year: Marathon Monday is one of Boston's most celebratory days, with schools and offices closed and people lining the streets cheering runners on for essentially all 26. 2 miles of a course which works its way further and further into town. By the time the Boston Marathon reaches the final stretch down narrow Boylston Street, it has entered the busy commercial district of Copley Square. The historic Boston Public Library is on the runners'right, ahead of them the open area of Copley Square Park and the famous Trinity Church. And of course the culmination of all that is the final downtown stretch, as spirited and jovial a scene as there is in Boston at any time throughout the year. The crowd on marathon day is dense and varied — locals and tourists and running enthusiasts from all over show up hours ahead to secure a good view of the finish line. And of course, there are the runners themselves, still streaming across the finish line for hours after the big winners are crowned. — Richard Lawson As the day wound down and everyone struggled to process what had happened, Astronaut Chris Hadfield sent a sympathetic dispatch from the International Space Station."A somber Spring night in Boston,"he said, including this aerial photo of the city: Closer to home, some folks at MIT paid tribute to the patriotic spirit with an entire building: Stay tuned for the Wire's Day Two live blog and more at our Boston Marathon hub. Want to add to this story? Let us know in comments or send an email to the authors at, aabadsantos at theatlantic dot com or matt dot sullivan at theatlantic dot com. You can share ideas for stories on the Open Wire. Adam Clark Estes Alexander Abad-Santos Matt Sullivan
    </div>

    <div id='events-data' hidden>
      [{"event_id": "backpack_ied_19-E1", "text": "bombed", "offset": 57, "length": 1, "template": "[Attacker] detonated or exploded [ExplosiveDevice] explosive device using [Instrument] to attack [Target] target at [Place] place", "role_text_map": [{"role": "Attacker", "tokens": []}, {"role": "Target", "tokens": [{"text": "Boston Marathon", "entity_id": "backpack_ied_19-T12", "offset": 54, "length": 2}]}, {"role": "Instrument", "tokens": []}, {"role": "ExplosiveDevice", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "backpack_ied_19-E2", "text": "injured", "offset": 84, "length": 1, "template": "[Victim] was injured by [Injurer] using [Instrument] in [BodyPart] body part with [MedicalCondition] medical issue at [Place] place", "role_text_map": [{"role": "Victim", "tokens": [{"text": "people", "entity_id": "backpack_ied_19-T13", "offset": 82, "length": 1}]}, {"role": "Injurer", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "BodyPart", "tokens": []}, {"role": "MedicalCondition", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "backpack_ied_19-E3", "text": "investigation", "offset": 168, "length": 1, "template": "[Investigator] investigated [Defendant] for [Crime] crime in [Place] place", "role_text_map": [{"role": "Investigator", "tokens": [{"text": "FBI", "entity_id": "backpack_ied_19-T25", "offset": 160, "length": 1}, {"text": "Richard DesLauriers", "entity_id": "backpack_ied_19-T29", "offset": 176, "length": 2}]}, {"role": "Defendant", "tokens": [{"text": "terrorist", "entity_id": "backpack_ied_19-T26", "offset": 167, "length": 1}]}, {"role": "Crime", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "backpack_ied_19-E8", "text": "said", "offset": 178, "length": 1, "template": "[Communicator] communicated to [Recipient] about [Topic] topic using [Instrument] at [Place] place (one-way communication)", "role_text_map": [{"role": "Communicator", "tokens": [{"text": "Richard DesLauriers", "entity_id": "backpack_ied_19-T29", "offset": 176, "length": 2}]}, {"role": "Recipient", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "Topic", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "backpack_ied_19-E9", "text": "confirmed", "offset": 326, "length": 1, "template": "[Communicator] communicated to [Recipient] about [Topic] topic using [Instrument] at [Place] place (one-way communication)", "role_text_map": [{"role": "Communicator", "tokens": [{"text": "Davis", "entity_id": "backpack_ied_19-T50", "offset": 325, "length": 1}]}, {"role": "Recipient", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "Topic", "tokens": []}, {"role": "Place", "tokens": [{"text": "event", "entity_id": "backpack_ied_19-T462", "offset": 330, "length": 1}]}]}, {"event_id": "backpack_ied_19-E10", "text": "died", "offset": 338, "length": 1, "template": "[Victim] died at [Place] place from [MedicalIssue] medical issue, killed by [Killer] killer", "role_text_map": [{"role": "Victim", "tokens": [{"text": "people", "entity_id": "backpack_ied_19-T51", "offset": 336, "length": 1}]}, {"role": "Place", "tokens": []}, {"role": "Killer", "tokens": []}, {"role": "MedicalIssue", "tokens": []}]}, {"event_id": "backpack_ied_19-E11", "text": "said", "offset": 348, "length": 1, "template": "[Communicator] communicated to [Recipient] about [Topic] topic using [Instrument] at [Place] place (one-way communication)", "role_text_map": [{"role": "Communicator", "tokens": [{"text": "Deval Patrick", "entity_id": "backpack_ied_19-T53", "offset": 346, "length": 2}]}, {"role": "Recipient", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "Topic", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "backpack_ied_19-E12", "text": "reported", "offset": 420, "length": 1, "template": "[Communicator] communicated to [Recipient] about [Topic] topic using [Instrument] at [Place] place (one-way communication)", "role_text_map": [{"role": "Communicator", "tokens": [{"text": "Davis", "entity_id": "backpack_ied_19-T62", "offset": 418, "length": 1}]}, {"role": "Recipient", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "Topic", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "backpack_ied_19-E4", "text": "explosion", "offset": 423, "length": 1, "template": "[Attacker] detonated or exploded [ExplosiveDevice] explosive device using [Instrument] to attack [Target] target at [Place] place", "role_text_map": [{"role": "Attacker", "tokens": []}, {"role": "Target", "tokens": [{"text": "JFK Library", "entity_id": "backpack_ied_19-T63", "offset": 425, "length": 2}]}, {"role": "Instrument", "tokens": []}, {"role": "ExplosiveDevice", "tokens": []}, {"role": "Place", "tokens": [{"text": "Boston", "entity_id": "backpack_ied_19-T64", "offset": 428, "length": 1}]}]}, {"event_id": "backpack_ied_19-E13", "text": "said", "offset": 451, "length": 1, "template": "[Communicator] communicated to [Recipient] about [Topic] topic using [Instrument] at [Place] place (one-way communication)", "role_text_map": [{"role": "Communicator", "tokens": [{"text": "Davis", "entity_id": "backpack_ied_19-T67", "offset": 450, "length": 1}]}, {"role": "Recipient", "tokens": [{"text": "CNN", "entity_id": "backpack_ied_19-T70", "offset": 462, "length": 1}]}, {"role": "Instrument", "tokens": []}, {"role": "Topic", "tokens": [{"text": "suspect", "entity_id": "backpack_ied_19-T69", "offset": 456, "length": 1}]}, {"role": "Place", "tokens": []}]}, {"event_id": "backpack_ied_19-E14", "text": "reported", "offset": 463, "length": 1, "template": "[Communicator] communicated to [Recipient] about [Topic] topic using [Instrument] at [Place] place (one-way communication)", "role_text_map": [{"role": "Communicator", "tokens": [{"text": "CNN", "entity_id": "backpack_ied_19-T70", "offset": 462, "length": 1}]}, {"role": "Recipient", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "Topic", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "backpack_ied_19-E5", "text": "investigation", "offset": 535, "length": 1, "template": "[Investigator] investigated [Defendant] for [Crime] crime in [Place] place", "role_text_map": [{"role": "Investigator", "tokens": [{"text": "investigators", "entity_id": "backpack_ied_19-T79", "offset": 530, "length": 1}]}, {"role": "Defendant", "tokens": []}, {"role": "Crime", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "backpack_ied_19-E15", "text": "reported", "offset": 650, "length": 1, "template": "[Communicator] communicated to [Recipient] about [Topic] topic using [Instrument] at [Place] place (one-way communication)", "role_text_map": [{"role": "Communicator", "tokens": [{"text": "NBC News", "entity_id": "backpack_ied_19-T91", "offset": 646, "length": 2}, {"text": "others", "entity_id": "backpack_ied_19-T92", "offset": 649, "length": 1}]}, {"role": "Recipient", "tokens": [{"text": "White House", "entity_id": "backpack_ied_19-T93", "offset": 653, "length": 2}]}, {"role": "Instrument", "tokens": []}, {"role": "Topic", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "backpack_ied_19-E6", "text": "meet", "offset": 677, "length": 1, "template": "[Participant] met face-to-face with [Participant] about [Topic] topic at [Place] place", "role_text_map": [{"role": "Participant", "tokens": [{"text": "Joe Biden", "entity_id": "backpack_ied_19-T95", "offset": 674, "length": 2}, {"text": "Obama", "entity_id": "backpack_ied_19-T94", "offset": 670, "length": 1}, {"text": "Chuck Hagel", "entity_id": "backpack_ied_19-T98", "offset": 682, "length": 2}]}, {"role": "Participant", "tokens": [{"text": "Joe Biden", "entity_id": "backpack_ied_19-T95", "offset": 674, "length": 2}, {"text": "Obama", "entity_id": "backpack_ied_19-T94", "offset": 670, "length": 1}, {"text": "Chuck Hagel", "entity_id": "backpack_ied_19-T98", "offset": 682, "length": 2}]}, {"role": "Topic", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "backpack_ied_19-E7", "text": "dead", "offset": 774, "length": 1, "template": "[Victim] died at [Place] place from [MedicalIssue] medical issue, killed by [Killer] killer", "role_text_map": [{"role": "Victim", "tokens": [{"text": "three", "entity_id": "backpack_ied_19-T110", "offset": 773, "length": 1}, {"text": "child", "entity_id": "backpack_ied_19-T114", "offset": 792, "length": 1}]}, {"role": "Place", "tokens": []}, {"role": "Killer", "tokens": []}, {"role": "MedicalIssue", "tokens": []}]}, {"event_id": "backpack_ied_19-E16", "text": "reporting", "offset": 1316, "length": 1, "template": "[Communicator] communicated to [Recipient] about [Topic] topic using [Instrument] at [Place] place (one-way communication)", "role_text_map": [{"role": "Communicator", "tokens": [{"text": "CBS News", "entity_id": "backpack_ied_19-T192", "offset": 1313, "length": 2}]}, {"role": "Recipient", "tokens": [{"text": "Boston PD", "entity_id": "backpack_ied_19-T193", "offset": 1318, "length": 2}]}, {"role": "Instrument", "tokens": []}, {"role": "Topic", "tokens": [{"text": "video", "entity_id": "backpack_ied_19-T474", "offset": 1321, "length": 1}]}, {"role": "Place", "tokens": []}]}]
    </div>

    <div id='relations-data' hidden>
      []
    </div>

    <div id="strategyB-tuples" hidden>
      ${strategyB-tuples}
    </div>

    <p>
      You can navigate all of the events by clicking the following buttons. <br>
      You have to finish all the events before submitting. (Remember that you can't refresh the page otherwise
      the progress will be gone, <br>
      to prevent this from happening, we suggest that you write the QA pairs in the google doc and copy paste them
      here)
    </p>
    <!-- Tabs for each trigger -->
    <div class="btn-toolbar" id="button-bar">
    </div>

    <div class="strategies">
      <span id="strategy-btns">
        <button id="selectA" class="btn btn-default" type="button">
          Strategy A</button>
        <button id="selectB" class="btn btn-default" type="button">
          Strategy B</button>
      </span>
      <select id="tuple-select">
      </select>
      <div class="ann-component">
        <em>
          KAIROS event arguments for triggers
        </em>
        <div id='template-area' class='ann well well-sm'>
        </div>
      </div>
      <div class="strategy" id="strategyA">
        <div class="ann-component">
          <em>
            These are relations between events.
          </em>
          <div id='relations-area' class='ann well well-sm'>
          </div>
        </div>
      </div>
      <div class="strategy" id="strategyB">
      </div>
    </div>
    <div id="input-area">
    </div>
    <div title="Fill all fields before submitting">
      <button id="save" class="btn btn-default" type="button">Save</button>
      <button id="submitButton" class="btn btn-default" type="button">Submit</button>
    </div>
  </section>


  <link crossorigin="anonymous" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
    integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" rel="stylesheet" />
  <style>.mg-15 {
    margin-left: 15px;
    margin-right: 15px;
}

.mg-5 {
    margin: 5px;
}

.container-fluid {
    max-width: 1800px;
    margin: 30px;
}

.btn-container {
    display: inline-block;
    margin: 10px;
}

.strategies {
    margin: 15px;
}

.ann-component {
    margin: 5px;
}


#collapseTrigger {
    color: #fff;
    display: block;
    text-decoration: none;
}

#submitButton {
    white-space: normal;
}

#input-area {
    display: block;
    margin: 10px;
}

.input-fields {
    margin: 10px;
    padding: 10px;
    background-color: #ffe3e3;
    border-radius: 15px;
}

#template-area {
    background-color: #eee;
    display: flex;
}

#relations-area {
    display: flex;
    flex-direction: column;
    row-gap: 5px;
}

.template-map {
    border: 1px solid gray;
    padding: 5px;
}

.btn-container>button {
    min-width: 3em;
}

trigger {
    display: inline;
}

role {
    display: inline;
}

.highlight-trigger {
    background-color: lightgoldenrodyellow;
}

.highlight-role {
    background-color: lightblue;
}

.highlight-role1 {
    background-color: rgba(255, 255, 0, 0.5);
}

.highlight-role2 {
    background-color: rgba(0, 255, 255, 0.5);
}

.highlight-role3 {
    background-color: rgba(255, 0, 255, 0.5);
}

.btn-group {
    vertical-align: middle;
}

.content {
    margin-bottom: 15px;
}

.ann {
    font-size: 16px;
}

.disp {
    font-size: 20px;
}

.ann>span.token {
    cursor: pointer;
}

.ann>span.token:hover {
    text-decoration: underline;
}

.ann>strong.annotation:hover {
    text-decoration: line-through;
}

input[disabled] {
    color: #000
}

.question-input, .answer-input {
    vertical-align: middle;
}</style>
  <script src="https://code.jquery.com/jquery-3.1.0.min.js"
    integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
    integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>
  <script>// ---------------------------------------------------------
// Global
// ---------------------------------------------------------

var page_num_set = new Set();
let strategy = '';
let developer_mode = false;

// ---------------------------------------------------------
// Create jQuery elements
// ---------------------------------------------------------

var submit = $('#submitButton');

// list of text/offset objects 
const events_data = JSON.parse($('#events-data').text().trim());
const relations_data = JSON.parse($('#relations-data').text().trim());
const strategyB_tuples = [["road_ied_8-E1", "road_ied_8-E2", "road_ied_8-E3"]];//JSON.parse($('#strategyB-tuples').text().trim());

const empty_template_map = function () {
    return $('<div class="template-map">');
}

const save_record = {
    A: {
        relations: relations_data,
        qapairs: [],
    },
    B: {
        qapairs: [],
    },
};

const strategyA_template = function (tno, event1, event2) {
    return {
        question: '',
        answer: '',
    }
}

const template_record = [];
events_data.forEach(function (ei, i) {
    template_record[i] = empty_template_map();
    events_data.forEach(function (ej, j) {
        if (i >= j) return;

        for (let tno = 1; tno <= 4; tno++){
            {
                const { question, answer } = strategyA_template(tno, ei, ej);
                save_record.A.qapairs.push({
                    event1_id: ei.event_id,
                    event2_id: ej.event_id,
                    templateno: tno,
                    question,
                    answer,
                });
            }
            {
                const { question, answer } = strategyA_template(tno, ej, ei);
                save_record.A.qapairs.push({
                    event1_id: ej.event_id,
                    event2_id: ei.event_id,
                    templateno: tno,
                    question,
                    answer,
                });
            }
        }
    });
});

function strategyB_template(event1_id, event2_id, event3_id) {
    const question = 'What is the participant in the event that interviews the transporter that flew the place that gone off the explosive device. ';
    const answer = '';
    return {
        question, answer
    };
}

strategyB_tuples.forEach(function (tuple, i) {
    const { question, answer } = strategyB_template(tuple[0], tuple[1], tuple[2]);
    save_record.B.qapairs.push({
        event1_id: tuple[0],
        event2_id: tuple[1],
        event3_id: tuple[2],
        question,
        answer,
    });
});

// implementation of string formatting
if (!String.prototype.format) {
    String.prototype.format = function () {
        var args = arguments;
        return this.replace(/{(\d+)}/g, function (match, number) {
            return typeof args[number] != 'undefined'
                ? args[number]
                : match
                ;
        });
    };
}

// ---------------------------------------------------------
// Create elements
// ---------------------------------------------------------

var makeDom = function () {
    recoverUserInput();
    console.log(page_num_set);
    highlightEvent();
};

var highlightEvent = function () {
    /* highlight trigger within document */
    const pagenos = Array.from(page_num_set);
    pagenos.sort((a, b) => events_data[a].offset - events_data[b].offset);

    // remove previous highlights
    $('trigger').removeClass('highlight-trigger');
    $('role').removeClass('highlight-role1 highlight-role2 highlight-role3');

    pagenos.forEach(trigger_num => {
        // highlight trigger
        $('#trigger-' + trigger_num).addClass('highlight-trigger');
        $('role[trigno=' + trigger_num + ']').addClass('highlight-role'+(trigger_num+1));
    })
}

const relationTypes = [
    "BEFORE",
    "AFTER",
    "OVERLAPS",
    "EQUAL",
    "CONTAINS",
    "CONTAINED BY",
    "CAUSES",
    "CAUSED BY",
]

// restore input from other trigger
var recoverUserInput = function () {
    const inputArea = $('#input-area');
    inputArea.empty();
    page_num_set.clear();

    let pagenos = [];
    if (strategy === 'A') {
        // questions
        const event_pair = $('#tuple-select').val().split(',').map(x => parseInt(x));
        page_num_set.add(event_pair[0]);
        page_num_set.add(event_pair[1]);

        pagenos = event_pair;
        pagenos.sort((a, b) => events_data[a].offset - events_data[b].offset);

        // relations
        const relationsArea = $('#relations-area');
        relationsArea.empty();
        pagenos.forEach(i => {
            pagenos.forEach(j => {
                if (i >= j) return;

                const event1 = events_data[i];
                const event2 = events_data[j];
                relationsArea.append(makeRelationSelect(event1, event2));
                relationsArea.append(makeRelationSelect(event2, event1));
            })
        })

        const matching_pairs = save_record.A.qapairs.filter(qa => {
            return (
                (qa.event1_id === events_data[event_pair[0]].event_id &&
                qa.event2_id === events_data[event_pair[1]].event_id) ||
                (qa.event1_id === events_data[event_pair[1]].event_id &&
                qa.event2_id === events_data[event_pair[0]].event_id)
            );
        });
        matching_pairs.forEach((qa, i) => {
            add_qa_input(qa.question, qa.answer, qa);
            if (i % 2 === 1 && i < matching_pairs.length - 1)
                inputArea.add($('<hr>'));
        });
    } else if (strategy === 'B') {
        const tuple = save_record.B.qapairs[$('#tuple-select').val()];
        console.log("TUPLE", tuple)
        page_num_set.add(events_data.findIndex(e => e.event_id === tuple.event1_id));
        page_num_set.add(events_data.findIndex(e => e.event_id === tuple.event2_id));
        page_num_set.add(events_data.findIndex(e => e.event_id === tuple.event3_id));
        pagenos = Array.from(page_num_set);
        pagenos.sort((a, b) => events_data[a].offset - events_data[b].offset);
        add_qa_input(tuple.question, tuple.answer, null, false);
        add_qa_input('', '', tuple, true);
    }
    // templates
    const templateArea = $('#template-area');
    templateArea.empty()
    pagenos.forEach(trigger_num => {
        const div = $('<div>')
            .append($('<p>').text(describeEvent(events_data[trigger_num])))
            .append(template_record[trigger_num]);
        templateArea.append(div);
    });
};

function describeEvent(event) {
    return (developer_mode ? `ID: ${event.event_id} | ` : "") + `${event.text} @ ${event.offset}`;
}

function makeRelationSelect(event1, event2) {
    const id1 = event1.event_id;
    const id2 = event2.event_id;
    const relation = relations_data.find(r =>
        r.event1_id == id1 &&
        r.event2_id == id2
    );

    const selectInput =
        $('<select class="relation-select mg-5">');
    relationTypes.forEach(type => {
        const option = $(`<option value="${type}">${type.toLowerCase()}</option>`);
        selectInput.append(option);
    });
    selectInput.append($('<option value="NONE">none</option>'));
    selectInput.val(relation?.type ?? "NONE");
    selectInput.on('change', function () {
        const type = $(this).val();
        const event1_id = id1;
        const event2_id = id2;
        const relation = relations_data.find(r =>
            r.event1_id == event1_id &&
            r.event2_id == event2_id
        );
        if (relation) {
            relation.type = type;
        } else {
            relations_data.push({
                event1_id,
                event2_id,
                type,
            });
        }
    });

    const div = $('<div>')
        .append($('<label>').text(describeEvent(event1)))
        .append(selectInput)
        .append($('<label>').text(describeEvent(event2)))

    return div;
}

// ensure something is in the input box
var canSubmit = function () {
    return true;
};

// template role fields
const make_role_mapping_element = function (role, text) {
    const role_text = $('<label>').html('<b>' + role + '</b>:');
    const role_field = $('<span>')
        .addClass('role-field')
        .attr({
            role: role,
            rows: 1,
        })
        .text(text)

    const role_div = $('<div>')
        .addClass('role-container')
        .append(role_text)
        .append(role_field);

    return role_div;
}


const add_qa_input = function (question = '', answer = '', ref = null, editable = true) {
    let question_text = $('<label>').text('question:');
    let question_input = $('<textarea>')
        .addClass('question-input')
        .addClass('mg-15')
        .attr({
            placeholder: 'write down your question',
            rows: 2,
            cols: 80,
        })
        .text(question);
    question_input.on("input", function () {
        console.log('q', ref)
        if (ref != null)
            ref.question = $(this).val();
        show();
    });
    let answer_text = $('<label>').text('answer:');
    let answer_input = $('<textarea>')
        .addClass('answer-input')
        .addClass('mg-15')
        .attr({
            placeholder: 'write down your answer',
            rows: 2,
            cols: 80,
        })
        .text(answer);
    answer_input.on("input", function () {
        console.log('a', ref)
        if (ref != null)
            ref.answer = $(this).val();
        show();
    });

    if (!editable) {
        question_input.attr('disabled', 'disabled');
        answer_input.attr('disabled', 'disabled');
    }

    const input_fields = $('<div>')
        .addClass('input-fields')
        .append(question_text)
        .append(question_input)
        .append(answer_text)
        .append(answer_input)

    $('#input-area').append(input_fields);

    show();
};

var enable_button = function (button) {
    button.removeAttr("disabled");
    button.removeClass("btn-default");
    button.addClass("btn-success");
};

var disable_button = function (button) {
    button.attr("disabled", "disabled");
    button.removeClass("btn-success");
    button.addClass("btn-default");
};

var select_button = function (button) {
    button.removeClass("btn-default");
    button.addClass("btn-primary");
};

var deselect_button = function (button) {
    button.removeClass("btn-primary");
    button.addClass("btn-default");
};

var is_wh_question = function (question) {
    let tokens = question.split(' ');
    if (tokens.length <= 1) {
        return false;
    }

    // let wh_pattern = /^Wh\|wh\|How\|how/;
    let wh_pattern = /^wh|Wh|how|How/;
    // console.log(question.match(wh_pattern));
    return !!question.match(wh_pattern);
};


var show = function () {
    for (button of document.getElementById('button-bar').getElementsByTagName('*')) {
        if (page_num_set.has(parseInt(button.getAttribute('page-no'))))
            select_button($(button));
        else
            deselect_button($(button));
    }

};

// dynamically create buttons for each SRL arg
events_data.forEach(function (event, i) {
    if (event.text.trim()) {
        var button = document.createElement("button");
        button.setAttribute("type", "button");
        button.setAttribute("id", "button-page-" + i);
        button.setAttribute("page-no", i);
        button.setAttribute("class", "btn btn-default");
        button.innerHTML = describeEvent(event);
        button.onclick = function () {
            // const pageno = parseInt(this.getAttribute("page-no"));
            // // toggle button
            // if (button.classList.contains('btn-default'))
            //     page_num_set.add(pageno);
            // else
            //     page_num_set.delete(pageno);
            // makeDom();
            // let instruction = $('#instructionBody');
            // if (instruction.is(':visible')) {
            //     instruction.toggle();
            // }
            // //window.scrollTo(0, 0); // scroll to top
            // show();
        }
        document.getElementById('button-bar').appendChild(button);
    }

    // format template area with role mappings
    // if template not null or undefined
    if (event.template !== null) {
        const template_area = template_record[i];
        const template = $('<p>').text(event.template);
        template_area.append(template);
        event.role_text_map.forEach(function (pairing) {
            template_area.append(make_role_mapping_element(pairing.role, pairing.tokens.map(tk => tk.text).join('/')));
        });
    }
})

// ---------------------------------------------------------
// Initialize
// ---------------------------------------------------------

var submit_form = function (event) {
    event.preventDefault();
    if (!window.confirm("Are you sure you want to submit?")) return;
    save_all();

    const urlParams = new URLSearchParams(window.location.search)

    // create the form element and point it to the correct endpoint
    const form = document.createElement('form')
    form.action = (new URL('mturk/externalSubmit', urlParams.get('turkSubmitTo'))).href
    form.method = 'post'

    // attach the assignmentId
    const inputAssignmentId = document.createElement('input')
    inputAssignmentId.name = 'assignmentId'
    inputAssignmentId.value = urlParams.get('assignmentId')
    inputAssignmentId.hidden = true
    form.appendChild(inputAssignmentId)

    // attach data I want to send back
    const inputResults = document.createElement('input')
    inputResults.name = 'results'
    inputResults.value = JSON.stringify(save_record)
    inputResults.hidden = true
    form.appendChild(inputResults)

    // attach the form to the HTML document and trigger submission
    document.body.appendChild(form)
    form.submit()
}

//$('#save').on('click', save_all);
submit.on('click', submit_form);

var popup_alert = function (alert_box, text) {
    alert_box.html(text);
    alert_box.css({
        'background-color': 'fec5bb',
        'padding': '5px',
        'border': '1px solid lightgray',
        'border-radius': '10px',
        'margin-top': '10px',
        'margin-bottom': '10px'
    });
    displaying = true;
    setTimeout(function () {
        alert_box.html('');
        alert_box.css({
            'padding': '0px',
            'border': '0px'
        });
        displaying = false;
    }, 7000);
};

const selectA = $('#selectA');
const selectB = $('#selectB');

const tupleSelect = $('#tuple-select');


function makeSelectionOptions() {
    if (strategy === 'A') {
        tupleSelect.empty();
        events_data.forEach(function (ei, i) {
            events_data.forEach(function (ej, j) {
                if (i >= j) return;
                const opt = $('<option>')
                    .attr({
                        value: `${i},${j}`,
                    })
                    .text(`${describeEvent(ei)} & ${describeEvent(ej)}`);
                tupleSelect.append(opt);
            });
        });
        tupleSelect.children()[0].selected = true;
    } else {
        tupleSelect.empty();
        function describeEventById(id) {
            const event = events_data.find(e => e.event_id === id);
            return describeEvent(event);
        }
        strategyB_tuples.forEach(function (tuple, i) {
            const opt = $('<option>')
                .attr({
                    value: i,
                })
                .text(`${describeEventById(tuple[0])}, ${describeEventById(tuple[1])}, ${describeEventById(tuple[2])}`);
            tupleSelect.append(opt);
        });
        tupleSelect.children()[0].selected = true;
    }
}

selectA.on('click', function () {
    if (strategy === 'A') return;
    strategy = 'A';
    $('#strategyA').show();
    select_button(selectA);
    $('#strategyB').hide();
    deselect_button(selectB);
    makeSelectionOptions();
    makeDom();
    show();
});

selectB.on('click', function () {
    if (strategy === 'B') return;
    strategy = 'B';
    $('#strategyA').hide();
    deselect_button(selectA);
    $('#strategyB').show();
    select_button(selectB);
    makeSelectionOptions();
    makeDom();
    show();
});

selectA.click();

tupleSelect.on('change', function () {
    makeDom();
    show();
});

$('#developer-mode').on('change', function () {
    developer_mode = this.checked;
    makeSelectionOptions();
    makeDom();
    show();
});

// Instructions expand/collapse
var content = $('#instructionBody');
var instructions_trigger = $('#collapseTrigger');
// content.hide();
$('.collapse-text').text('(Click to collapse)');
instructions_trigger.click(function () {
    content.toggle();
    var isVisible = content.is(':visible');
    if (isVisible) {
        $('.collapse-text').text('(Click to collapse)');
    } else {
        $('.collapse-text').text('(Click to expand)');
    }
});

console.log(save_record)
show();
</script>
</crowd-form>