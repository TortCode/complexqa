<crowd-form answer-format="flatten-objects">
  <section class="container-fluid" id="Relevancy">
    <div class="row">
      <div class="col-xs-12 col-md-12">
        <div class="panel panel-primary">
          <a class="panel-heading" href="javascript:void(0);" id="collapseTrigger">
            <strong>Annotation Instructions</strong>
            <span class="collapse-text">(Click to expand)</span>
          </a>
          <div class="panel-body" id="instructionBody">
            {{INSTRUCTIONS}}
            {{LINK}}
          </div>
        </div>
      </div>
    </div>

    Enable developer mode:
    <input type="checkbox" id="developer-mode">

    <h3>Document</h3>
    <div id="document-text" class="ann well well-sm">
      Wealth of Clues Led to Quick <trigger id='trigger-0'>Arrest</trigger> of New York Suspected <role id='role-0-Detainee-0'trigno='0'>Bomber</role> NEW YORK — The man suspected of <trigger id='trigger-1'>planting</trigger> <role id='role-1-Artifact-0'trigno='1'>bombs</role> in a New York <role id='role-1-Place-0'trigno='1'>neighborhood</role> and a New Jersey seaside <role id='role-1-Place-1'trigno='1'>town</role> may have aimed to inflict carnage incognito, but he didn't succeed for long in concealing his identity. Ahmad Khan Rahami provided investigators with a wealth of clues that led to <role id='role-2-Detainee-0'trigno='2'>his</role> <trigger id='trigger-2'>arrest</trigger> about 50 hours after the first explosion, according to three law enforcement <role id='role-3-Investigator-0'trigno='3'>officials</role> familiar with the <trigger id='trigger-3'>investigation</trigger>. His fingerprints and DNA were found at the scene of the <role id='role-4-Place-0'trigno='4'>Manhattan</role> <trigger id='trigger-4'>bombing</trigger>, they said. His uncovered face was clearly captured by surveillance cameras near the spot of the blast. Electronic toll records show a <role id='role-5-Vehicle-0'trigno='5'>car</role> to which he had access was <trigger id='trigger-5'>driven</trigger> from <role id='role-5-Origin-0'trigno='5'>New Jersey</role> to <role id='role-5-Destination-0'trigno='5'>Manhattan</role> and back to <role id='role-5-Destination-1'trigno='5'>New Jersey</role> the day of the bombing, according to the officials, who spoke to The Associated Press on condition of anonymity because they weren't authorized to discuss an ongoing case. Those and other clues spurred officials to publicize his name and photo Monday morning, asking for help finding Rahami, 28, a Muslim U. S. citizen born in Afghanistan, who lives with his family in Elizabeth, New Jersey. As the investigation heated up, a bar owner in Linden, New Jersey, reported someone asleep in his doorway. An <role id='role-6-Investigator-0'trigno='6'>officer</role> went to <trigger id='trigger-6'>investigate</trigger> and recognized the <role id='role-6-Defendant-0'trigno='6'>man</role> as <role id='role-6-Defendant-1'trigno='6'>Rahami</role>, police and the mayor said. <role id='role-7-Attacker-0'trigno='7'>Rahami</role> pulled a <role id='role-7-Instrument-0'trigno='7'>gun</role> and <trigger id='trigger-7'>shot</trigger> the <role id='role-7-Target-0'trigno='7'>officer</role> — who was wearing a bulletproof vest — in the torso, and more <role id='role-8-Jailer-0'trigno='8'>officers</role> joined in a running gun battle along the street and <trigger id='trigger-8'>brought</trigger> <role id='role-8-Detainee-0'trigno='8'>Rahami</role> down, police Capt. James Sarnicki said. Another police <role id='role-9-Victim-0'trigno='9'>officer</role> was <trigger id='trigger-9'>grazed</trigger> by a <role id='role-9-Instrument-0'trigno='9'>bullet</role>."A lot of technology involved in this, but a lot of good, old-fashioned police work, too,"said New York Police Commissioner James O'Neill. He said now, investigators would"make sure that we get to the bottom of who's involved and why."After <trigger id='trigger-10'>surgery</trigger> for a gunshot <trigger id='trigger-11'>wound</trigger> to his leg, <role id='role-12-Defendant-0'trigno='12'><role id='role-11-Victim-0'trigno='11'>Rahami</role></role> was being held on $5. 2 million bail, <trigger id='trigger-12'>charged</trigger> with five counts of attempted murder of police officers. Federal prosecutors said they still were weighing charges over the bombings. Rahami remains hospitalized. Messages left for family members were not immediately returned. It wasn't clear when Rahami would get an attorney. Officials said they have no other suspects at large, but cautioned they are still <trigger id='trigger-13'>investigating</trigger>. The bombing spread fear across the New York area and revived anxiety about homegrown terrorism nationwide. As the East Coast was rattled by the bombings, a man who authorities say referred to <role id='role-15-Target-0'trigno='15'><role id='role-14-Injurer-0'trigno='14'>Allah</role></role> <trigger id='trigger-14'>wounded</trigger> nine <role id='role-14-Victim-0'trigno='14'>people</role> in a stabbing rampage at a Minnesota mall Saturday before being <trigger id='trigger-15'>shot</trigger> to death by an off-duty police <role id='role-15-Attacker-0'trigno='15'>officer</role>. <role id='role-16-Investigator-0'trigno='16'>Authorities</role> are <trigger id='trigger-16'>investigating</trigger> the stabbings as a possible terrorist attack but have not drawn any connection between the bloodshed there and the bombings. William Sweeney Jr. , the FBI's assistant director in New York, said there was no indication so far that the bombings were the work of a larger terror cell. Rahami wasn't on any terror or no-fly watch lists, though he had been interviewed for immigration purposes <trigger id='trigger-17'>traveling</trigger> between the <role id='role-17-Destination-0'trigno='17'>U. S. </role> and <role id='role-17-Origin-0'trigno='17'>Afghanistan</role>, one of the law enforcement officials said. Rahami and his family live above their restaurant — called First American Fried Chicken — and the family has clashed with the city over closing times and noise complaints, which the Rahamis said in a lawsuit were tinged with anti-Muslim sentiment. The lawsuit was terminated in 2012 because <role id='role-18-Defendant-0'trigno='18'>one</role> of Rahami's brothers had <trigger id='trigger-18'>pleaded</trigger> guilty to blocking police from enforcing closing hours at the restaurant. A childhood friend, Flee Jones, said Rahami had become more religious after <trigger id='trigger-19'>returning</trigger> from a trip to <role id='role-19-Destination-0'trigno='19'>Afghanistan</role> several years ago. Still, some of the family restaurant's customers said Rahami was more likely to talk about his interest in cars than to mention faith."He's a very friendly guy,"patron Ryan McCann said."That's what's so scary."The <trigger id='trigger-20'>investigation</trigger> began when a pipe <role id='role-21-ExplosiveDevice-0'trigno='21'>bomb</role> <trigger id='trigger-21'>blew</trigger> up Saturday morning in <role id='role-21-Place-0'trigno='21'>Seaside Park</role>, <role id='role-21-Place-1'trigno='21'>New Jersey</role>, before a charity race to benefit Marines. No one was injured. Then a shrapnel-packed pressure-cooker <role id='role-22-ExplosiveDevice-0'trigno='22'>bomb</role> <trigger id='trigger-22'>exploded</trigger> Saturday night in New York's Chelsea section, <trigger id='trigger-23'>wounding</trigger> 29 <role id='role-23-Victim-0'trigno='23'>people</role>, none seriously. An unexploded pressure-cooker bomb was found blocks away. Late Sunday night, five explosive devices were discovered in a trash can at an Elizabeth train station, about 3 miles from where Rahami was later found asleep in the doorway of a bar. Investigators are still gathering evidence and have not publicly tied Rahami to those devices, though Sweeney noted they aren't"ruling anything out."The bombs discovered Saturday all used flip cellphones as a trigger and were all made with easily purchasable materials, a federal law enforcement official speaking on condition of anonymity said. After zeroing in on Rahami and learning of the car that had <trigger id='trigger-24'>traveled</trigger> between <role id='role-24-Origin-0'trigno='24'>New Jersey</role> and <role id='role-24-Destination-0'trigno='24'>New York</role>, authorities pulled it over Sunday night after it headed in the direction of Kennedy airport. The law enforcement officials said at least one of Rahami's relatives was in the car. All <role id='role-25-Defendant-0'trigno='25'>five</role> were questioned and <trigger id='trigger-25'>released</trigger>, Sweeney said. He declined to say whether they might later face charges. Around the time <role id='role-26-Detainee-0'trigno='26'>Rahami</role> was <trigger id='trigger-26'>captured</trigger>, President Barack Obama was in New York on a previously scheduled visit for a meeting of the U. N. General Assembly. He called on Americans to show the world"we will never give in to fear."
    </div>

    <div id='events-data' hidden>
      [{"event_id": "6_VOA_EN_NW_2016.09.20.3516717-E1", "text": "Arrest", "offset": 6, "length": 1, "template": "[Jailer] arrested or jailed [Detainee] for [Crime] crime at [Place] place", "role_text_map": [{"role": "Jailer", "tokens": []}, {"role": "Detainee", "tokens": [{"text": "Bomber", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T161", "offset": 11, "length": 1}]}, {"role": "Crime", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "6_VOA_EN_NW_2016.09.20.3516717-E2", "text": "planting", "offset": 19, "length": 1, "template": "[ManufacturerAssembler] manufactured or assembled or produced [Artifact] from [Components] components using [Instrument] at [Place] place", "role_text_map": [{"role": "ManufacturerAssembler", "tokens": []}, {"role": "Artifact", "tokens": [{"text": "bombs", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T156", "offset": 20, "length": 1}]}, {"role": "Components", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "Place", "tokens": [{"text": "neighborhood", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T154", "offset": 25, "length": 1}, {"text": "town", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T59", "offset": 31, "length": 1}]}]}, {"event_id": "6_VOA_EN_NW_2016.09.20.3516717-E3", "text": "arrest", "offset": 67, "length": 1, "template": "[Jailer] arrested or jailed [Detainee] for [Crime] crime at [Place] place", "role_text_map": [{"role": "Jailer", "tokens": []}, {"role": "Detainee", "tokens": [{"text": "his", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T55", "offset": 66, "length": 1}]}, {"role": "Crime", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "6_VOA_EN_NW_2016.09.20.3516717-E4", "text": "investigation", "offset": 85, "length": 1, "template": "[Investigator] investigated [Defendant] for [Crime] crime in [Place] place", "role_text_map": [{"role": "Investigator", "tokens": [{"text": "officials", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T54", "offset": 81, "length": 1}]}, {"role": "Defendant", "tokens": []}, {"role": "Crime", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "6_VOA_EN_NW_2016.09.20.3516717-E5", "text": "bombing", "offset": 99, "length": 1, "template": "[Attacker] detonated or exploded [ExplosiveDevice] explosive device using [Instrument] to attack [Target] target at [Place] place", "role_text_map": [{"role": "Attacker", "tokens": []}, {"role": "Target", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "ExplosiveDevice", "tokens": []}, {"role": "Place", "tokens": [{"text": "Manhattan", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T60", "offset": 98, "length": 1}]}]}, {"event_id": "6_VOA_EN_NW_2016.09.20.3516717-E6", "text": "driven", "offset": 132, "length": 1, "template": "[Transporter] transported [PassengerArtifact] in [Vehicle] from [Origin] place to [Destination] place", "role_text_map": [{"role": "Transporter", "tokens": []}, {"role": "PassengerArtifact", "tokens": []}, {"role": "Vehicle", "tokens": [{"text": "car", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T90", "offset": 125, "length": 1}]}, {"role": "Origin", "tokens": [{"text": "New Jersey", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T93", "offset": 134, "length": 2}]}, {"role": "Destination", "tokens": [{"text": "Manhattan", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T141", "offset": 137, "length": 1}, {"text": "New Jersey", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T143", "offset": 141, "length": 2}]}]}, {"event_id": "6_VOA_EN_NW_2016.09.20.3516717-E7", "text": "investigate", "offset": 247, "length": 1, "template": "[Investigator] investigated [Defendant] for [Crime] crime in [Place] place", "role_text_map": [{"role": "Investigator", "tokens": [{"text": "officer", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T5", "offset": 244, "length": 1}]}, {"role": "Defendant", "tokens": [{"text": "man", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T4", "offset": 251, "length": 1}, {"text": "Rahami", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T3", "offset": 253, "length": 1}]}, {"role": "Crime", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "6_VOA_EN_NW_2016.09.20.3516717-E8", "text": "shot", "offset": 266, "length": 1, "template": "[Attacker] attacked [Target] using [Instrument] at [Place] place", "role_text_map": [{"role": "Attacker", "tokens": [{"text": "Rahami", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T8", "offset": 261, "length": 1}]}, {"role": "Target", "tokens": [{"text": "officer", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T2", "offset": 268, "length": 1}]}, {"role": "Instrument", "tokens": [{"text": "gun", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T7", "offset": 264, "length": 1}]}, {"role": "Place", "tokens": []}]}, {"event_id": "6_VOA_EN_NW_2016.09.20.3516717-E9", "text": "brought", "offset": 294, "length": 1, "template": "[Jailer] arrested or jailed [Detainee] for [Crime] crime at [Place] place", "role_text_map": [{"role": "Jailer", "tokens": [{"text": "officers", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T43", "offset": 283, "length": 1}]}, {"role": "Detainee", "tokens": [{"text": "Rahami", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T50", "offset": 295, "length": 1}]}, {"role": "Crime", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "6_VOA_EN_NW_2016.09.20.3516717-E10", "text": "grazed", "offset": 309, "length": 1, "template": "[Victim] was injured by [Injurer] using [Instrument] in [BodyPart] body part with [MedicalCondition] medical issue at [Place] place", "role_text_map": [{"role": "Victim", "tokens": [{"text": "officer", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T95", "offset": 307, "length": 1}]}, {"role": "Injurer", "tokens": []}, {"role": "Instrument", "tokens": [{"text": "bullet", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T51", "offset": 312, "length": 1}]}, {"role": "BodyPart", "tokens": []}, {"role": "MedicalCondition", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "6_VOA_EN_NW_2016.09.20.3516717-E12", "text": "surgery", "offset": 373, "length": 1, "template": "[Treater] treater treated [Patient] patient for [MedicalIssue] medical issue with [Instrument] means at [Place] place", "role_text_map": [{"role": "Treater", "tokens": []}, {"role": "Patient", "tokens": []}, {"role": "MedicalIssue", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "6_VOA_EN_NW_2016.09.20.3516717-E11", "text": "wound", "offset": 377, "length": 1, "template": "[Victim] was injured by [Injurer] using [Instrument] in [BodyPart] body part with [MedicalCondition] medical issue at [Place] place", "role_text_map": [{"role": "Victim", "tokens": [{"text": "Rahami", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T66", "offset": 382, "length": 1}]}, {"role": "Injurer", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "BodyPart", "tokens": []}, {"role": "MedicalCondition", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "6_VOA_EN_NW_2016.09.20.3516717-E13", "text": "charged", "offset": 394, "length": 1, "template": "[Prosecutor] charged or indicted [Defendant] before [JudgeCourt] court or judge for [Crime] crime in [Place] place", "role_text_map": [{"role": "Prosecutor", "tokens": []}, {"role": "Defendant", "tokens": [{"text": "Rahami", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T66", "offset": 382, "length": 1}]}, {"role": "JudgeCourt", "tokens": []}, {"role": "Crime", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "6_VOA_EN_NW_2016.09.20.3516717-E14", "text": "investigating", "offset": 458, "length": 1, "template": "[Investigator] investigated [Defendant] for [Crime] crime in [Place] place", "role_text_map": [{"role": "Investigator", "tokens": []}, {"role": "Defendant", "tokens": []}, {"role": "Crime", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "6_VOA_EN_NW_2016.09.20.3516717-E15", "text": "wounded", "offset": 495, "length": 1, "template": "[Victim] was injured by [Injurer] using [Instrument] in [BodyPart] body part with [MedicalCondition] medical issue at [Place] place", "role_text_map": [{"role": "Victim", "tokens": [{"text": "people", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T76", "offset": 497, "length": 1}]}, {"role": "Injurer", "tokens": [{"text": "Allah", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T190", "offset": 494, "length": 1}]}, {"role": "Instrument", "tokens": []}, {"role": "BodyPart", "tokens": []}, {"role": "MedicalCondition", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "6_VOA_EN_NW_2016.09.20.3516717-E16", "text": "shot", "offset": 509, "length": 1, "template": "[Attacker] attacked [Target] using [Instrument] at [Place] place", "role_text_map": [{"role": "Attacker", "tokens": [{"text": "officer", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T73", "offset": 518, "length": 1}]}, {"role": "Target", "tokens": [{"text": "Allah", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T190", "offset": 494, "length": 1}]}, {"role": "Instrument", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "6_VOA_EN_NW_2016.09.20.3516717-E17", "text": "investigating", "offset": 522, "length": 1, "template": "[Investigator] investigated [Defendant] for [Crime] crime in [Place] place", "role_text_map": [{"role": "Investigator", "tokens": [{"text": "Authorities", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T165", "offset": 520, "length": 1}]}, {"role": "Defendant", "tokens": []}, {"role": "Crime", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "6_VOA_EN_NW_2016.09.20.3516717-E18", "text": "traveling", "offset": 600, "length": 1, "template": "[Transporter] transported [PassengerArtifact] in [Vehicle] from [Origin] place to [Destination] place", "role_text_map": [{"role": "Transporter", "tokens": []}, {"role": "PassengerArtifact", "tokens": []}, {"role": "Vehicle", "tokens": []}, {"role": "Origin", "tokens": [{"text": "Afghanistan", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T145", "offset": 608, "length": 1}]}, {"role": "Destination", "tokens": [{"text": "U.S.", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T146", "offset": 603, "length": 4}]}]}, {"event_id": "6_VOA_EN_NW_2016.09.20.3516717-E19", "text": "pleaded", "offset": 677, "length": 1, "template": "[JudgeCourt] court or judge convicted [Defendant] of [Crime] crime in [Place] place", "role_text_map": [{"role": "JudgeCourt", "tokens": []}, {"role": "Defendant", "tokens": [{"text": "one", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T201", "offset": 670, "length": 1}]}, {"role": "Crime", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "6_VOA_EN_NW_2016.09.20.3516717-E20", "text": "returning", "offset": 704, "length": 1, "template": "[Transporter] transported [PassengerArtifact] in [Vehicle] from [Origin] place to [Destination] place", "role_text_map": [{"role": "Transporter", "tokens": []}, {"role": "PassengerArtifact", "tokens": []}, {"role": "Vehicle", "tokens": []}, {"role": "Origin", "tokens": []}, {"role": "Destination", "tokens": [{"text": "Afghanistan", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T182", "offset": 709, "length": 1}]}]}, {"event_id": "6_VOA_EN_NW_2016.09.20.3516717-E21", "text": "investigation", "offset": 768, "length": 1, "template": "[Investigator] investigated [Defendant] for [Crime] crime in [Place] place", "role_text_map": [{"role": "Investigator", "tokens": []}, {"role": "Defendant", "tokens": []}, {"role": "Crime", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "6_VOA_EN_NW_2016.09.20.3516717-E22", "text": "blew", "offset": 774, "length": 1, "template": "[Attacker] detonated or exploded [ExplosiveDevice] explosive device using [Instrument] to attack [Target] target at [Place] place", "role_text_map": [{"role": "Attacker", "tokens": []}, {"role": "Target", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "ExplosiveDevice", "tokens": [{"text": "bomb", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T186", "offset": 773, "length": 1}]}, {"role": "Place", "tokens": [{"text": "Seaside Park", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T102", "offset": 779, "length": 2}, {"text": "New Jersey", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T101", "offset": 782, "length": 2}]}]}, {"event_id": "6_VOA_EN_NW_2016.09.20.3516717-E23", "text": "exploded", "offset": 807, "length": 1, "template": "[Attacker] detonated or exploded [ExplosiveDevice] explosive device using [Instrument] to attack [Target] target at [Place] place", "role_text_map": [{"role": "Attacker", "tokens": []}, {"role": "Target", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "ExplosiveDevice", "tokens": [{"text": "bomb", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T105", "offset": 806, "length": 1}]}, {"role": "Place", "tokens": []}]}, {"event_id": "6_VOA_EN_NW_2016.09.20.3516717-E24", "text": "wounding", "offset": 818, "length": 1, "template": "[Victim] died at [Place] place from [MedicalIssue] medical issue, killed by [Killer] killer", "role_text_map": [{"role": "Victim", "tokens": [{"text": "people", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T97", "offset": 820, "length": 1}]}, {"role": "Place", "tokens": []}, {"role": "Killer", "tokens": []}, {"role": "MedicalIssue", "tokens": []}]}, {"event_id": "6_VOA_EN_NW_2016.09.20.3516717-E25", "text": "traveled", "offset": 944, "length": 1, "template": "[Transporter] transported [PassengerArtifact] in [Vehicle] from [Origin] place to [Destination] place", "role_text_map": [{"role": "Transporter", "tokens": []}, {"role": "PassengerArtifact", "tokens": []}, {"role": "Vehicle", "tokens": []}, {"role": "Origin", "tokens": [{"text": "New Jersey", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T126", "offset": 946, "length": 2}]}, {"role": "Destination", "tokens": [{"text": "New York", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T172", "offset": 949, "length": 2}]}]}, {"event_id": "6_VOA_EN_NW_2016.09.20.3516717-E26", "text": "released", "offset": 991, "length": 1, "template": "[JudgeCourt] court or judge released or paroled [Defendant] from [Crime] crime in [Place] place", "role_text_map": [{"role": "JudgeCourt", "tokens": []}, {"role": "Defendant", "tokens": [{"text": "five", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T15", "offset": 987, "length": 1}]}, {"role": "Crime", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "6_VOA_EN_NW_2016.09.20.3516717-E27", "text": "captured", "offset": 1012, "length": 1, "template": "[Jailer] arrested or jailed [Detainee] for [Crime] crime at [Place] place", "role_text_map": [{"role": "Jailer", "tokens": []}, {"role": "Detainee", "tokens": [{"text": "Rahami", "entity_id": "6_VOA_EN_NW_2016.09.20.3516717-T11", "offset": 1010, "length": 1}]}, {"role": "Crime", "tokens": []}, {"role": "Place", "tokens": []}]}]
    </div>

    <div id='relations-data' hidden>
      []
    </div>

    <div id="strategyB-tuples" hidden>
      ${strategyB-tuples}
    </div>

    <p>
      You can navigate all of the events by clicking the following buttons. <br>
      You have to finish all the events before submitting. (Remember that you can't refresh the page otherwise
      the progress will be gone, <br>
      to prevent this from happening, we suggest that you write the QA pairs in the google doc and copy paste them
      here)
    </p>
    <!-- Tabs for each trigger -->
    <div class="btn-toolbar" id="button-bar">
    </div>

    <div class="strategies">
      <span id="strategy-btns">
        <button id="selectA" class="btn btn-default" type="button">
          Strategy A</button>
        <button id="selectB" class="btn btn-default" type="button">
          Strategy B</button>
      </span>
      <select id="tuple-select">
      </select>
      <div class="ann-component">
        <em>
          KAIROS event arguments for triggers
        </em>
        <div id='template-area' class='ann well well-sm'>
        </div>
      </div>
      <div class="strategy" id="strategyA">
        <div class="ann-component">
          <em>
            These are relations between events.
          </em>
          <div id='relations-area' class='ann well well-sm'>
          </div>
        </div>
      </div>
      <div class="strategy" id="strategyB">
      </div>
    </div>
    <div id="input-area">
    </div>
    <div title="Fill all fields before submitting">
      <button id="save" class="btn btn-default" type="button">Save</button>
      <button id="submitButton" class="btn btn-default" type="button">Submit</button>
    </div>
  </section>


  <link crossorigin="anonymous" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
    integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" rel="stylesheet" />
  <style>.mg-15 {
    margin-left: 15px;
    margin-right: 15px;
}

.mg-5 {
    margin: 5px;
}

.container-fluid {
    max-width: 1800px;
    margin: 30px;
}

.btn-container {
    display: inline-block;
    margin: 10px;
}

.strategies {
    margin: 15px;
}

.ann-component {
    margin: 5px;
}


#collapseTrigger {
    color: #fff;
    display: block;
    text-decoration: none;
}

#submitButton {
    white-space: normal;
}

#input-area {
    display: block;
    margin: 10px;
}

.input-fields {
    margin: 10px;
    padding: 10px;
    background-color: #ffe3e3;
    border-radius: 15px;
}

#template-area {
    background-color: #eee;
    display: flex;
}

#relations-area {
    display: flex;
    flex-direction: column;
    row-gap: 5px;
}

.template-map {
    border: 1px solid gray;
    padding: 5px;
}

.btn-container>button {
    min-width: 3em;
}

trigger {
    display: inline;
}

role {
    display: inline;
}

.highlight-trigger {
    background-color: lightgoldenrodyellow;
}

.highlight-role {
    background-color: lightblue;
}

.highlight-role1 {
    background-color: rgba(255, 255, 0, 0.5);
}

.highlight-role2 {
    background-color: rgba(0, 255, 255, 0.5);
}

.highlight-role3 {
    background-color: rgba(255, 0, 255, 0.5);
}

.btn-group {
    vertical-align: middle;
}

.content {
    margin-bottom: 15px;
}

.ann {
    font-size: 16px;
}

.disp {
    font-size: 20px;
}

.ann>span.token {
    cursor: pointer;
}

.ann>span.token:hover {
    text-decoration: underline;
}

.ann>strong.annotation:hover {
    text-decoration: line-through;
}

input[disabled] {
    color: #000
}

.question-input, .answer-input {
    vertical-align: middle;
}</style>
  <script src="https://code.jquery.com/jquery-3.1.0.min.js"
    integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
    integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>
  <script>// ---------------------------------------------------------
// Global
// ---------------------------------------------------------

var page_num_set = new Set();
let strategy = '';
let developer_mode = false;

// ---------------------------------------------------------
// Create jQuery elements
// ---------------------------------------------------------

var submit = $('#submitButton');

// list of text/offset objects 
const events_data = JSON.parse($('#events-data').text().trim());
const relations_data = JSON.parse($('#relations-data').text().trim());
const strategyB_tuples = [["road_ied_8-E1", "road_ied_8-E2", "road_ied_8-E3"]];//JSON.parse($('#strategyB-tuples').text().trim());

const empty_template_map = function () {
    return $('<div class="template-map">');
}

const save_record = {
    A: {
        relations: relations_data,
        qapairs: [],
    },
    B: {
        qapairs: [],
    },
};

const strategyA_template = function (tno, event1, event2) {
    return {
        question: '',
        answer: '',
    }
}

const template_record = [];
events_data.forEach(function (ei, i) {
    template_record[i] = empty_template_map();
    events_data.forEach(function (ej, j) {
        if (i >= j) return;

        for (let tno = 1; tno <= 4; tno++){
            {
                const { question, answer } = strategyA_template(tno, ei, ej);
                save_record.A.qapairs.push({
                    event1_id: ei.event_id,
                    event2_id: ej.event_id,
                    templateno: tno,
                    question,
                    answer,
                });
            }
            {
                const { question, answer } = strategyA_template(tno, ej, ei);
                save_record.A.qapairs.push({
                    event1_id: ej.event_id,
                    event2_id: ei.event_id,
                    templateno: tno,
                    question,
                    answer,
                });
            }
        }
    });
});

function strategyB_template(event1_id, event2_id, event3_id) {
    const question = 'What is the participant in the event that interviews the transporter that flew the place that gone off the explosive device. ';
    const answer = '';
    return {
        question, answer
    };
}

strategyB_tuples.forEach(function (tuple, i) {
    const { question, answer } = strategyB_template(tuple[0], tuple[1], tuple[2]);
    save_record.B.qapairs.push({
        event1_id: tuple[0],
        event2_id: tuple[1],
        event3_id: tuple[2],
        question,
        answer,
    });
});

// implementation of string formatting
if (!String.prototype.format) {
    String.prototype.format = function () {
        var args = arguments;
        return this.replace(/{(\d+)}/g, function (match, number) {
            return typeof args[number] != 'undefined'
                ? args[number]
                : match
                ;
        });
    };
}

// ---------------------------------------------------------
// Create elements
// ---------------------------------------------------------

var makeDom = function () {
    recoverUserInput();
    console.log(page_num_set);
    highlightEvent();
};

var highlightEvent = function () {
    /* highlight trigger within document */
    const pagenos = Array.from(page_num_set);
    pagenos.sort((a, b) => events_data[a].offset - events_data[b].offset);

    // remove previous highlights
    $('trigger').removeClass('highlight-trigger');
    $('role').removeClass('highlight-role1 highlight-role2 highlight-role3');

    pagenos.forEach(trigger_num => {
        // highlight trigger
        $('#trigger-' + trigger_num).addClass('highlight-trigger');
        $('role[trigno=' + trigger_num + ']').addClass('highlight-role'+(trigger_num+1));
    })
}

const relationTypes = [
    "BEFORE",
    "AFTER",
    "OVERLAPS",
    "EQUAL",
    "CONTAINS",
    "CONTAINED BY",
    "CAUSES",
    "CAUSED BY",
]

// restore input from other trigger
var recoverUserInput = function () {
    const inputArea = $('#input-area');
    inputArea.empty();
    page_num_set.clear();

    let pagenos = [];
    if (strategy === 'A') {
        // questions
        const event_pair = $('#tuple-select').val().split(',').map(x => parseInt(x));
        page_num_set.add(event_pair[0]);
        page_num_set.add(event_pair[1]);

        pagenos = event_pair;
        pagenos.sort((a, b) => events_data[a].offset - events_data[b].offset);

        // relations
        const relationsArea = $('#relations-area');
        relationsArea.empty();
        pagenos.forEach(i => {
            pagenos.forEach(j => {
                if (i >= j) return;

                const event1 = events_data[i];
                const event2 = events_data[j];
                relationsArea.append(makeRelationSelect(event1, event2));
                relationsArea.append(makeRelationSelect(event2, event1));
            })
        })

        const matching_pairs = save_record.A.qapairs.filter(qa => {
            return (
                (qa.event1_id === events_data[event_pair[0]].event_id &&
                qa.event2_id === events_data[event_pair[1]].event_id) ||
                (qa.event1_id === events_data[event_pair[1]].event_id &&
                qa.event2_id === events_data[event_pair[0]].event_id)
            );
        });
        matching_pairs.forEach((qa, i) => {
            add_qa_input(qa.question, qa.answer, qa);
            if (i % 2 === 1 && i < matching_pairs.length - 1)
                inputArea.add($('<hr>'));
        });
    } else if (strategy === 'B') {
        const tuple = save_record.B.qapairs[$('#tuple-select').val()];
        console.log("TUPLE", tuple)
        page_num_set.add(events_data.findIndex(e => e.event_id === tuple.event1_id));
        page_num_set.add(events_data.findIndex(e => e.event_id === tuple.event2_id));
        page_num_set.add(events_data.findIndex(e => e.event_id === tuple.event3_id));
        pagenos = Array.from(page_num_set);
        pagenos.sort((a, b) => events_data[a].offset - events_data[b].offset);
        add_qa_input(tuple.question, tuple.answer, null, false);
        add_qa_input('', '', tuple, true);
    }
    // templates
    const templateArea = $('#template-area');
    templateArea.empty()
    pagenos.forEach(trigger_num => {
        const div = $('<div>')
            .append($('<p>').text(describeEvent(events_data[trigger_num])))
            .append(template_record[trigger_num]);
        templateArea.append(div);
    });
};

function describeEvent(event) {
    return (developer_mode ? `ID: ${event.event_id} | ` : "") + `${event.text} @ ${event.offset}`;
}

function makeRelationSelect(event1, event2) {
    const id1 = event1.event_id;
    const id2 = event2.event_id;
    const relation = relations_data.find(r =>
        r.event1_id == id1 &&
        r.event2_id == id2
    );

    const selectInput =
        $('<select class="relation-select mg-5">');
    relationTypes.forEach(type => {
        const option = $(`<option value="${type}">${type.toLowerCase()}</option>`);
        selectInput.append(option);
    });
    selectInput.append($('<option value="NONE">none</option>'));
    selectInput.val(relation?.type ?? "NONE");
    selectInput.on('change', function () {
        const type = $(this).val();
        const event1_id = id1;
        const event2_id = id2;
        const relation = relations_data.find(r =>
            r.event1_id == event1_id &&
            r.event2_id == event2_id
        );
        if (relation) {
            relation.type = type;
        } else {
            relations_data.push({
                event1_id,
                event2_id,
                type,
            });
        }
    });

    const div = $('<div>')
        .append($('<label>').text(describeEvent(event1)))
        .append(selectInput)
        .append($('<label>').text(describeEvent(event2)))

    return div;
}

// ensure something is in the input box
var canSubmit = function () {
    return true;
};

// template role fields
const make_role_mapping_element = function (role, text) {
    const role_text = $('<label>').html('<b>' + role + '</b>:');
    const role_field = $('<span>')
        .addClass('role-field')
        .attr({
            role: role,
            rows: 1,
        })
        .text(text)

    const role_div = $('<div>')
        .addClass('role-container')
        .append(role_text)
        .append(role_field);

    return role_div;
}


const add_qa_input = function (question = '', answer = '', ref = null, editable = true) {
    let question_text = $('<label>').text('question:');
    let question_input = $('<textarea>')
        .addClass('question-input')
        .addClass('mg-15')
        .attr({
            placeholder: 'write down your question',
            rows: 2,
            cols: 80,
        })
        .text(question);
    question_input.on("input", function () {
        console.log('q', ref)
        if (ref != null)
            ref.question = $(this).val();
        show();
    });
    let answer_text = $('<label>').text('answer:');
    let answer_input = $('<textarea>')
        .addClass('answer-input')
        .addClass('mg-15')
        .attr({
            placeholder: 'write down your answer',
            rows: 2,
            cols: 80,
        })
        .text(answer);
    answer_input.on("input", function () {
        console.log('a', ref)
        if (ref != null)
            ref.answer = $(this).val();
        show();
    });

    if (!editable) {
        question_input.attr('disabled', 'disabled');
        answer_input.attr('disabled', 'disabled');
    }

    const input_fields = $('<div>')
        .addClass('input-fields')
        .append(question_text)
        .append(question_input)
        .append(answer_text)
        .append(answer_input)

    $('#input-area').append(input_fields);

    show();
};

var enable_button = function (button) {
    button.removeAttr("disabled");
    button.removeClass("btn-default");
    button.addClass("btn-success");
};

var disable_button = function (button) {
    button.attr("disabled", "disabled");
    button.removeClass("btn-success");
    button.addClass("btn-default");
};

var select_button = function (button) {
    button.removeClass("btn-default");
    button.addClass("btn-primary");
};

var deselect_button = function (button) {
    button.removeClass("btn-primary");
    button.addClass("btn-default");
};

var is_wh_question = function (question) {
    let tokens = question.split(' ');
    if (tokens.length <= 1) {
        return false;
    }

    // let wh_pattern = /^Wh\|wh\|How\|how/;
    let wh_pattern = /^wh|Wh|how|How/;
    // console.log(question.match(wh_pattern));
    return !!question.match(wh_pattern);
};


var show = function () {
    for (button of document.getElementById('button-bar').getElementsByTagName('*')) {
        if (page_num_set.has(parseInt(button.getAttribute('page-no'))))
            select_button($(button));
        else
            deselect_button($(button));
    }

};

// dynamically create buttons for each SRL arg
events_data.forEach(function (event, i) {
    if (event.text.trim()) {
        var button = document.createElement("button");
        button.setAttribute("type", "button");
        button.setAttribute("id", "button-page-" + i);
        button.setAttribute("page-no", i);
        button.setAttribute("class", "btn btn-default");
        button.innerHTML = describeEvent(event);
        button.onclick = function () {
            // const pageno = parseInt(this.getAttribute("page-no"));
            // // toggle button
            // if (button.classList.contains('btn-default'))
            //     page_num_set.add(pageno);
            // else
            //     page_num_set.delete(pageno);
            // makeDom();
            // let instruction = $('#instructionBody');
            // if (instruction.is(':visible')) {
            //     instruction.toggle();
            // }
            // //window.scrollTo(0, 0); // scroll to top
            // show();
        }
        document.getElementById('button-bar').appendChild(button);
    }

    // format template area with role mappings
    // if template not null or undefined
    if (event.template !== null) {
        const template_area = template_record[i];
        const template = $('<p>').text(event.template);
        template_area.append(template);
        event.role_text_map.forEach(function (pairing) {
            template_area.append(make_role_mapping_element(pairing.role, pairing.tokens.map(tk => tk.text).join('/')));
        });
    }
})

// ---------------------------------------------------------
// Initialize
// ---------------------------------------------------------

var submit_form = function (event) {
    event.preventDefault();
    if (!window.confirm("Are you sure you want to submit?")) return;
    save_all();

    const urlParams = new URLSearchParams(window.location.search)

    // create the form element and point it to the correct endpoint
    const form = document.createElement('form')
    form.action = (new URL('mturk/externalSubmit', urlParams.get('turkSubmitTo'))).href
    form.method = 'post'

    // attach the assignmentId
    const inputAssignmentId = document.createElement('input')
    inputAssignmentId.name = 'assignmentId'
    inputAssignmentId.value = urlParams.get('assignmentId')
    inputAssignmentId.hidden = true
    form.appendChild(inputAssignmentId)

    // attach data I want to send back
    const inputResults = document.createElement('input')
    inputResults.name = 'results'
    inputResults.value = JSON.stringify(save_record)
    inputResults.hidden = true
    form.appendChild(inputResults)

    // attach the form to the HTML document and trigger submission
    document.body.appendChild(form)
    form.submit()
}

//$('#save').on('click', save_all);
submit.on('click', submit_form);

var popup_alert = function (alert_box, text) {
    alert_box.html(text);
    alert_box.css({
        'background-color': 'fec5bb',
        'padding': '5px',
        'border': '1px solid lightgray',
        'border-radius': '10px',
        'margin-top': '10px',
        'margin-bottom': '10px'
    });
    displaying = true;
    setTimeout(function () {
        alert_box.html('');
        alert_box.css({
            'padding': '0px',
            'border': '0px'
        });
        displaying = false;
    }, 7000);
};

const selectA = $('#selectA');
const selectB = $('#selectB');

const tupleSelect = $('#tuple-select');


function makeSelectionOptions() {
    if (strategy === 'A') {
        tupleSelect.empty();
        events_data.forEach(function (ei, i) {
            events_data.forEach(function (ej, j) {
                if (i >= j) return;
                const opt = $('<option>')
                    .attr({
                        value: `${i},${j}`,
                    })
                    .text(`${describeEvent(ei)} & ${describeEvent(ej)}`);
                tupleSelect.append(opt);
            });
        });
        tupleSelect.children()[0].selected = true;
    } else {
        tupleSelect.empty();
        function describeEventById(id) {
            const event = events_data.find(e => e.event_id === id);
            return describeEvent(event);
        }
        strategyB_tuples.forEach(function (tuple, i) {
            const opt = $('<option>')
                .attr({
                    value: i,
                })
                .text(`${describeEventById(tuple[0])}, ${describeEventById(tuple[1])}, ${describeEventById(tuple[2])}`);
            tupleSelect.append(opt);
        });
        tupleSelect.children()[0].selected = true;
    }
}

selectA.on('click', function () {
    if (strategy === 'A') return;
    strategy = 'A';
    $('#strategyA').show();
    select_button(selectA);
    $('#strategyB').hide();
    deselect_button(selectB);
    makeSelectionOptions();
    makeDom();
    show();
});

selectB.on('click', function () {
    if (strategy === 'B') return;
    strategy = 'B';
    $('#strategyA').hide();
    deselect_button(selectA);
    $('#strategyB').show();
    select_button(selectB);
    makeSelectionOptions();
    makeDom();
    show();
});

selectA.click();

tupleSelect.on('change', function () {
    makeDom();
    show();
});

$('#developer-mode').on('change', function () {
    developer_mode = this.checked;
    makeSelectionOptions();
    makeDom();
    show();
});

// Instructions expand/collapse
var content = $('#instructionBody');
var instructions_trigger = $('#collapseTrigger');
// content.hide();
$('.collapse-text').text('(Click to collapse)');
instructions_trigger.click(function () {
    content.toggle();
    var isVisible = content.is(':visible');
    if (isVisible) {
        $('.collapse-text').text('(Click to collapse)');
    } else {
        $('.collapse-text').text('(Click to expand)');
    }
});

console.log(save_record)
show();
</script>
</crowd-form>