<crowd-form answer-format="flatten-objects">
  <section class="container-fluid" id="Relevancy">
    <div class="row">
      <div class="col-xs-12 col-md-12">
        <div class="panel panel-primary">
          <a class="panel-heading" href="javascript:void(0);" id="collapseTrigger">
            <strong>Annotation Instructions</strong>
            <span class="collapse-text">(Click to expand)</span>
          </a>
          <div class="panel-body" id="instructionBody">
            {{INSTRUCTIONS}}
            {{LINK}}
          </div>
        </div>
      </div>
    </div>

    Enable developer mode:
    <input type="checkbox" id="developer-mode">

    <h3>Document</h3>
    <div id="document-text" class="ann well well-sm">
      Oklahoma City Bombing Documentary Examines Growth of American Extremism WASHINGTON — The <role id='role-0-Place-0'trigno='0'>Oklahoma City</role> <trigger id='trigger-0'>bombing</trigger> nearly 22 years ago was an act of domestic terror by U. S. military veteran <role id='role-0-Attacker-0'trigno='0'>Timothy McVeigh</role> and his accomplice, <role id='role-0-Attacker-1'trigno='0'>Terry Nichols</role>. The bombing destroyed one third of the Alfred P. Murrah Federal Building in downtown Oklahoma City, Oklahoma, <trigger id='trigger-1'>killing</trigger> 168 <role id='role-1-Victim-0'trigno='1'>people</role> and <trigger id='trigger-2'>injuring</trigger> 680 <role id='role-2-Victim-0'trigno='2'>others</role>. In his documentary, Oklahoma City, filmmaker Barak Goodman revisits the bombing as the first major domestic terrorist attack in the United States on April 19, 1995. It was the number of civilians killed-especially the 15 children, four of them infants, crushed inside the building's day care center-that made this terrorist attack by a massive fertilizer bomb so heinous for many Americans. Many films have recounted the story, but Goodman’s documentary treats the Oklahoma City <trigger id='trigger-3'>bombing</trigger> as a springboard to examine the roots of America's ultra-right militia and to analyze the makeup of homegrown American terrorism. History of suspicion “It goes all the way back to the founding of the Republic,” the filmmaker told VOA."The Republic was founded on the suspicion of government."Goodman says many of these extreme separatists believe in white supremacy and in unregulated freedom to keep and bear arms so that they can protect themselves from outsiders and the government. In the documentary, former militia member Kerry Noble explains the ideology. “The government is an enemy of the people, and in this war it’s an all or nothing. We’re either gonna win as the white race or we’re gonna lose.” FILE-In this April 21, 1995 file photo, Timothy McVeigh is led out of the Noble County Courthouse by state and federal law enforcement officials in Perry, Oklahoma, after being identified as a suspect in the bombing of the Oklahoma City Federal building. <role id='role-4-Defendant-0'trigno='4'>McVeigh</role> was eventually <trigger id='trigger-4'>convicted</trigger> of the bombing and executed. Oklahoma City points to two events in the late 20th century that bolstered separatist ideologies: The Ruby Ridge incident on August 21, 1992, and the Waco siege in Waco, Texas, between February 28 and April 19, 1993. In both cases, federal and local government agents clashed with American separatists. The deadly incidents were fueled by the authorities'demand to search the premises for illegal firearms. The Waco siege was particularly deadly. The compound belonged to a group known as the Branch Davidians, led by David Koresh. When federal authorities sent in armed agents and armored vehicles to end the standoff, a fire engulfed the compound, <trigger id='trigger-5'>killing</trigger> 82 <role id='role-5-Victim-0'trigno='5'>people</role>, including <role id='role-5-Victim-1'trigno='5'>David Koresh</role>. Sixty-two of the victims were women and children. Birth of an extremist Timothy McVeigh, a Gulf War veteran disillusioned by the government during his tour in Iraq, was among those who went to witness the siege. According to the documentary, McVeigh was radicalized by those events and by an extremist publication called The Turner Diaries. “It’s a Talisman for the far right, even to this day, but especially back in the'90s and'80s it was the ‘ Bible’of this movement,” says Goodman. “It’s a novel about a small group of ‘ patriots,’‘ white patriots’who retake the government from the Jews and blacks who have infiltrated it, essentially. It’s a racist creed and as I said, it is very poorly done. Intriguingly though, it describes the bombing of the FBI, the culmination of the novel, and it really lays out a recipe on how to <trigger id='trigger-6'>build</trigger> a <role id='role-6-Artifact-0'trigno='6'>bomb</role> like this."That bomb is very similar to the one McVeigh used in Oklahoma City."McVeigh was deeply, deeply influenced by this book,"Goodman adds."He sold it in gun shows, he quoted it, when <role id='role-7-Detainee-0'trigno='7'>he</role> was <trigger id='trigger-7'>arrested</trigger> he had several pages of it in a folder beside him in a car. And it wasn’t just McVeigh, it was all through this movement. People were really exorcised, impassioned, inflamed by this novel."FILE-In this May 5, 1995, photo, search and rescue personnel attend a memorial service in front of the Alfred P. Murrah Federal Building in Oklahoma, destroyed by a fertilizer bomb in what is considered the first major domestic terrorist attack in the U. S. The documentary shows McVeigh obsessed with his guns and with the idea that the government was going to take them away. The film also points out that his exposure to the war in Iraq accelerated his feeling of mistrust of the U. S. government. “The way he put it made it sound he was emphatic towards the dead Iraqi soldiers that he killed. I really don’t think that’s the case,” says Barak Goodman. Instead, says the filmmaker, it was McVeigh’s mistrust of the U. S. government, how it had blundered into Iraq and his idea of the U. S. government as a bully, and McVeigh, says Goodman, hated bullies. The Ruby Ridge and Waco stand-offs reinforced that idea in his mind. Homegrown extremism According to the documentary, there are 500 militia organizations in the U. S. today. Goodman believes they are as radicalized as ever. “Some of them have gotten rid of their camouflage outfits and put on suits and ties, but really the rhetoric has been virtually the same for 100 years or more. ‘ It’s a whites-only country, it should be a whites-only country, the federal government is in the hands of Jews, blacks, it’s a conspiracy.'” Goodman says it is a misconception to believe that this is a movement of white poor disenfranchised people. Certainly, he says, many are, but there also many professionals feeling a loss of entitlement, a loss of privilege and power. The filmmaker stresses that these people operate outside political parties and share a deep mistrust of the Washington political establishment. But Goodman cautions these extremists are not de facto terrorists. He says it takes a confluence of opportunity and a warped personality, often a lone individual, to commit a terrorist act of a scale such as the <role id='role-8-Target-0'trigno='8'>Oklahoma City</role> <trigger id='trigger-8'>bombing</trigger>. “McVeigh was a shock to most people in the FBI. It would be less of a shock today. But it’s very hard to prevent these things. One of the takeaways from our film and audiences who have seen it have been amazed at how really easy it was to do this. It cost about $6000, it was one guy, reading some literature,” says the filmmaker. FILE-A member of a white supremacy group gives a fascist salute during a gathering in West Allis, Wisconsin, Sept. 3, 2011."The number of hate groups in the United States rose for a second year in a row in 2016 as the radical right was energized by the candidacy of Donald Trump,” according to the Southern Law Poverty Center, a U. S. rights group. Goodman says in a politically polarized America, the possibility for future domestic terrorist attacks is high. “If you talk to people from the Southern Law Poverty Center, which tracks these groups, they are pounding on the wall, they are ringing the bell, they are saying, ‘ This is an ongoing threat, it’s threat level midnight, it's rising, it's whatever the highest color is on the chart,'” he says. The SPLC reports, “the number of hate groups in the United States rose for a second year in a row in 2016 as the radical right was energized by the candidacy of Donald Trump.” “The most dramatic growth,” it states, “was the near-tripling of anti-Muslim hate groups–from 34 in 2015 to 101 last year.” Also, a wave of bomb threats and vandalism has rattled Jewish institutions around the country, but especially in the South. “Right now, minorities feel particularly threatened,” says the Oklahoma City filmmaker. “There is a very big difference between even hard gun rights activists and terrorists. I want to make that clear,” says Goodman. “I would take issue with the idea that they have infiltrated the administration. But it is a little galling to see the really mono focus on terrorists from abroad, terrorists influenced by ideas from abroad, whatever those ideas might be, and not on any real discussion about home-grown terrorism which has always been with us and which is not going away and which is actually--if you look at the numbers of the incidents--rivaling or exceeding those by that other group,” he adds. Goodman hopes his film, Oklahoma City, will call attention to this rising threat and contribute to the conversation on the inherent dangers of domestic terrorism. 
    </div>

    <div id='events-data' hidden>
      [{"event_id": "7_VOA_EN_NW_2017.03.07.3753687-E1", "text": "bombing", "offset": 14, "length": 1, "template": "[Attacker] detonated or exploded [ExplosiveDevice] explosive device using [Instrument] to attack [Target] target at [Place] place", "role_text_map": [{"role": "Attacker", "tokens": [{"text": "Timothy McVeigh", "entity_id": "7_VOA_EN_NW_2017.03.07.3753687-T53", "offset": 32, "length": 2}, {"text": "Terry Nichols", "entity_id": "7_VOA_EN_NW_2017.03.07.3753687-T50", "offset": 38, "length": 2}]}, {"role": "Target", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "ExplosiveDevice", "tokens": []}, {"role": "Place", "tokens": [{"text": "Oklahoma City", "entity_id": "7_VOA_EN_NW_2017.03.07.3753687-T57", "offset": 12, "length": 2}]}]}, {"event_id": "7_VOA_EN_NW_2017.03.07.3753687-E2", "text": "killing", "offset": 61, "length": 1, "template": "[Victim] died at [Place] place from [MedicalIssue] medical issue, killed by [Killer] killer", "role_text_map": [{"role": "Victim", "tokens": [{"text": "people", "entity_id": "7_VOA_EN_NW_2017.03.07.3753687-T118", "offset": 63, "length": 1}]}, {"role": "Place", "tokens": []}, {"role": "Killer", "tokens": []}, {"role": "MedicalIssue", "tokens": []}]}, {"event_id": "7_VOA_EN_NW_2017.03.07.3753687-E3", "text": "injuring", "offset": 65, "length": 1, "template": "[Victim] was injured by [Injurer] using [Instrument] in [BodyPart] body part with [MedicalCondition] medical issue at [Place] place", "role_text_map": [{"role": "Victim", "tokens": [{"text": "others", "entity_id": "7_VOA_EN_NW_2017.03.07.3753687-T120", "offset": 67, "length": 1}]}, {"role": "Injurer", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "BodyPart", "tokens": []}, {"role": "MedicalCondition", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "7_VOA_EN_NW_2017.03.07.3753687-E4", "text": "bombing", "offset": 159, "length": 1, "template": "[Attacker] attacked [Target] using [Instrument] at [Place] place", "role_text_map": [{"role": "Attacker", "tokens": []}, {"role": "Target", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "7_VOA_EN_NW_2017.03.07.3753687-E5", "text": "convicted", "offset": 357, "length": 1, "template": "[JudgeCourt] court or judge convicted [Defendant] of [Crime] crime in [Place] place", "role_text_map": [{"role": "JudgeCourt", "tokens": []}, {"role": "Defendant", "tokens": [{"text": "McVeigh", "entity_id": "7_VOA_EN_NW_2017.03.07.3753687-T106", "offset": 354, "length": 1}]}, {"role": "Crime", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "7_VOA_EN_NW_2017.03.07.3753687-E6", "text": "killing", "offset": 485, "length": 1, "template": "[Victim] died at [Place] place from [MedicalIssue] medical issue, killed by [Killer] killer", "role_text_map": [{"role": "Victim", "tokens": [{"text": "people", "entity_id": "7_VOA_EN_NW_2017.03.07.3753687-T146", "offset": 487, "length": 1}, {"text": "David Koresh", "entity_id": "7_VOA_EN_NW_2017.03.07.3753687-T205", "offset": 490, "length": 2}]}, {"role": "Place", "tokens": []}, {"role": "Killer", "tokens": []}, {"role": "MedicalIssue", "tokens": []}]}, {"event_id": "7_VOA_EN_NW_2017.03.07.3753687-E7", "text": "build", "offset": 675, "length": 1, "template": "[ManufacturerAssembler] manufactured or assembled or produced [Artifact] from [Components] components using [Instrument] at [Place] place", "role_text_map": [{"role": "ManufacturerAssembler", "tokens": []}, {"role": "Artifact", "tokens": [{"text": "bomb", "entity_id": "7_VOA_EN_NW_2017.03.07.3753687-T28", "offset": 677, "length": 1}]}, {"role": "Components", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "7_VOA_EN_NW_2017.03.07.3753687-E8", "text": "arrested", "offset": 726, "length": 1, "template": "[Jailer] arrested or jailed [Detainee] for [Crime] crime at [Place] place", "role_text_map": [{"role": "Jailer", "tokens": []}, {"role": "Detainee", "tokens": [{"text": "he", "entity_id": "7_VOA_EN_NW_2017.03.07.3753687-T96", "offset": 724, "length": 1}]}, {"role": "Crime", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "7_VOA_EN_NW_2017.03.07.3753687-E9", "text": "bombing", "offset": 1182, "length": 1, "template": "[Attacker] detonated or exploded [ExplosiveDevice] explosive device using [Instrument] to attack [Target] target at [Place] place", "role_text_map": [{"role": "Attacker", "tokens": []}, {"role": "Target", "tokens": [{"text": "Oklahoma City", "entity_id": "7_VOA_EN_NW_2017.03.07.3753687-T212", "offset": 1180, "length": 2}]}, {"role": "Instrument", "tokens": []}, {"role": "ExplosiveDevice", "tokens": []}, {"role": "Place", "tokens": []}]}]
    </div>

    <div id='relations-data' hidden>
      []
    </div>

    <div id="strategyB-tuples" hidden>
      ${strategyB-tuples}
    </div>

    <p>
      You can navigate all of the events by clicking the following buttons. <br>
      You have to finish all the events before submitting. (Remember that you can't refresh the page otherwise
      the progress will be gone, <br>
      to prevent this from happening, we suggest that you write the QA pairs in the google doc and copy paste them
      here)
    </p>
    <!-- Tabs for each trigger -->
    <div class="btn-toolbar" id="button-bar">
    </div>

    <div class="strategies">
      <span id="strategy-btns">
        <button id="selectA" class="btn btn-default" type="button">
          Strategy A</button>
        <button id="selectB" class="btn btn-default" type="button">
          Strategy B</button>
      </span>
      <select id="tuple-select">
      </select>
      <div class="ann-component">
        <em>
          KAIROS event arguments for triggers
        </em>
        <div id='template-area' class='ann well well-sm'>
        </div>
      </div>
      <div class="strategy" id="strategyA">
        <div class="ann-component">
          <em>
            These are relations between events.
          </em>
          <div id='relations-area' class='ann well well-sm'>
          </div>
        </div>
      </div>
      <div class="strategy" id="strategyB">
      </div>
    </div>
    <div id="input-area">
    </div>
    <div title="Fill all fields before submitting">
      <button id="save" class="btn btn-default" type="button">Save</button>
      <button id="submitButton" class="btn btn-default" type="button">Submit</button>
    </div>
  </section>


  <link crossorigin="anonymous" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
    integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" rel="stylesheet" />
  <style>.mg-15 {
    margin-left: 15px;
    margin-right: 15px;
}

.mg-5 {
    margin: 5px;
}

.container-fluid {
    max-width: 1800px;
    margin: 30px;
}

.btn-container {
    display: inline-block;
    margin: 10px;
}

.strategies {
    margin: 15px;
}

.ann-component {
    margin: 5px;
}


#collapseTrigger {
    color: #fff;
    display: block;
    text-decoration: none;
}

#submitButton {
    white-space: normal;
}

#input-area {
    display: block;
    margin: 10px;
}

.input-fields {
    margin: 10px;
    padding: 10px;
    background-color: #ffe3e3;
    border-radius: 15px;
}

#template-area {
    background-color: #eee;
    display: flex;
}

#relations-area {
    display: flex;
    flex-direction: column;
    row-gap: 5px;
}

.template-map {
    border: 1px solid gray;
    padding: 5px;
}

.btn-container>button {
    min-width: 3em;
}

trigger {
    display: inline;
}

role {
    display: inline;
}

.highlight-trigger {
    background-color: lightgoldenrodyellow;
}

.highlight-role {
    background-color: lightblue;
}

.highlight-role1 {
    background-color: rgba(255, 255, 0, 0.5);
}

.highlight-role2 {
    background-color: rgba(0, 255, 255, 0.5);
}

.highlight-role3 {
    background-color: rgba(255, 0, 255, 0.5);
}

.btn-group {
    vertical-align: middle;
}

.content {
    margin-bottom: 15px;
}

.ann {
    font-size: 16px;
}

.disp {
    font-size: 20px;
}

.ann>span.token {
    cursor: pointer;
}

.ann>span.token:hover {
    text-decoration: underline;
}

.ann>strong.annotation:hover {
    text-decoration: line-through;
}

input[disabled] {
    color: #000
}

.question-input, .answer-input {
    vertical-align: middle;
}</style>
  <script src="https://code.jquery.com/jquery-3.1.0.min.js"
    integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
    integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>
  <script>// ---------------------------------------------------------
// Global
// ---------------------------------------------------------

var page_num_set = new Set();
let strategy = '';
let developer_mode = false;

// ---------------------------------------------------------
// Create jQuery elements
// ---------------------------------------------------------

var submit = $('#submitButton');

// list of text/offset objects 
const events_data = JSON.parse($('#events-data').text().trim());
const relations_data = JSON.parse($('#relations-data').text().trim());
const strategyB_tuples = [["road_ied_8-E1", "road_ied_8-E2", "road_ied_8-E3"]];//JSON.parse($('#strategyB-tuples').text().trim());

const empty_template_map = function () {
    return $('<div class="template-map">');
}

const save_record = {
    A: {
        relations: relations_data,
        qapairs: [],
    },
    B: {
        qapairs: [],
    },
};

const strategyA_template = function (tno, event1, event2) {
    return {
        question: '',
        answer: '',
    }
}

const template_record = [];
events_data.forEach(function (ei, i) {
    template_record[i] = empty_template_map();
    events_data.forEach(function (ej, j) {
        if (i >= j) return;

        for (let tno = 1; tno <= 4; tno++){
            {
                const { question, answer } = strategyA_template(tno, ei, ej);
                save_record.A.qapairs.push({
                    event1_id: ei.event_id,
                    event2_id: ej.event_id,
                    templateno: tno,
                    question,
                    answer,
                });
            }
            {
                const { question, answer } = strategyA_template(tno, ej, ei);
                save_record.A.qapairs.push({
                    event1_id: ej.event_id,
                    event2_id: ei.event_id,
                    templateno: tno,
                    question,
                    answer,
                });
            }
        }
    });
});

function strategyB_template(event1_id, event2_id, event3_id) {
    const question = 'What is the participant in the event that interviews the transporter that flew the place that gone off the explosive device. ';
    const answer = '';
    return {
        question, answer
    };
}

strategyB_tuples.forEach(function (tuple, i) {
    const { question, answer } = strategyB_template(tuple[0], tuple[1], tuple[2]);
    save_record.B.qapairs.push({
        event1_id: tuple[0],
        event2_id: tuple[1],
        event3_id: tuple[2],
        question,
        answer,
    });
});

// implementation of string formatting
if (!String.prototype.format) {
    String.prototype.format = function () {
        var args = arguments;
        return this.replace(/{(\d+)}/g, function (match, number) {
            return typeof args[number] != 'undefined'
                ? args[number]
                : match
                ;
        });
    };
}

// ---------------------------------------------------------
// Create elements
// ---------------------------------------------------------

var makeDom = function () {
    recoverUserInput();
    console.log(page_num_set);
    highlightEvent();
};

var highlightEvent = function () {
    /* highlight trigger within document */
    const pagenos = Array.from(page_num_set);
    pagenos.sort((a, b) => events_data[a].offset - events_data[b].offset);

    // remove previous highlights
    $('trigger').removeClass('highlight-trigger');
    $('role').removeClass('highlight-role1 highlight-role2 highlight-role3');

    pagenos.forEach(trigger_num => {
        // highlight trigger
        $('#trigger-' + trigger_num).addClass('highlight-trigger');
        $('role[trigno=' + trigger_num + ']').addClass('highlight-role'+(trigger_num+1));
    })
}

const relationTypes = [
    "BEFORE",
    "AFTER",
    "OVERLAPS",
    "EQUAL",
    "CONTAINS",
    "CONTAINED BY",
    "CAUSES",
    "CAUSED BY",
]

// restore input from other trigger
var recoverUserInput = function () {
    const inputArea = $('#input-area');
    inputArea.empty();
    page_num_set.clear();

    let pagenos = [];
    if (strategy === 'A') {
        // questions
        const event_pair = $('#tuple-select').val().split(',').map(x => parseInt(x));
        page_num_set.add(event_pair[0]);
        page_num_set.add(event_pair[1]);

        pagenos = event_pair;
        pagenos.sort((a, b) => events_data[a].offset - events_data[b].offset);

        // relations
        const relationsArea = $('#relations-area');
        relationsArea.empty();
        pagenos.forEach(i => {
            pagenos.forEach(j => {
                if (i >= j) return;

                const event1 = events_data[i];
                const event2 = events_data[j];
                relationsArea.append(makeRelationSelect(event1, event2));
                relationsArea.append(makeRelationSelect(event2, event1));
            })
        })

        const matching_pairs = save_record.A.qapairs.filter(qa => {
            return (
                (qa.event1_id === events_data[event_pair[0]].event_id &&
                qa.event2_id === events_data[event_pair[1]].event_id) ||
                (qa.event1_id === events_data[event_pair[1]].event_id &&
                qa.event2_id === events_data[event_pair[0]].event_id)
            );
        });
        matching_pairs.forEach((qa, i) => {
            add_qa_input(qa.question, qa.answer, qa);
            if (i % 2 === 1 && i < matching_pairs.length - 1)
                inputArea.add($('<hr>'));
        });
    } else if (strategy === 'B') {
        const tuple = save_record.B.qapairs[$('#tuple-select').val()];
        console.log("TUPLE", tuple)
        page_num_set.add(events_data.findIndex(e => e.event_id === tuple.event1_id));
        page_num_set.add(events_data.findIndex(e => e.event_id === tuple.event2_id));
        page_num_set.add(events_data.findIndex(e => e.event_id === tuple.event3_id));
        pagenos = Array.from(page_num_set);
        pagenos.sort((a, b) => events_data[a].offset - events_data[b].offset);
        add_qa_input(tuple.question, tuple.answer, null, false);
        add_qa_input('', '', tuple, true);
    }
    // templates
    const templateArea = $('#template-area');
    templateArea.empty()
    pagenos.forEach(trigger_num => {
        const div = $('<div>')
            .append($('<p>').text(describeEvent(events_data[trigger_num])))
            .append(template_record[trigger_num]);
        templateArea.append(div);
    });
};

function describeEvent(event) {
    return (developer_mode ? `ID: ${event.event_id} | ` : "") + `${event.text} @ ${event.offset}`;
}

function makeRelationSelect(event1, event2) {
    const id1 = event1.event_id;
    const id2 = event2.event_id;
    const relation = relations_data.find(r =>
        r.event1_id == id1 &&
        r.event2_id == id2
    );

    const selectInput =
        $('<select class="relation-select mg-5">');
    relationTypes.forEach(type => {
        const option = $(`<option value="${type}">${type.toLowerCase()}</option>`);
        selectInput.append(option);
    });
    selectInput.append($('<option value="NONE">none</option>'));
    selectInput.val(relation?.type ?? "NONE");
    selectInput.on('change', function () {
        const type = $(this).val();
        const event1_id = id1;
        const event2_id = id2;
        const relation = relations_data.find(r =>
            r.event1_id == event1_id &&
            r.event2_id == event2_id
        );
        if (relation) {
            relation.type = type;
        } else {
            relations_data.push({
                event1_id,
                event2_id,
                type,
            });
        }
    });

    const div = $('<div>')
        .append($('<label>').text(describeEvent(event1)))
        .append(selectInput)
        .append($('<label>').text(describeEvent(event2)))

    return div;
}

// ensure something is in the input box
var canSubmit = function () {
    return true;
};

// template role fields
const make_role_mapping_element = function (role, text) {
    const role_text = $('<label>').html('<b>' + role + '</b>:');
    const role_field = $('<span>')
        .addClass('role-field')
        .attr({
            role: role,
            rows: 1,
        })
        .text(text)

    const role_div = $('<div>')
        .addClass('role-container')
        .append(role_text)
        .append(role_field);

    return role_div;
}


const add_qa_input = function (question = '', answer = '', ref = null, editable = true) {
    let question_text = $('<label>').text('question:');
    let question_input = $('<textarea>')
        .addClass('question-input')
        .addClass('mg-15')
        .attr({
            placeholder: 'write down your question',
            rows: 2,
            cols: 80,
        })
        .text(question);
    question_input.on("input", function () {
        console.log('q', ref)
        if (ref != null)
            ref.question = $(this).val();
        show();
    });
    let answer_text = $('<label>').text('answer:');
    let answer_input = $('<textarea>')
        .addClass('answer-input')
        .addClass('mg-15')
        .attr({
            placeholder: 'write down your answer',
            rows: 2,
            cols: 80,
        })
        .text(answer);
    answer_input.on("input", function () {
        console.log('a', ref)
        if (ref != null)
            ref.answer = $(this).val();
        show();
    });

    if (!editable) {
        question_input.attr('disabled', 'disabled');
        answer_input.attr('disabled', 'disabled');
    }

    const input_fields = $('<div>')
        .addClass('input-fields')
        .append(question_text)
        .append(question_input)
        .append(answer_text)
        .append(answer_input)

    $('#input-area').append(input_fields);

    show();
};

var enable_button = function (button) {
    button.removeAttr("disabled");
    button.removeClass("btn-default");
    button.addClass("btn-success");
};

var disable_button = function (button) {
    button.attr("disabled", "disabled");
    button.removeClass("btn-success");
    button.addClass("btn-default");
};

var select_button = function (button) {
    button.removeClass("btn-default");
    button.addClass("btn-primary");
};

var deselect_button = function (button) {
    button.removeClass("btn-primary");
    button.addClass("btn-default");
};

var is_wh_question = function (question) {
    let tokens = question.split(' ');
    if (tokens.length <= 1) {
        return false;
    }

    // let wh_pattern = /^Wh\|wh\|How\|how/;
    let wh_pattern = /^wh|Wh|how|How/;
    // console.log(question.match(wh_pattern));
    return !!question.match(wh_pattern);
};


var show = function () {
    for (button of document.getElementById('button-bar').getElementsByTagName('*')) {
        if (page_num_set.has(parseInt(button.getAttribute('page-no'))))
            select_button($(button));
        else
            deselect_button($(button));
    }

};

// dynamically create buttons for each SRL arg
events_data.forEach(function (event, i) {
    if (event.text.trim()) {
        var button = document.createElement("button");
        button.setAttribute("type", "button");
        button.setAttribute("id", "button-page-" + i);
        button.setAttribute("page-no", i);
        button.setAttribute("class", "btn btn-default");
        button.innerHTML = describeEvent(event);
        button.onclick = function () {
            // const pageno = parseInt(this.getAttribute("page-no"));
            // // toggle button
            // if (button.classList.contains('btn-default'))
            //     page_num_set.add(pageno);
            // else
            //     page_num_set.delete(pageno);
            // makeDom();
            // let instruction = $('#instructionBody');
            // if (instruction.is(':visible')) {
            //     instruction.toggle();
            // }
            // //window.scrollTo(0, 0); // scroll to top
            // show();
        }
        document.getElementById('button-bar').appendChild(button);
    }

    // format template area with role mappings
    // if template not null or undefined
    if (event.template !== null) {
        const template_area = template_record[i];
        const template = $('<p>').text(event.template);
        template_area.append(template);
        event.role_text_map.forEach(function (pairing) {
            template_area.append(make_role_mapping_element(pairing.role, pairing.tokens.map(tk => tk.text).join('/')));
        });
    }
})

// ---------------------------------------------------------
// Initialize
// ---------------------------------------------------------

var submit_form = function (event) {
    event.preventDefault();
    if (!window.confirm("Are you sure you want to submit?")) return;
    save_all();

    const urlParams = new URLSearchParams(window.location.search)

    // create the form element and point it to the correct endpoint
    const form = document.createElement('form')
    form.action = (new URL('mturk/externalSubmit', urlParams.get('turkSubmitTo'))).href
    form.method = 'post'

    // attach the assignmentId
    const inputAssignmentId = document.createElement('input')
    inputAssignmentId.name = 'assignmentId'
    inputAssignmentId.value = urlParams.get('assignmentId')
    inputAssignmentId.hidden = true
    form.appendChild(inputAssignmentId)

    // attach data I want to send back
    const inputResults = document.createElement('input')
    inputResults.name = 'results'
    inputResults.value = JSON.stringify(save_record)
    inputResults.hidden = true
    form.appendChild(inputResults)

    // attach the form to the HTML document and trigger submission
    document.body.appendChild(form)
    form.submit()
}

//$('#save').on('click', save_all);
submit.on('click', submit_form);

var popup_alert = function (alert_box, text) {
    alert_box.html(text);
    alert_box.css({
        'background-color': 'fec5bb',
        'padding': '5px',
        'border': '1px solid lightgray',
        'border-radius': '10px',
        'margin-top': '10px',
        'margin-bottom': '10px'
    });
    displaying = true;
    setTimeout(function () {
        alert_box.html('');
        alert_box.css({
            'padding': '0px',
            'border': '0px'
        });
        displaying = false;
    }, 7000);
};

const selectA = $('#selectA');
const selectB = $('#selectB');

const tupleSelect = $('#tuple-select');


function makeSelectionOptions() {
    if (strategy === 'A') {
        tupleSelect.empty();
        events_data.forEach(function (ei, i) {
            events_data.forEach(function (ej, j) {
                if (i >= j) return;
                const opt = $('<option>')
                    .attr({
                        value: `${i},${j}`,
                    })
                    .text(`${describeEvent(ei)} & ${describeEvent(ej)}`);
                tupleSelect.append(opt);
            });
        });
        tupleSelect.children()[0].selected = true;
    } else {
        tupleSelect.empty();
        function describeEventById(id) {
            const event = events_data.find(e => e.event_id === id);
            return describeEvent(event);
        }
        strategyB_tuples.forEach(function (tuple, i) {
            const opt = $('<option>')
                .attr({
                    value: i,
                })
                .text(`${describeEventById(tuple[0])}, ${describeEventById(tuple[1])}, ${describeEventById(tuple[2])}`);
            tupleSelect.append(opt);
        });
        tupleSelect.children()[0].selected = true;
    }
}

selectA.on('click', function () {
    if (strategy === 'A') return;
    strategy = 'A';
    $('#strategyA').show();
    select_button(selectA);
    $('#strategyB').hide();
    deselect_button(selectB);
    makeSelectionOptions();
    makeDom();
    show();
});

selectB.on('click', function () {
    if (strategy === 'B') return;
    strategy = 'B';
    $('#strategyA').hide();
    deselect_button(selectA);
    $('#strategyB').show();
    select_button(selectB);
    makeSelectionOptions();
    makeDom();
    show();
});

selectA.click();

tupleSelect.on('change', function () {
    makeDom();
    show();
});

$('#developer-mode').on('change', function () {
    developer_mode = this.checked;
    makeSelectionOptions();
    makeDom();
    show();
});

// Instructions expand/collapse
var content = $('#instructionBody');
var instructions_trigger = $('#collapseTrigger');
// content.hide();
$('.collapse-text').text('(Click to collapse)');
instructions_trigger.click(function () {
    content.toggle();
    var isVisible = content.is(':visible');
    if (isVisible) {
        $('.collapse-text').text('(Click to collapse)');
    } else {
        $('.collapse-text').text('(Click to expand)');
    }
});

console.log(save_record)
show();
</script>
</crowd-form>