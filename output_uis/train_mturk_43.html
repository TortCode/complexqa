<crowd-form answer-format="flatten-objects">
  <section class="container-fluid" id="Relevancy">
    <div class="row">
      <div class="col-xs-12 col-md-12">
        <div class="panel panel-primary">
          <a class="panel-heading" href="javascript:void(0);" id="collapseTrigger">
            <strong>Annotation Instructions</strong>
            <span class="collapse-text">(Click to expand)</span>
          </a>
          <div class="panel-body" id="instructionBody">
            {{INSTRUCTIONS}}
            {{LINK}}
          </div>
        </div>
      </div>
    </div>

    Enable developer mode:
    <input type="checkbox" id="developer-mode">

    <h3>Document</h3>
    <div id="document-text" class="ann well well-sm">
      Counting civilian casualties in CIA’s drone war A report <trigger id='trigger-0'>released</trigger> in September by human rights <role id='role-0-Communicator-0'trigno='0'>researchers</role> at Stanford Law School and New York University Law School sets out to demonstrate that U. S. drone policies are"damaging and counterproductive."Media <trigger id='trigger-1'>outlets</trigger> from <role id='role-1-Communicator-0'trigno='1'>CNN</role> to <role id='role-1-Communicator-1'trigno='1'>BBC</role> hailed the <role id='role-1-Topic-0'trigno='1'>report</role> as new evidence of the U. S. government’s false narrative on drones and the New York Times ‘ Scott Shane described the study as"among the most thorough on the subject to date."While the Stanford-NYU report certainly <trigger id='trigger-2'>presents</trigger> a comprehensive review of existing drone <role id='role-2-Subject-0'trigno='2'>research</role>, its new contributions to the evidentiary record are far more modest than its sweeping conclusions would suggest. Number Crunching The U. S. <role id='role-3-Communicator-0'trigno='3'>government</role> <trigger id='trigger-3'>claims</trigger> that civilian casualties caused by drones are in the"single digits"during Obama’s years in office, while the Stanford-NYU report <trigger id='trigger-4'>seeks</trigger> to establish that there is significant <role id='role-4-Subject-0'trigno='4'>evidence</role> that U. S. drone strikes have <trigger id='trigger-5'>killed</trigger> and <trigger id='trigger-6'>injured</trigger> a larger number of <role id='role-6-Victim-0'trigno='6'><role id='role-5-Victim-0'trigno='5'>civilians</role></role>. This is a low bar, and would merely necessitate proving that more than 10 <role id='role-7-Victim-0'trigno='7'>civilians</role> have been <trigger id='trigger-7'>killed</trigger> by drones since Obama assumed office, a claim that has been made by all three major databases aggregating information on drone strikes. The <role id='role-8-Communicator-1'trigno='8'>Stanford</role>-<role id='role-8-Communicator-0'trigno='8'>NYU</role> report goes further, <trigger id='trigger-8'>claiming</trigger> that between 474 and 881 <role id='role-9-Victim-0'trigno='9'>civilians</role> have been <trigger id='trigger-9'>killed</trigger> since 2004. However, this does not represent new evidence. Stanford and NYU researchers made no attempt to offer new statistical analysis on the number of civilian casualties caused by drones. Rather, their report is essentially an extended endorsement of a database compiled by The Bureau of Investigative Journalism, a small team of journalists based out of City University, London. In doing so, the report rejects the findings of two other widely cited databases, The <role id='role-10-Communicator-0'trigno='10'>Long War Journal</role>, which <trigger id='trigger-10'>reports</trigger> 138 <role id='role-11-Victim-0'trigno='11'>civilian</role> <trigger id='trigger-11'>deaths</trigger> and New America Foundation’s Year of the Drone, which lists 152-191 <role id='role-12-Victim-0'trigno='12'>civilian</role> <trigger id='trigger-12'>deaths</trigger> and the <trigger id='trigger-13'>deaths</trigger> of 130-268"<role id='role-13-Victim-0'trigno='13'>unknowns</role>."If the Stanford-NYU team wants to paint a picture of the U. S. as a human rights abuser, then the Bureau, whose casualty statistics dwarf the more conservative estimates of the other databases, is best suited to that purpose, but that does not make it the most reliable source. While a comprehensive <trigger id='trigger-14'>assessment</trigger> of the Bureau’s <role id='role-14-Subject-0'trigno='14'>data</role> should have been conducted before giving it a resounding endorsement, just a cursory review of its account of 2012’s drone strikes reveals problems:–On May 5, 2012 the <role id='role-15-Communicator-0'trigno='15'>Bureau</role> <trigger id='trigger-15'>reports</trigger> that a strike in North Waziristan <trigger id='trigger-16'>killed</trigger> 8-10 <role id='role-16-Victim-0'trigno='16'>people</role>, of whom between zero and ten are listed as civilians. Upon reviewing the accompanying sources one find that early reports said the <trigger id='trigger-17'>identity</trigger> of the <role id='role-17-IdentifiedObject-0'trigno='17'>dead</role> could not be determined, but subsequent reports from government <role id='role-18-Identifier-0'trigno='18'>officials</role> <trigger id='trigger-18'>identified</trigger> <role id='role-18-IdentifiedObject-0'trigno='18'>them</role> as <role id='role-18-IdentifiedRole-0'trigno='18'>militants</role>. Of the 15 sources cited by the Bureau, not one states that the victims were civilians.-On June 2, 2012 the <role id='role-19-Communicator-0'trigno='19'>Bureau</role> <trigger id='trigger-19'>reports</trigger> that 2-4 <role id='role-20-Victim-0'trigno='20'>people</role> were <trigger id='trigger-20'>killed</trigger> and between zero and two of them were civilians. These civilian deaths were inferred based on a report that a motorbike was accidentally hit, but the Bureau fails to take note of a later report from The Express Tribune <trigger id='trigger-21'>identifying</trigger> the motorbike <role id='role-21-IdentifiedObject-0'trigno='21'>victims</role> as suspected militants Khalil Yargul Khail and Rehmanullah Gangi Khail.-On July 23, 2012 the Bureau references 25 sources for a drone strike, only one of which described the victims as local residents and based on this the Bureau reports that up to 14 <role id='role-22-Victim-0'trigno='22'>civilians</role> were <trigger id='trigger-22'>killed</trigger>. The <role id='role-23-Communicator-1'trigno='23'>Stanford</role>-<role id='role-23-Communicator-0'trigno='23'>NYU</role> report <trigger id='trigger-23'>critiques</trigger> the <role id='role-24-Identifier-0'trigno='24'>Long War Journal</role> for not making its data available in a verifiable strike-by-strike format, over-relying on U. S. intelligence sources, and <trigger id='trigger-24'>identifying</trigger> all <role id='role-24-IdentifiedObject-0'trigno='24'>victims</role> as <role id='role-24-IdentifiedRole-0'trigno='24'>militants</role> unless they are specifically identified as civilians. These are reasonable criticisms, but when the critique turns to New America Foundation research, it becomes logically inconsistent. While Stanford-NYU <role id='role-25-Communicator-0'trigno='25'>researchers</role> <trigger id='trigger-25'>admit</trigger> that all three databases rely on"the same universe of publicly available press reports,"<role id='role-26-Communicator-0'trigno='26'>they</role> <trigger id='trigger-26'>criticize</trigger> only the New America Foundation for over-relying on the anonymous Pakistani government officials cited in such news reports. The Stanford-NYU report laments that these officials are cited in 88% of articles referenced in New America’s 2012 data but fails to consider that these same articles are referenced by the Bureau. Furthermore, the only reason the researchers were able to generate that statistic is because New America compiles a highly transparent summary of media sources relied on for each strike with a list of which sources reported which casualty estimates, something no other database provides. The Stanford-NYU report goes on to question the"deep reporting"capabilities of New America’s sources (The New York Times, Reuters, AP, BBC, etc. ) while uncritically accepting the veracity of reports from fringe outlets such as the Kuwait News Agency, the South Asian News Agency, Central Asia Online, and Punjab News, which are sometimes the sole sources for the Bureau’s reports of civilian casualties. This is not to suggest that the Bureau’s research is without merit, but it should be noted that it represents an interpretation of the facts with a bias toward reporting civilian casualties. The Bureau’s database does not even have a category for reporting militant deaths. It seems counter-intuitive that the organization’s researchers can have such absolute faith in their civilian casualty estimates, but not have the confidence to label any of the deceased as militants. And the Stanford-NYU team was not impartial. By the report’s own admission, the research project it undertook in Pakistan to <trigger id='trigger-27'>interview</trigger> family <role id='role-27-Participant-0'trigno='27'><role id='role-27-Participant-0'trigno='27'>members</role></role> of drone strike victims was commissioned by <role id='role-27-Participant-1'trigno='27'><role id='role-27-Participant-1'trigno='27'>Reprieve</role></role>, a UK based advocacy organization. Reprieve, which filed two lawsuits on behalf of alleged drone victims in May of 2012, arranged, paid for and collaborated on many of the <role id='role-28-Participant-1'trigno='28'><role id='role-28-Participant-1'trigno='28'>victim</role></role> interviews <trigger id='trigger-28'>conducted</trigger> by the Stanford-NYU <role id='role-28-Participant-0'trigno='28'><role id='role-28-Participant-0'trigno='28'>researchers</role></role>. No database is perfect, but a strong argument could be made that the New America Foundation’s policy of attempting to identify both militants and civilians while maintaining an explicit category for"unknowns"to represent the uncertainty surrounding many of the strikes is a more balanced representation of the facts. After all, if the public is to assess the efficacy of drone strikes then we need to consider the strikes that hit their targets as well as the ones that do not. <role id='role-29-Researcher-1'trigno='29'>Stanford</role> and <role id='role-29-Researcher-0'trigno='29'>NYU</role>’s <trigger id='trigger-29'>analysis</trigger> of the three drone <role id='role-29-Subject-0'trigno='29'>databases</role>, in some respects, misses the forest for the trees. A comparison of the annual data collected by the Bureau with that compiled by the New America Foundation suggests that while their numbers may differ, their underlying findings are substantially similar. Both the <role id='role-30-Observer-1'trigno='30'>Bureau</role> and <role id='role-30-Observer-0'trigno='30'>New America</role> have <trigger id='trigger-30'>observed</trigger> a general decline in the percentage of civilian fatalities since the high in 2006, with a sharp decrease during the Obama administration. According to the Bureau’s data, the proportion of <role id='role-31-Victim-0'trigno='31'>civilians</role> <trigger id='trigger-31'>killed</trigger> in drone strikes fell from 35 percent in 2008 under President Bush to 9 percent thus far in 2012. Similarly, <role id='role-32-Communicator-0'trigno='32'>New America</role> <trigger id='trigger-32'>reports</trigger> that the rate of civilian and unknown casualties decreased from 23 percent in 2008 to 2 percent in 2012. This stands to reason when we consider that the Bureau tends to err on the side of assuming that unidentified dead or individuals of disputed identity are civilians, while New America prefers to accommodate ambiguity by listing"unknowns"and only reports a civilian or militant casualty when it is reported by two independent sources. If one takes the average number of civilian and unknown deaths counted by the New America Foundation from 2004-2012 as a percentage of the total number of <role id='role-33-Victim-0'trigno='33'>people</role> <trigger id='trigger-33'>killed</trigger> in drone strikes, the civilian and unknown deaths represent 15 percent of the total. The Bureau’s data suggests that civilian deaths account for 22 percent of the total killed. These numbers are in fact, not so very far apart. And while the Bureau has criticized New America for reporting that in 2012, <role id='role-34-Victim-0'trigno='34'>civilian</role> <trigger id='trigger-34'>deaths</trigger> are approaching zero, the Bureau’s own data suggests that the percentage of civilian casualties in 2012 is at nine percent, an all-time low and significantly less than the 23 percent the Bureau reports during Obama’s first year in office. This suggests that the choice is not between two very different data sets, but rather two different interpretations of similar evidence. Contrary to the Stanford-NYU report’s claims, the New America Foundation is not underreporting civilian casualties; its researchers have simply chosen not to feign certainty in the face of ambiguity. What They Didn’t Say The Stanford-NYU researchers also fail to incorporate evidence that might temper their claims. Their report makes numerous references to an AP investigative report that interviewed 80 villagers at the sites of the ten deadliest attacks in 2011 and 2012 but neglects its conclusions that"a significant majority of the dead were combatants"and the numbers of casualties gathered by AP investigators"turned out to be very close to those given by Pakistani intelligence on the day of each strike."Numerous media accounts, including the LA Times, have highlighted that"the [Stanford-NYU] study concludes that only about 2 percent of drone casualties are top militant leaders."The study reached no such conclusion. This claim is based on research conducted by New America and published last month on CNN. While the Stanford-NYU report summarily dismissed New America’s militant and civilian casualty estimates, they have been quick to make this statistic a centerpiece of their argument. In doing so, they also take the conclusion out of context, and ignore the possible tactical utility of deliberately targeting low-level militants. Indeed, <trigger id='trigger-35'>destroying</trigger> communication <role id='role-35-Artifact-0'trigno='35'>centers</role>, training <role id='role-35-Artifact-1'trigno='35'>camps</role> and <role id='role-35-Artifact-2'trigno='35'>vehicles</role> undermines the operational effectiveness of al-Qaeda and the Taliban, and quotes from operatives of the Pakistan-based Haqqani Network reveal that drones have forced them into a"jungle existence"where they fear for the lives on a daily basis. A second key contention of the Stanford-NYU report is that drone strikes are"damaging and counterproductive"to U. S. national security. However, it is shortsighted to evaluate U. S. security in isolation from Pakistani domestic order. Terrorist attacks have been a pervasive problem in Pakistan, especially since 2007. While the report references these attacks and the frequent assassinations carried out by Taliban forces, it makes no reference to recent research by an analyst at the RAND Corporation, <role id='role-36-Identifier-0'trigno='36'>who</role> <trigger id='trigger-36'>identifies</trigger> a negative correlation between drone strikes and militant violence inside Pakistan, indicating that the rate of violence has gone down as the rate of drone strikes has gone up. Analysis by New America suggests that while only 10 percent of drone strikes target al-Qaeda operatives, approximately 50 percent hit Taliban targets and in 2009, 19 of the first 32 drone strikes targeted the organization of Baitullah Mehsud, the leader of the Pakistani Taliban who was ultimately responsible for the deaths of thousands of Pakistanis, and the alleged mastermind of the assassination of former Pakistani Prime Minister Benazir Bhutto. Mehsud was a far greater threat to Pakistani security than that of the United States. Key Findings These criticisms are not to suggest that the Stanford-NYU report is without merit. The anecdotal evidence on the adverse mental health impact of drones, the economic hardships created by attacks and the restriction of movement caused by FATA residents’anxiety about potential strikes are all valuable contributions to the public’s understanding of drones, as is the report’s succinct and cogent summary of some of the key legal issues. Both of these topics merit further research and the teams at Stanford and NYU seem well poised to continue contributing in these areas. However it would be a mistake to unequivocally accept all of the report’s conclusions or its stance on the civilian casualty debate. The U. S. government’s claims that civilian casualties from drone strikes during Obama’s term in office are in the single digits are manifestly untrue, but there is no need to overstate the rate of civilian deaths to make the point that drones strikes are legally suspect and morally hazardous. Meg Braun is a Rhodes Scholar and MPhil candidate in International Relations at Oxford, where she is researching the evolution of U. S. drone policy. She was an intern at the New America Foundation during summer 2012, where she worked to revise and update its drone database. 
    </div>

    <div id='events-data' hidden>
      [{"event_id": "wiki_drone_strikes_0_news_10-E17", "text": "released", "offset": 11, "length": 1, "template": "[Communicator] communicated to [Recipient] about [Topic] topic using [Instrument] at [Place] place (one-way communication)", "role_text_map": [{"role": "Communicator", "tokens": [{"text": "researchers", "entity_id": "wiki_drone_strikes_0_news_10-T5", "offset": 17, "length": 1}]}, {"role": "Recipient", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "Topic", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E1", "text": "outlets", "offset": 47, "length": 1, "template": "[Communicator] communicated to [Recipient] about [Topic] topic using [Instrument] at [Place] place (one-way communication)", "role_text_map": [{"role": "Communicator", "tokens": [{"text": "CNN", "entity_id": "wiki_drone_strikes_0_news_10-T10", "offset": 49, "length": 1}, {"text": "BBC", "entity_id": "wiki_drone_strikes_0_news_10-T11", "offset": 51, "length": 1}]}, {"role": "Recipient", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "Topic", "tokens": [{"text": "report", "entity_id": "wiki_drone_strikes_0_news_10-T367", "offset": 54, "length": 1}]}, {"role": "Place", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E19", "text": "presents", "offset": 102, "length": 1, "template": "[Researcher] researched [Subject] subject using [Means] at [Place] place", "role_text_map": [{"role": "Researcher", "tokens": []}, {"role": "Subject", "tokens": [{"text": "research", "entity_id": "wiki_drone_strikes_0_news_10-T388", "offset": 109, "length": 1}]}, {"role": "Means", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E25", "text": "claims", "offset": 137, "length": 1, "template": "[Communicator] communicated to [Recipient] about [Topic] topic using [Instrument] at [Place] place (one-way communication)", "role_text_map": [{"role": "Communicator", "tokens": [{"text": "government", "entity_id": "wiki_drone_strikes_0_news_10-T23", "offset": 136, "length": 1}]}, {"role": "Recipient", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "Topic", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E20", "text": "seeks", "offset": 165, "length": 1, "template": "[Researcher] researched [Subject] subject using [Means] at [Place] place", "role_text_map": [{"role": "Researcher", "tokens": []}, {"role": "Subject", "tokens": [{"text": "evidence", "entity_id": "wiki_drone_strikes_0_news_10-T390", "offset": 172, "length": 1}]}, {"role": "Means", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E2", "text": "killed", "offset": 181, "length": 1, "template": "[Victim] died at [Place] place from [MedicalIssue] medical issue, killed by [Killer] killer", "role_text_map": [{"role": "Victim", "tokens": [{"text": "civilians", "entity_id": "wiki_drone_strikes_0_news_10-T32", "offset": 188, "length": 1}]}, {"role": "Place", "tokens": []}, {"role": "Killer", "tokens": []}, {"role": "MedicalIssue", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E3", "text": "injured", "offset": 183, "length": 1, "template": "[Victim] was infected with [InfectingAgent] from [Source] at [Place] place", "role_text_map": [{"role": "Victim", "tokens": [{"text": "civilians", "entity_id": "wiki_drone_strikes_0_news_10-T32", "offset": 188, "length": 1}]}, {"role": "InfectingAgent", "tokens": []}, {"role": "Source", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E4", "text": "killed", "offset": 208, "length": 1, "template": "[Victim] died at [Place] place from [MedicalIssue] medical issue, killed by [Killer] killer", "role_text_map": [{"role": "Victim", "tokens": [{"text": "civilians", "entity_id": "wiki_drone_strikes_0_news_10-T33", "offset": 205, "length": 1}]}, {"role": "Place", "tokens": []}, {"role": "Killer", "tokens": []}, {"role": "MedicalIssue", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E26", "text": "claiming", "offset": 241, "length": 1, "template": "[Communicator] communicated to [Recipient] about [Topic] topic using [Instrument] at [Place] place (one-way communication)", "role_text_map": [{"role": "Communicator", "tokens": [{"text": "NYU", "entity_id": "wiki_drone_strikes_0_news_10-T38", "offset": 236, "length": 1}, {"text": "Stanford", "entity_id": "wiki_drone_strikes_0_news_10-T37", "offset": 234, "length": 1}]}, {"role": "Recipient", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "Topic", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E5", "text": "killed", "offset": 250, "length": 1, "template": "[Victim] died at [Place] place from [MedicalIssue] medical issue, killed by [Killer] killer", "role_text_map": [{"role": "Victim", "tokens": [{"text": "civilians", "entity_id": "wiki_drone_strikes_0_news_10-T39", "offset": 247, "length": 1}]}, {"role": "Place", "tokens": []}, {"role": "Killer", "tokens": []}, {"role": "MedicalIssue", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E27", "text": "reports", "offset": 340, "length": 1, "template": "[Communicator] communicated to [Recipient] about [Topic] topic using [Instrument] at [Place] place (one-way communication)", "role_text_map": [{"role": "Communicator", "tokens": [{"text": "Long War Journal", "entity_id": "wiki_drone_strikes_0_news_10-T51", "offset": 335, "length": 3}]}, {"role": "Recipient", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "Topic", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E6", "text": "deaths", "offset": 343, "length": 1, "template": "[Victim] died at [Place] place from [MedicalIssue] medical issue, killed by [Killer] killer", "role_text_map": [{"role": "Victim", "tokens": [{"text": "civilian", "entity_id": "wiki_drone_strikes_0_news_10-T53", "offset": 342, "length": 1}]}, {"role": "Place", "tokens": []}, {"role": "Killer", "tokens": []}, {"role": "MedicalIssue", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E7", "text": "deaths", "offset": 361, "length": 1, "template": "[Victim] died at [Place] place from [MedicalIssue] medical issue, killed by [Killer] killer", "role_text_map": [{"role": "Victim", "tokens": [{"text": "civilian", "entity_id": "wiki_drone_strikes_0_news_10-T55", "offset": 360, "length": 1}]}, {"role": "Place", "tokens": []}, {"role": "Killer", "tokens": []}, {"role": "MedicalIssue", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E8", "text": "deaths", "offset": 364, "length": 1, "template": "[Victim] died at [Place] place from [MedicalIssue] medical issue, killed by [Killer] killer", "role_text_map": [{"role": "Victim", "tokens": [{"text": "unknowns", "entity_id": "wiki_drone_strikes_0_news_10-T56", "offset": 370, "length": 1}]}, {"role": "Place", "tokens": []}, {"role": "Killer", "tokens": []}, {"role": "MedicalIssue", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E13", "text": "assessment", "offset": 434, "length": 1, "template": "[Researcher] researched [Subject] subject using [Means] at [Place] place", "role_text_map": [{"role": "Researcher", "tokens": []}, {"role": "Subject", "tokens": [{"text": "data", "entity_id": "wiki_drone_strikes_0_news_10-T381", "offset": 440, "length": 1}]}, {"role": "Means", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E28", "text": "reports", "offset": 476, "length": 1, "template": "[Communicator] communicated to [Recipient] about [Topic] topic using [Instrument] at [Place] place (one-way communication)", "role_text_map": [{"role": "Communicator", "tokens": [{"text": "Bureau", "entity_id": "wiki_drone_strikes_0_news_10-T69", "offset": 475, "length": 1}]}, {"role": "Recipient", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "Topic", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E9", "text": "killed", "offset": 483, "length": 1, "template": "[Victim] died at [Place] place from [MedicalIssue] medical issue, killed by [Killer] killer", "role_text_map": [{"role": "Victim", "tokens": [{"text": "people", "entity_id": "wiki_drone_strikes_0_news_10-T71", "offset": 487, "length": 1}]}, {"role": "Place", "tokens": []}, {"role": "Killer", "tokens": []}, {"role": "MedicalIssue", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E21", "text": "identity", "offset": 512, "length": 1, "template": "[Identifier] identified [IdentifiedObject] as [IdentifiedRole] at [Place] place", "role_text_map": [{"role": "Identifier", "tokens": []}, {"role": "IdentifiedObject", "tokens": [{"text": "dead", "entity_id": "wiki_drone_strikes_0_news_10-T78", "offset": 515, "length": 1}]}, {"role": "IdentifiedRole", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E29", "text": "identified", "offset": 527, "length": 1, "template": "[Identifier] identified [IdentifiedObject] as [IdentifiedRole] at [Place] place", "role_text_map": [{"role": "Identifier", "tokens": [{"text": "officials", "entity_id": "wiki_drone_strikes_0_news_10-T80", "offset": 526, "length": 1}]}, {"role": "IdentifiedObject", "tokens": [{"text": "them", "entity_id": "wiki_drone_strikes_0_news_10-T81", "offset": 528, "length": 1}]}, {"role": "IdentifiedRole", "tokens": [{"text": "militants", "entity_id": "wiki_drone_strikes_0_news_10-T82", "offset": 530, "length": 1}]}, {"role": "Place", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E30", "text": "reports", "offset": 558, "length": 1, "template": "[Communicator] communicated to [Recipient] about [Topic] topic using [Instrument] at [Place] place (one-way communication)", "role_text_map": [{"role": "Communicator", "tokens": [{"text": "Bureau", "entity_id": "wiki_drone_strikes_0_news_10-T88", "offset": 557, "length": 1}]}, {"role": "Recipient", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "Topic", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E10", "text": "killed", "offset": 565, "length": 1, "template": "[Victim] died at [Place] place from [MedicalIssue] medical issue, killed by [Killer] killer", "role_text_map": [{"role": "Victim", "tokens": [{"text": "people", "entity_id": "wiki_drone_strikes_0_news_10-T89", "offset": 563, "length": 1}]}, {"role": "Place", "tokens": []}, {"role": "Killer", "tokens": []}, {"role": "MedicalIssue", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E22", "text": "identifying", "offset": 607, "length": 1, "template": "[Identifier] identified [IdentifiedObject] as [IdentifiedRole] at [Place] place", "role_text_map": [{"role": "Identifier", "tokens": []}, {"role": "IdentifiedObject", "tokens": [{"text": "victims", "entity_id": "wiki_drone_strikes_0_news_10-T98", "offset": 610, "length": 1}]}, {"role": "IdentifiedRole", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E11", "text": "killed", "offset": 661, "length": 1, "template": "[Victim] died at [Place] place from [MedicalIssue] medical issue, killed by [Killer] killer", "role_text_map": [{"role": "Victim", "tokens": [{"text": "civilians", "entity_id": "wiki_drone_strikes_0_news_10-T109", "offset": 659, "length": 1}]}, {"role": "Place", "tokens": []}, {"role": "Killer", "tokens": []}, {"role": "MedicalIssue", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E31", "text": "critiques", "offset": 668, "length": 1, "template": "[Communicator] communicated to [Recipient] about [Topic] topic using [Instrument] at [Place] place (one-way communication)", "role_text_map": [{"role": "Communicator", "tokens": [{"text": "NYU", "entity_id": "wiki_drone_strikes_0_news_10-T111", "offset": 666, "length": 1}, {"text": "Stanford", "entity_id": "wiki_drone_strikes_0_news_10-T110", "offset": 664, "length": 1}]}, {"role": "Recipient", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "Topic", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E23", "text": "identifying", "offset": 701, "length": 1, "template": "[Identifier] identified [IdentifiedObject] as [IdentifiedRole] at [Place] place", "role_text_map": [{"role": "Identifier", "tokens": [{"text": "Long War Journal", "entity_id": "wiki_drone_strikes_0_news_10-T112", "offset": 670, "length": 3}]}, {"role": "IdentifiedObject", "tokens": [{"text": "victims", "entity_id": "wiki_drone_strikes_0_news_10-T116", "offset": 703, "length": 1}]}, {"role": "IdentifiedRole", "tokens": [{"text": "militants", "entity_id": "wiki_drone_strikes_0_news_10-T117", "offset": 705, "length": 1}]}, {"role": "Place", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E32", "text": "admit", "offset": 740, "length": 1, "template": "[Communicator] communicated to [Recipient] about [Topic] topic using [Instrument] at [Place] place (one-way communication)", "role_text_map": [{"role": "Communicator", "tokens": [{"text": "researchers", "entity_id": "wiki_drone_strikes_0_news_10-T123", "offset": 739, "length": 1}]}, {"role": "Recipient", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "Topic", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E33", "text": "criticize", "offset": 759, "length": 1, "template": "[Communicator] communicated to [Recipient] about [Topic] topic using [Instrument] at [Place] place (one-way communication)", "role_text_map": [{"role": "Communicator", "tokens": [{"text": "they", "entity_id": "wiki_drone_strikes_0_news_10-T124", "offset": 758, "length": 1}]}, {"role": "Recipient", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "Topic", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E14", "text": "interview", "offset": 1063, "length": 1, "template": "[Participant] met face-to-face with [Participant] about [Topic] topic at [Place] place", "role_text_map": [{"role": "Participant", "tokens": [{"text": "members", "entity_id": "wiki_drone_strikes_0_news_10-T173", "offset": 1065, "length": 1}, {"text": "Reprieve", "entity_id": "wiki_drone_strikes_0_news_10-T176", "offset": 1073, "length": 1}]}, {"role": "Participant", "tokens": [{"text": "members", "entity_id": "wiki_drone_strikes_0_news_10-T173", "offset": 1065, "length": 1}, {"text": "Reprieve", "entity_id": "wiki_drone_strikes_0_news_10-T176", "offset": 1073, "length": 1}]}, {"role": "Topic", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E34", "text": "conducted", "offset": 1110, "length": 1, "template": "[Participant] met face-to-face with [Participant] about [Topic] topic at [Place] place", "role_text_map": [{"role": "Participant", "tokens": [{"text": "researchers", "entity_id": "wiki_drone_strikes_0_news_10-T186", "offset": 1116, "length": 1}, {"text": "victim", "entity_id": "wiki_drone_strikes_0_news_10-T183", "offset": 1108, "length": 1}]}, {"role": "Participant", "tokens": [{"text": "researchers", "entity_id": "wiki_drone_strikes_0_news_10-T186", "offset": 1116, "length": 1}, {"text": "victim", "entity_id": "wiki_drone_strikes_0_news_10-T183", "offset": 1108, "length": 1}]}, {"role": "Topic", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E12", "text": "analysis", "offset": 1212, "length": 1, "template": "[Researcher] researched [Subject] subject using [Means] at [Place] place", "role_text_map": [{"role": "Researcher", "tokens": [{"text": "NYU", "entity_id": "wiki_drone_strikes_0_news_10-T195", "offset": 1209, "length": 1}, {"text": "Stanford", "entity_id": "wiki_drone_strikes_0_news_10-T194", "offset": 1207, "length": 1}]}, {"role": "Subject", "tokens": [{"text": "databases", "entity_id": "wiki_drone_strikes_0_news_10-T379", "offset": 1217, "length": 1}]}, {"role": "Means", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E35", "text": "observed", "offset": 1270, "length": 1, "template": "[Observer] observed [ObservedEntity] using [Instrument] in [Place] place", "role_text_map": [{"role": "Observer", "tokens": [{"text": "New America", "entity_id": "wiki_drone_strikes_0_news_10-T203", "offset": 1267, "length": 2}, {"text": "Bureau", "entity_id": "wiki_drone_strikes_0_news_10-T202", "offset": 1265, "length": 1}]}, {"role": "ObservedEntity", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E36", "text": "killed", "offset": 1307, "length": 1, "template": "[Victim] died at [Place] place from [MedicalIssue] medical issue, killed by [Killer] killer", "role_text_map": [{"role": "Victim", "tokens": [{"text": "civilians", "entity_id": "wiki_drone_strikes_0_news_10-T208", "offset": 1306, "length": 1}]}, {"role": "Place", "tokens": []}, {"role": "Killer", "tokens": []}, {"role": "MedicalIssue", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E37", "text": "reports", "offset": 1332, "length": 1, "template": "[Communicator] communicated to [Recipient] about [Topic] topic using [Instrument] at [Place] place (one-way communication)", "role_text_map": [{"role": "Communicator", "tokens": [{"text": "New America", "entity_id": "wiki_drone_strikes_0_news_10-T212", "offset": 1330, "length": 2}]}, {"role": "Recipient", "tokens": []}, {"role": "Instrument", "tokens": []}, {"role": "Topic", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E24", "text": "killed", "offset": 1441, "length": 1, "template": "[Victim] died at [Place] place from [MedicalIssue] medical issue, killed by [Killer] killer", "role_text_map": [{"role": "Victim", "tokens": [{"text": "people", "entity_id": "wiki_drone_strikes_0_news_10-T226", "offset": 1440, "length": 1}]}, {"role": "Place", "tokens": []}, {"role": "Killer", "tokens": []}, {"role": "MedicalIssue", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E15", "text": "deaths", "offset": 1503, "length": 1, "template": "[Victim] died at [Place] place from [MedicalIssue] medical issue, killed by [Killer] killer", "role_text_map": [{"role": "Victim", "tokens": [{"text": "civilian", "entity_id": "wiki_drone_strikes_0_news_10-T234", "offset": 1502, "length": 1}]}, {"role": "Place", "tokens": []}, {"role": "Killer", "tokens": []}, {"role": "MedicalIssue", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E16", "text": "destroying", "offset": 1824, "length": 1, "template": "[Destroyer] destroyed [Artifact] using [Instrument] instrument in [Place] place", "role_text_map": [{"role": "Destroyer", "tokens": []}, {"role": "Artifact", "tokens": [{"text": "centers", "entity_id": "wiki_drone_strikes_0_news_10-T283", "offset": 1826, "length": 1}, {"text": "camps", "entity_id": "wiki_drone_strikes_0_news_10-T284", "offset": 1829, "length": 1}, {"text": "vehicles", "entity_id": "wiki_drone_strikes_0_news_10-T285", "offset": 1831, "length": 1}]}, {"role": "Instrument", "tokens": []}, {"role": "Place", "tokens": []}]}, {"event_id": "wiki_drone_strikes_0_news_10-E18", "text": "identifies", "offset": 1971, "length": 1, "template": "[Identifier] identified [IdentifiedObject] as [IdentifiedRole] at [Place] place", "role_text_map": [{"role": "Identifier", "tokens": [{"text": "who", "entity_id": "wiki_drone_strikes_0_news_10-T307", "offset": 1970, "length": 1}]}, {"role": "IdentifiedObject", "tokens": []}, {"role": "IdentifiedRole", "tokens": []}, {"role": "Place", "tokens": []}]}]
    </div>

    <div id='relations-data' hidden>
      []
    </div>

    <div id="strategyB-tuples" hidden>
      ${strategyB-tuples}
    </div>

    <p>
      You can navigate all of the events by clicking the following buttons. <br>
      You have to finish all the events before submitting. (Remember that you can't refresh the page otherwise
      the progress will be gone, <br>
      to prevent this from happening, we suggest that you write the QA pairs in the google doc and copy paste them
      here)
    </p>
    <!-- Tabs for each trigger -->
    <div class="btn-toolbar" id="button-bar">
    </div>

    <div class="strategies">
      <span id="strategy-btns">
        <button id="selectA" class="btn btn-default" type="button">
          Strategy A</button>
        <button id="selectB" class="btn btn-default" type="button">
          Strategy B</button>
      </span>
      <select id="tuple-select">
      </select>
      <div class="ann-component">
        <em>
          KAIROS event arguments for triggers
        </em>
        <div id='template-area' class='ann well well-sm'>
        </div>
      </div>
      <div class="strategy" id="strategyA">
        <div class="ann-component">
          <em>
            These are relations between events.
          </em>
          <div id='relations-area' class='ann well well-sm'>
          </div>
        </div>
      </div>
      <div class="strategy" id="strategyB">
      </div>
    </div>
    <div id="input-area">
    </div>
    <div title="Fill all fields before submitting">
      <button id="save" class="btn btn-default" type="button">Save</button>
      <button id="submitButton" class="btn btn-default" type="button">Submit</button>
    </div>
  </section>


  <link crossorigin="anonymous" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
    integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" rel="stylesheet" />
  <style>.mg-15 {
    margin-left: 15px;
    margin-right: 15px;
}

.mg-5 {
    margin: 5px;
}

.container-fluid {
    max-width: 1800px;
    margin: 30px;
}

.btn-container {
    display: inline-block;
    margin: 10px;
}

.strategies {
    margin: 15px;
}

.ann-component {
    margin: 5px;
}


#collapseTrigger {
    color: #fff;
    display: block;
    text-decoration: none;
}

#submitButton {
    white-space: normal;
}

#input-area {
    display: block;
    margin: 10px;
}

.input-fields {
    margin: 10px;
    padding: 10px;
    background-color: #ffe3e3;
    border-radius: 15px;
}

#template-area {
    background-color: #eee;
    display: flex;
}

#relations-area {
    display: flex;
    flex-direction: column;
    row-gap: 5px;
}

.template-map {
    border: 1px solid gray;
    padding: 5px;
}

.btn-container>button {
    min-width: 3em;
}

trigger {
    display: inline;
}

role {
    display: inline;
}

.highlight-trigger {
    background-color: lightgoldenrodyellow;
}

.highlight-role {
    background-color: lightblue;
}

.highlight-role1 {
    background-color: rgba(255, 255, 0, 0.5);
}

.highlight-role2 {
    background-color: rgba(0, 255, 255, 0.5);
}

.highlight-role3 {
    background-color: rgba(255, 0, 255, 0.5);
}

.btn-group {
    vertical-align: middle;
}

.content {
    margin-bottom: 15px;
}

.ann {
    font-size: 16px;
}

.disp {
    font-size: 20px;
}

.ann>span.token {
    cursor: pointer;
}

.ann>span.token:hover {
    text-decoration: underline;
}

.ann>strong.annotation:hover {
    text-decoration: line-through;
}

input[disabled] {
    color: #000
}

.question-input, .answer-input {
    vertical-align: middle;
}</style>
  <script src="https://code.jquery.com/jquery-3.1.0.min.js"
    integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
    integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>
  <script>// ---------------------------------------------------------
// Global
// ---------------------------------------------------------

var page_num_set = new Set();
let strategy = '';
let developer_mode = false;

// ---------------------------------------------------------
// Create jQuery elements
// ---------------------------------------------------------

var submit = $('#submitButton');

// list of text/offset objects 
const events_data = JSON.parse($('#events-data').text().trim());
const relations_data = JSON.parse($('#relations-data').text().trim());
const strategyB_tuples = [["road_ied_8-E1", "road_ied_8-E2", "road_ied_8-E3"]];//JSON.parse($('#strategyB-tuples').text().trim());

const empty_template_map = function () {
    return $('<div class="template-map">');
}

const save_record = {
    A: {
        relations: relations_data,
        qapairs: [],
    },
    B: {
        qapairs: [],
    },
};

const strategyA_template = function (tno, event1, event2) {
    return {
        question: '',
        answer: '',
    }
}

const template_record = [];
events_data.forEach(function (ei, i) {
    template_record[i] = empty_template_map();
    events_data.forEach(function (ej, j) {
        if (i >= j) return;

        for (let tno = 1; tno <= 4; tno++){
            {
                const { question, answer } = strategyA_template(tno, ei, ej);
                save_record.A.qapairs.push({
                    event1_id: ei.event_id,
                    event2_id: ej.event_id,
                    templateno: tno,
                    question,
                    answer,
                });
            }
            {
                const { question, answer } = strategyA_template(tno, ej, ei);
                save_record.A.qapairs.push({
                    event1_id: ej.event_id,
                    event2_id: ei.event_id,
                    templateno: tno,
                    question,
                    answer,
                });
            }
        }
    });
});

function strategyB_template(event1_id, event2_id, event3_id) {
    const question = 'What is the participant in the event that interviews the transporter that flew the place that gone off the explosive device. ';
    const answer = '';
    return {
        question, answer
    };
}

strategyB_tuples.forEach(function (tuple, i) {
    const { question, answer } = strategyB_template(tuple[0], tuple[1], tuple[2]);
    save_record.B.qapairs.push({
        event1_id: tuple[0],
        event2_id: tuple[1],
        event3_id: tuple[2],
        question,
        answer,
    });
});

// implementation of string formatting
if (!String.prototype.format) {
    String.prototype.format = function () {
        var args = arguments;
        return this.replace(/{(\d+)}/g, function (match, number) {
            return typeof args[number] != 'undefined'
                ? args[number]
                : match
                ;
        });
    };
}

// ---------------------------------------------------------
// Create elements
// ---------------------------------------------------------

var makeDom = function () {
    recoverUserInput();
    console.log(page_num_set);
    highlightEvent();
};

var highlightEvent = function () {
    /* highlight trigger within document */
    const pagenos = Array.from(page_num_set);
    pagenos.sort((a, b) => events_data[a].offset - events_data[b].offset);

    // remove previous highlights
    $('trigger').removeClass('highlight-trigger');
    $('role').removeClass('highlight-role1 highlight-role2 highlight-role3');

    pagenos.forEach(trigger_num => {
        // highlight trigger
        $('#trigger-' + trigger_num).addClass('highlight-trigger');
        $('role[trigno=' + trigger_num + ']').addClass('highlight-role'+(trigger_num+1));
    })
}

const relationTypes = [
    "BEFORE",
    "AFTER",
    "OVERLAPS",
    "EQUAL",
    "CONTAINS",
    "CONTAINED BY",
    "CAUSES",
    "CAUSED BY",
]

// restore input from other trigger
var recoverUserInput = function () {
    const inputArea = $('#input-area');
    inputArea.empty();
    page_num_set.clear();

    let pagenos = [];
    if (strategy === 'A') {
        // questions
        const event_pair = $('#tuple-select').val().split(',').map(x => parseInt(x));
        page_num_set.add(event_pair[0]);
        page_num_set.add(event_pair[1]);

        pagenos = event_pair;
        pagenos.sort((a, b) => events_data[a].offset - events_data[b].offset);

        // relations
        const relationsArea = $('#relations-area');
        relationsArea.empty();
        pagenos.forEach(i => {
            pagenos.forEach(j => {
                if (i >= j) return;

                const event1 = events_data[i];
                const event2 = events_data[j];
                relationsArea.append(makeRelationSelect(event1, event2));
                relationsArea.append(makeRelationSelect(event2, event1));
            })
        })

        const matching_pairs = save_record.A.qapairs.filter(qa => {
            return (
                (qa.event1_id === events_data[event_pair[0]].event_id &&
                qa.event2_id === events_data[event_pair[1]].event_id) ||
                (qa.event1_id === events_data[event_pair[1]].event_id &&
                qa.event2_id === events_data[event_pair[0]].event_id)
            );
        });
        matching_pairs.forEach((qa, i) => {
            add_qa_input(qa.question, qa.answer, qa);
            if (i % 2 === 1 && i < matching_pairs.length - 1)
                inputArea.add($('<hr>'));
        });
    } else if (strategy === 'B') {
        const tuple = save_record.B.qapairs[$('#tuple-select').val()];
        console.log("TUPLE", tuple)
        page_num_set.add(events_data.findIndex(e => e.event_id === tuple.event1_id));
        page_num_set.add(events_data.findIndex(e => e.event_id === tuple.event2_id));
        page_num_set.add(events_data.findIndex(e => e.event_id === tuple.event3_id));
        pagenos = Array.from(page_num_set);
        pagenos.sort((a, b) => events_data[a].offset - events_data[b].offset);
        add_qa_input(tuple.question, tuple.answer, null, false);
        add_qa_input('', '', tuple, true);
    }
    // templates
    const templateArea = $('#template-area');
    templateArea.empty()
    pagenos.forEach(trigger_num => {
        const div = $('<div>')
            .append($('<p>').text(describeEvent(events_data[trigger_num])))
            .append(template_record[trigger_num]);
        templateArea.append(div);
    });
};

function describeEvent(event) {
    return (developer_mode ? `ID: ${event.event_id} | ` : "") + `${event.text} @ ${event.offset}`;
}

function makeRelationSelect(event1, event2) {
    const id1 = event1.event_id;
    const id2 = event2.event_id;
    const relation = relations_data.find(r =>
        r.event1_id == id1 &&
        r.event2_id == id2
    );

    const selectInput =
        $('<select class="relation-select mg-5">');
    relationTypes.forEach(type => {
        const option = $(`<option value="${type}">${type.toLowerCase()}</option>`);
        selectInput.append(option);
    });
    selectInput.append($('<option value="NONE">none</option>'));
    selectInput.val(relation?.type ?? "NONE");
    selectInput.on('change', function () {
        const type = $(this).val();
        const event1_id = id1;
        const event2_id = id2;
        const relation = relations_data.find(r =>
            r.event1_id == event1_id &&
            r.event2_id == event2_id
        );
        if (relation) {
            relation.type = type;
        } else {
            relations_data.push({
                event1_id,
                event2_id,
                type,
            });
        }
    });

    const div = $('<div>')
        .append($('<label>').text(describeEvent(event1)))
        .append(selectInput)
        .append($('<label>').text(describeEvent(event2)))

    return div;
}

// ensure something is in the input box
var canSubmit = function () {
    return true;
};

// template role fields
const make_role_mapping_element = function (role, text) {
    const role_text = $('<label>').html('<b>' + role + '</b>:');
    const role_field = $('<span>')
        .addClass('role-field')
        .attr({
            role: role,
            rows: 1,
        })
        .text(text)

    const role_div = $('<div>')
        .addClass('role-container')
        .append(role_text)
        .append(role_field);

    return role_div;
}


const add_qa_input = function (question = '', answer = '', ref = null, editable = true) {
    let question_text = $('<label>').text('question:');
    let question_input = $('<textarea>')
        .addClass('question-input')
        .addClass('mg-15')
        .attr({
            placeholder: 'write down your question',
            rows: 2,
            cols: 80,
        })
        .text(question);
    question_input.on("input", function () {
        console.log('q', ref)
        if (ref != null)
            ref.question = $(this).val();
        show();
    });
    let answer_text = $('<label>').text('answer:');
    let answer_input = $('<textarea>')
        .addClass('answer-input')
        .addClass('mg-15')
        .attr({
            placeholder: 'write down your answer',
            rows: 2,
            cols: 80,
        })
        .text(answer);
    answer_input.on("input", function () {
        console.log('a', ref)
        if (ref != null)
            ref.answer = $(this).val();
        show();
    });

    if (!editable) {
        question_input.attr('disabled', 'disabled');
        answer_input.attr('disabled', 'disabled');
    }

    const input_fields = $('<div>')
        .addClass('input-fields')
        .append(question_text)
        .append(question_input)
        .append(answer_text)
        .append(answer_input)

    $('#input-area').append(input_fields);

    show();
};

var enable_button = function (button) {
    button.removeAttr("disabled");
    button.removeClass("btn-default");
    button.addClass("btn-success");
};

var disable_button = function (button) {
    button.attr("disabled", "disabled");
    button.removeClass("btn-success");
    button.addClass("btn-default");
};

var select_button = function (button) {
    button.removeClass("btn-default");
    button.addClass("btn-primary");
};

var deselect_button = function (button) {
    button.removeClass("btn-primary");
    button.addClass("btn-default");
};

var is_wh_question = function (question) {
    let tokens = question.split(' ');
    if (tokens.length <= 1) {
        return false;
    }

    // let wh_pattern = /^Wh\|wh\|How\|how/;
    let wh_pattern = /^wh|Wh|how|How/;
    // console.log(question.match(wh_pattern));
    return !!question.match(wh_pattern);
};


var show = function () {
    for (button of document.getElementById('button-bar').getElementsByTagName('*')) {
        if (page_num_set.has(parseInt(button.getAttribute('page-no'))))
            select_button($(button));
        else
            deselect_button($(button));
    }

};

// dynamically create buttons for each SRL arg
events_data.forEach(function (event, i) {
    if (event.text.trim()) {
        var button = document.createElement("button");
        button.setAttribute("type", "button");
        button.setAttribute("id", "button-page-" + i);
        button.setAttribute("page-no", i);
        button.setAttribute("class", "btn btn-default");
        button.innerHTML = describeEvent(event);
        button.onclick = function () {
            // const pageno = parseInt(this.getAttribute("page-no"));
            // // toggle button
            // if (button.classList.contains('btn-default'))
            //     page_num_set.add(pageno);
            // else
            //     page_num_set.delete(pageno);
            // makeDom();
            // let instruction = $('#instructionBody');
            // if (instruction.is(':visible')) {
            //     instruction.toggle();
            // }
            // //window.scrollTo(0, 0); // scroll to top
            // show();
        }
        document.getElementById('button-bar').appendChild(button);
    }

    // format template area with role mappings
    // if template not null or undefined
    if (event.template !== null) {
        const template_area = template_record[i];
        const template = $('<p>').text(event.template);
        template_area.append(template);
        event.role_text_map.forEach(function (pairing) {
            template_area.append(make_role_mapping_element(pairing.role, pairing.tokens.map(tk => tk.text).join('/')));
        });
    }
})

// ---------------------------------------------------------
// Initialize
// ---------------------------------------------------------

var submit_form = function (event) {
    event.preventDefault();
    if (!window.confirm("Are you sure you want to submit?")) return;
    save_all();

    const urlParams = new URLSearchParams(window.location.search)

    // create the form element and point it to the correct endpoint
    const form = document.createElement('form')
    form.action = (new URL('mturk/externalSubmit', urlParams.get('turkSubmitTo'))).href
    form.method = 'post'

    // attach the assignmentId
    const inputAssignmentId = document.createElement('input')
    inputAssignmentId.name = 'assignmentId'
    inputAssignmentId.value = urlParams.get('assignmentId')
    inputAssignmentId.hidden = true
    form.appendChild(inputAssignmentId)

    // attach data I want to send back
    const inputResults = document.createElement('input')
    inputResults.name = 'results'
    inputResults.value = JSON.stringify(save_record)
    inputResults.hidden = true
    form.appendChild(inputResults)

    // attach the form to the HTML document and trigger submission
    document.body.appendChild(form)
    form.submit()
}

//$('#save').on('click', save_all);
submit.on('click', submit_form);

var popup_alert = function (alert_box, text) {
    alert_box.html(text);
    alert_box.css({
        'background-color': 'fec5bb',
        'padding': '5px',
        'border': '1px solid lightgray',
        'border-radius': '10px',
        'margin-top': '10px',
        'margin-bottom': '10px'
    });
    displaying = true;
    setTimeout(function () {
        alert_box.html('');
        alert_box.css({
            'padding': '0px',
            'border': '0px'
        });
        displaying = false;
    }, 7000);
};

const selectA = $('#selectA');
const selectB = $('#selectB');

const tupleSelect = $('#tuple-select');


function makeSelectionOptions() {
    if (strategy === 'A') {
        tupleSelect.empty();
        events_data.forEach(function (ei, i) {
            events_data.forEach(function (ej, j) {
                if (i >= j) return;
                const opt = $('<option>')
                    .attr({
                        value: `${i},${j}`,
                    })
                    .text(`${describeEvent(ei)} & ${describeEvent(ej)}`);
                tupleSelect.append(opt);
            });
        });
        tupleSelect.children()[0].selected = true;
    } else {
        tupleSelect.empty();
        function describeEventById(id) {
            const event = events_data.find(e => e.event_id === id);
            return describeEvent(event);
        }
        strategyB_tuples.forEach(function (tuple, i) {
            const opt = $('<option>')
                .attr({
                    value: i,
                })
                .text(`${describeEventById(tuple[0])}, ${describeEventById(tuple[1])}, ${describeEventById(tuple[2])}`);
            tupleSelect.append(opt);
        });
        tupleSelect.children()[0].selected = true;
    }
}

selectA.on('click', function () {
    if (strategy === 'A') return;
    strategy = 'A';
    $('#strategyA').show();
    select_button(selectA);
    $('#strategyB').hide();
    deselect_button(selectB);
    makeSelectionOptions();
    makeDom();
    show();
});

selectB.on('click', function () {
    if (strategy === 'B') return;
    strategy = 'B';
    $('#strategyA').hide();
    deselect_button(selectA);
    $('#strategyB').show();
    select_button(selectB);
    makeSelectionOptions();
    makeDom();
    show();
});

selectA.click();

tupleSelect.on('change', function () {
    makeDom();
    show();
});

$('#developer-mode').on('change', function () {
    developer_mode = this.checked;
    makeSelectionOptions();
    makeDom();
    show();
});

// Instructions expand/collapse
var content = $('#instructionBody');
var instructions_trigger = $('#collapseTrigger');
// content.hide();
$('.collapse-text').text('(Click to collapse)');
instructions_trigger.click(function () {
    content.toggle();
    var isVisible = content.is(':visible');
    if (isVisible) {
        $('.collapse-text').text('(Click to collapse)');
    } else {
        $('.collapse-text').text('(Click to expand)');
    }
});

console.log(save_record)
show();
</script>
</crowd-form>