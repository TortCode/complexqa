<crowd-form answer-format="flatten-objects">
  <section class="container-fluid" id="Relevancy">
    <div class="row">
      <div class="col-xs-12 col-md-12">
        <div class="panel panel-primary">
          <a class="panel-heading" href="javascript:void(0);" id="collapseTrigger">
            <strong>Annotation Instructions</strong>
            <span class="collapse-text">(Click to expand)</span>
          </a>
          <div class="panel-body" id="instructionBody">
            {{INSTRUCTIONS}}
            {{LINK}}
          </div>
        </div>
      </div>
    </div>

    <h3>Document</h3>
    <div id="document-text" class="ann well well-sm">
      Analysis backs claim <role id='role-0-Instrument'trigno='0'>drones</role> were used to <trigger id='trigger-0'>attack</trigger> Venezuela’s <role id='role-0-Target'trigno='0'>president</role> Analysis of open source information carried out by the investigative website Bellingcat suggests drones that had been repurposed as flying <role id='role-1-Instrument'trigno='1'>bombs</role> were indeed used in an <trigger id='trigger-1'>attack</trigger> on the <role id='role-1-Target'trigno='1'>president</role> of <role id='role-1-Place'trigno='1'>Venezuela</role> this weekend. The Venezuelan government claimed three days ago that an <trigger id='trigger-2'>attempt</trigger> had been made to assassinate President <role id='role-2-Target'trigno='2'>Nicolás Maduro</role> using two drones loaded with <role id='role-2-Instrument'trigno='2'>explosives</role>. The <role id='role-12-Communicator'trigno='12'>president</role> had been giving a <trigger id='trigger-12'>speech</trigger> which was being broadcast live on television when the incident occurred. Initial video from a state-owned television network showed the reaction of Maduro, those around him and a parade of soldiers at the event to what appeared to be two blasts somewhere off camera. But the footage did not include shots of any drones or explosions. AP also reported that firefighters at scene had shed doubt on the drone attack claim — suggesting there had instead been a gas explosion in a nearby flat. Since then more footage has emerged, including videos purporting to show a drone exploding and a drone tumbling alongside a building. <role id='role-3-Investigator'trigno='3'>Bellingcat</role> has carried out an <trigger id='trigger-3'>analysis</trigger> of publicly available information related to the attack, including syncing timings of the state broadcast of Maduro’s speech, and using frame-by-frame analysis combined with photos and satellite imagery of Caracas to try to pinpoint locations of additional footage that has emerged to determine whether the drone attack claim stands up. The Venezuelan government has claimed the drones used were DJI Matrice 600s, each carrying approximately 1kg of C4 plastic explosive and, when detonated, capable of causing damage at a radius of around 50 meters. DJI Matrice 600 drones are a commercial model, normally used for industrial work — with a U. S. price tag of around $5, 000 apiece, suggesting the attack could have cost little over $10k to carry out — with 1kg of plastic explosive available commercially (for demolition purposes) at a cost of around $30. Bellingcat says its analysis supports the government’s claim that the drone model used was a DJI Matrice 600, noting that the drones involved in the event each had six rotors. It also points to a photo of drone wreckage which appears to show the distinctive silver rotor tip of the model, although it also notes the drones appear to have had their legs removed. Venezuela’s interior minister, <role id='role-13-Participant'trigno='13'><role id='role-13-Participant'trigno='13'>Nestor Reverol</role></role>, also <trigger id='trigger-13'>claimed</trigger> the <role id='role-5-Disabler'trigno='5'>government</role> thwarted the attack using"special techniques and [radio] signal inhibitors", which"<trigger id='trigger-5'>disoriented</trigger>"the <role id='role-5-Artifact'trigno='5'>drone</role> that <trigger id='trigger-4'>detonated</trigger> closest to the presidential <role id='role-4-Target'trigno='4'>stand</role> — a capability Bellingcat notes the Venezuelan security services are reported to have. The second <role id='role-6-Vehicle'trigno='6'>drone</role> was said by Reverol to have"lost control"and <trigger id='trigger-6'>crashed</trigger> into a nearby <role id='role-6-Place'trigno='6'>building</role>. <role id='role-14-Participant'trigno='14'><role id='role-14-Participant'trigno='14'>Bellingcat</role></role> <trigger id='trigger-14'>says</trigger> it is possible to geolocate the video of the falling drone to the same location as the fire in the apartment that firefighters had claimed was caused by a gas canister explosion. It adds that images taken of this location during the fire show a hole in the wall of the apartment in the <role id='role-9-Place'trigno='9'>vicinity</role> of where the <role id='role-9-CrashObject'trigno='9'>drone</role> would have <trigger id='trigger-9'>crashed</trigger>."It is a very likely possibility that the downed <role id='role-8-ExplosiveDevice'trigno='8'>drone</role> subsequently <trigger id='trigger-8'>detonated</trigger>, creating the hole in the wall of this <role id='role-8-Place'trigno='8'>apartment</role>, igniting a fire, and causing the sound of the second explosion which can be heard in Video 2 [of the state TV broadcast of Maduro’s speech],"it further suggests. Here’s its conclusion: From the open sources of information available, it appears that an <trigger id='trigger-7'>attack</trigger> took place using two <role id='role-7-Instrument'trigno='7'>DBIEDs</role> while <role id='role-7-Target'trigno='7'>Maduro</role> was giving a speech. Both the drones appear visually similar to DJI Matrice 600s, with at least one displaying features that are consistent with this model. These drones appear to have been loaded with explosive and flown towards the parade. The first <role id='role-10-ExplosiveDevice'trigno='10'>drone</role> <trigger id='trigger-10'>detonated</trigger> <role id='role-10-Place'trigno='10'>somewhere</role> above or near the parade, the most likely cause of the casualties <trigger id='trigger-15'>announced</trigger> by the Venezuelan <role id='role-15-Communicator'trigno='15'>government</role> and pictured on social media. The second <role id='role-11-CrashObject'trigno='11'>drone</role> <trigger id='trigger-11'>crashed</trigger> and exploded approximately 14 seconds later and 400 meters away from the stage, and is the most likely cause of the fire which the Venezuelan firefighters described. It also considers the claim of attribution by a group on social media, calling itself"Soldados de Franelas"(aka ‘ T-Shirt Soldiers’— a reference to a technique used by protestors wrapping a t-shirt around their head to cover their face and protect their identity), suggesting it’s not clear from the group’s Twitter messages that they are"unequivocally claiming responsibility for the event", owing to use of passive language, and to a claim that the drones were shot down by government snipers — which it says"does not appear to be supported by the open source information available". 
    </div>

    <div id='raw-data' hidden>
      [{"event_id": "K0C041O37-E1", "text": "attack", "offset": 7, "length": 1, "template": "[Attacker] attacked [Target] using [Instrument] at [Place] place", "role_text_map": [{"role": "Attacker", "token": null}, {"role": "Target", "token": {"text": "president", "offset": 11, "length": 1}}, {"role": "Instrument", "token": {"text": "drones", "offset": 3, "length": 1}}, {"role": "Place", "token": null}]}, {"event_id": "K0C041O37-E2", "text": "attack", "offset": 38, "length": 1, "template": "[Attacker] detonated or exploded [ExplosiveDevice] explosive device using [Instrument] to attack [Target] target at [Place] place", "role_text_map": [{"role": "Attacker", "token": null}, {"role": "Target", "token": {"text": "president", "offset": 41, "length": 1}}, {"role": "Instrument", "token": {"text": "bombs", "offset": 32, "length": 1}}, {"role": "ExplosiveDevice", "token": null}, {"role": "Place", "token": {"text": "Venezuela", "offset": 43, "length": 1}}]}, {"event_id": "K0C041O37-E3", "text": "attempt", "offset": 56, "length": 1, "template": "[Attacker] attacked [Target] using [Instrument] at [Place] place", "role_text_map": [{"role": "Attacker", "token": null}, {"role": "Target", "token": {"text": "Nicol\u00e1s Maduro", "offset": 63, "length": 2}}, {"role": "Instrument", "token": {"text": "explosives", "offset": 70, "length": 1}}, {"role": "Place", "token": null}]}, {"event_id": "K0C041O37-E5", "text": "analysis", "offset": 198, "length": 1, "template": "[Investigator] investigated [Defendant] for [Crime] crime in [Place] place", "role_text_map": [{"role": "Investigator", "token": {"text": "Bellingcat", "offset": 193, "length": 1}}, {"role": "Defendant", "token": null}, {"role": "Crime", "token": null}, {"role": "Place", "token": null}]}, {"event_id": "K0C041O37-E7", "text": "detonated", "offset": 466, "length": 1, "template": "[Attacker] detonated or exploded [ExplosiveDevice] explosive device using [Instrument] to attack [Target] target at [Place] place", "role_text_map": [{"role": "Attacker", "token": null}, {"role": "Target", "token": {"text": "stand", "offset": 471, "length": 1}}, {"role": "Instrument", "token": null}, {"role": "ExplosiveDevice", "token": null}, {"role": "Place", "token": null}]}, {"event_id": "K0C041O37-E8", "text": "disoriented", "offset": 461, "length": 1, "template": "[Disabler] disabled or defused [Artifact] using [Instrument] instrument in [Place] place", "role_text_map": [{"role": "Disabler", "token": {"text": "government", "offset": 443, "length": 1}}, {"role": "Artifact", "token": {"text": "drone", "offset": 464, "length": 1}}, {"role": "Instrument", "token": null}, {"role": "Place", "token": null}]}, {"event_id": "K0C041O37-E6", "text": "crashed", "offset": 500, "length": 1, "template": "[DriverPassenger] person in [Vehicle] vehicle crashed into [CrashObject] at [Place] place", "role_text_map": [{"role": "DriverPassenger", "token": null}, {"role": "Vehicle", "token": {"text": "drone", "offset": 488, "length": 1}}, {"role": "CrashObject", "token": null}, {"role": "Place", "token": {"text": "building", "offset": 504, "length": 1}}]}, {"event_id": "K0C041O37-E9", "text": "attack", "offset": 651, "length": 1, "template": "[Attacker] attacked [Target] using [Instrument] at [Place] place", "role_text_map": [{"role": "Attacker", "token": null}, {"role": "Target", "token": {"text": "Maduro", "offset": 658, "length": 1}}, {"role": "Instrument", "token": {"text": "DBIEDs", "offset": 656, "length": 1}}, {"role": "Place", "token": null}]}, {"event_id": "K0C041O37-E10", "text": "detonated", "offset": 584, "length": 1, "template": "[Attacker] detonated or exploded [ExplosiveDevice] explosive device using [Instrument] to attack [Target] target at [Place] place", "role_text_map": [{"role": "Attacker", "token": null}, {"role": "Target", "token": null}, {"role": "Instrument", "token": null}, {"role": "ExplosiveDevice", "token": {"text": "drone", "offset": 582, "length": 1}}, {"role": "Place", "token": {"text": "apartment", "offset": 594, "length": 1}}]}, {"event_id": "K0C041O37-E12", "text": "crashed", "offset": 570, "length": 1, "template": "[DriverPassenger] person in [Vehicle] vehicle crashed into [CrashObject] at [Place] place", "role_text_map": [{"role": "DriverPassenger", "token": null}, {"role": "Vehicle", "token": null}, {"role": "CrashObject", "token": {"text": "drone", "offset": 567, "length": 1}}, {"role": "Place", "token": {"text": "vicinity", "offset": 563, "length": 1}}]}, {"event_id": "K0C041O37-E13", "text": "detonated", "offset": 706, "length": 1, "template": "[Attacker] detonated or exploded [ExplosiveDevice] explosive device using [Instrument] to attack [Target] target at [Place] place", "role_text_map": [{"role": "Attacker", "token": null}, {"role": "Target", "token": null}, {"role": "Instrument", "token": null}, {"role": "ExplosiveDevice", "token": {"text": "drone", "offset": 705, "length": 1}}, {"role": "Place", "token": {"text": "somewhere", "offset": 707, "length": 1}}]}, {"event_id": "K0C041O37-E14", "text": "crashed", "offset": 735, "length": 1, "template": "[DriverPassenger] person in [Vehicle] vehicle crashed into [CrashObject] at [Place] place", "role_text_map": [{"role": "DriverPassenger", "token": null}, {"role": "Vehicle", "token": null}, {"role": "CrashObject", "token": {"text": "drone", "offset": 734, "length": 1}}, {"role": "Place", "token": null}]}, {"event_id": "K0C041O37-E16", "text": "speech", "offset": 78, "length": 1, "template": "[Communicator] communicated to [Recipient] about [Topic] topic using [Instrument] at [Place] place (one-way communication)", "role_text_map": [{"role": "Communicator", "token": {"text": "president", "offset": 73, "length": 1}}, {"role": "Recipient", "token": null}, {"role": "Instrument", "token": null}, {"role": "Topic", "token": null}, {"role": "Place", "token": null}]}, {"event_id": "K0C041O37-E17", "text": "claimed", "offset": 441, "length": 1, "template": "[Participant] communicated with [Participant] about [Topic] topic at [Place] place (document does not specify in person or not, or one-way or not)", "role_text_map": [{"role": "Participant", "token": {"text": "Nestor Reverol", "offset": 437, "length": 2}}, {"role": "Participant", "token": {"text": "Nestor Reverol", "offset": 437, "length": 2}}, {"role": "Topic", "token": null}, {"role": "Place", "token": null}]}, {"event_id": "K0C041O37-E18", "text": "says", "offset": 507, "length": 1, "template": "[Participant] communicated with [Participant] about [Topic] topic at [Place] place (document does not specify in person or not, or one-way or not)", "role_text_map": [{"role": "Participant", "token": {"text": "Bellingcat", "offset": 506, "length": 1}}, {"role": "Participant", "token": {"text": "Bellingcat", "offset": 506, "length": 1}}, {"role": "Topic", "token": null}, {"role": "Place", "token": null}]}, {"event_id": "K0C041O37-E19", "text": "announced", "offset": 721, "length": 1, "template": "[Communicator] communicated to [Recipient] about [Topic] topic using [Instrument] at [Place] place (one-way communication)", "role_text_map": [{"role": "Communicator", "token": {"text": "government", "offset": 725, "length": 1}}, {"role": "Recipient", "token": null}, {"role": "Instrument", "token": null}, {"role": "Topic", "token": null}, {"role": "Place", "token": null}]}]
    </div>

    <p>
      You can navigate all of the triggers by clicking the following buttons. <br>
      You have to finish all the triggers before submitting. (Remember that you can't refresh the page otherwise
      the progress will be gone, <br>
      to prevent this from happening, we suggest that you write the QA pairs in the google doc and copy paste them
      here)
    </p>
    <!-- Tabs for each trigger -->
    <div class="btn-toolbar" id="button-bar">
    </div>

    <section>
      <div style="margin-top:10px;">
        <em>
          These are bootstrap question answer pairs generated by GPT. Not all QA
          pairs are correct or relevant, but feel free to copy/paste the samples that are accurate
          enough, and make edits on top.
        </em>
        <div id='bootstrap-area' class='ann well well-sm'>
        </div>
      </div>

      <div style="margin-top:10px;">
        <em>
          These are KAIROS event arguments for the trigger. You can use them to help you write QA pairs.
          The underlying meaning of such pairs should be "Q: What is arg X of the event? A: arg X is Y".
          But the formatting of the QA pairs must be as in the instructions.
        </em>
        <div id='template-area' class='ann well well-sm'>
        </div>
      </div>

      <div class="btn-container">
        <button id="addbtn" class="btn btn-success" type="button" onclick="add_qa_input()">+</button>
        <label for="addbtn">Add a QA pair</label>
      </div>
      <div class="btn-container">
        <button id="rmbtn" class="btn btn-danger" type="button" onclick="remove_qa_input()">-</button>
        <label for="rmbtn">Remove a QA pair</label>
      </div>

      <div id="input-area">

      </div>
    </section>

    <div title="Highlight all fields before submitting">
      <button id="save" class="btn btn-default" type="button">Save</button>
      <button id="submitButton" class="btn btn-default" type="button">Submit</button>
    </div>
  </section>


  <link crossorigin="anonymous" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
    integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.1.0.min.js"
    integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
    integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>

  <style>
    .mg-15 {
      margin-left: 15px;
      margin-right: 15px;
    }

    .container-fluid {
      max-width: 1800px;
      margin: 30px;
    }

    .btn-container {
      display: inline-block;
      margin: 10px;
    }

    #collapseTrigger {
      color: #fff;
      display: block;
      text-decoration: none;
    }

    #submitButton {
      white-space: normal;
    }

    #input-area {
      display: block;
      margin: 10px;
    }

    #input-area>div {
      margin: 10px;
      background-color: #ffe3e3;
    }

    #bootstrap-area {
      background-color: #f7dec5;
    }

    #template-area {
      background-color: #eee;
      display: flex;
    }

    .template-map {
      border: 1px solid gray;
      padding: 5px;
    }

    .btn-container>button {
      min-width: 3em;
    }

    trigger {
      display: inline;
      background-color: lightgoldenrodyellow;
    }

    role {
      display: inline;
      background-color: lightblue;
    }

    .highlight-trigger {
      background-color: palevioletred
    }

    .highlight-role {
      background-color: lightgreen;
    }

    .btn-group {
      vertical-align: middle;
    }

    .content {
      margin-bottom: 15px;
    }

    .ann {
      font-size: 16px;
    }

    .disp {
      font-size: 20px;
    }

    .ann>span.token {
      cursor: pointer;
    }

    .ann>span.token:hover {
      text-decoration: underline;
    }

    .ann>strong.annotation:hover {
      text-decoration: line-through;
    }

    input[disabled] {
      color: #000
    }
  </style>

  <script>
    // ---------------------------------------------------------
    // Global
    // ---------------------------------------------------------

    var page_num_set = new Set();

    // ---------------------------------------------------------
    // Create jQuery elements
    // ---------------------------------------------------------

    var submit = $('#submitButton');

    // list of text/offset objects 
    var triggers_list = JSON.parse($('#raw-data').text().trim());

    const empty_template_map = function () {
      return $('<div class="template-map">');
    }

    let save_record = [];
    let template_record = [];
    triggers_list.forEach(function (_, idx) {
      template_record[idx] = empty_template_map();
    });

    // implementation of string formatting
    if (!String.prototype.format) {
      String.prototype.format = function () {
        var args = arguments;
        return this.replace(/{(\d+)}/g, function (match, number) {
          return typeof args[number] != 'undefined'
            ? args[number]
            : match
            ;
        });
      };
    }

    // ---------------------------------------------------------
    // Create elements
    // ---------------------------------------------------------

    var makeDom = function () {
      make_trigger();
      recoverUserInput();
    };

    var make_trigger = function () {
      /* highlight trigger within document */

      // remove previous highlights
      $('trigger').removeClass('highlight-trigger');
      $('role').removeClass('highlight-role');

      page_num_set.forEach(trigger_num => {
        // highlight trigger
        $('#trigger-' + trigger_num).addClass('highlight-trigger');
        $('role[trigno=' + trigger_num + ']').addClass('highlight-role');
      })

      /* update bootstrap questions */
      //$('#bootstrap-area').html(trigger.bootstrap ?? 'no bootstrap available');

    }

    // restore input from other trigger
    var recoverUserInput = function () {
      const templateArea = $('#template-area');
      // simply swap out the input area DOM element!
      templateArea.empty()
      
      page_num_set.forEach(trigger_num => {
        templateArea.append(template_record[trigger_num]);
      });
    };

    // ensure something is in the input box
    var canSubmit = function () {
      return true;
    };

    // template role fields
    const make_role_mapping_element = function (role, text) {
      const role_text = $('<label>').html('<b>' + role + '</b>:');
      const role_field = $('<span>')
        .addClass('role-field')
        .attr({
          role: role,
          rows: 1,
        })
        .text(text)

      const role_div = $('<div>')
        .addClass('role-container')
        .append(role_text)
        .append(role_field);

      return role_div;
    }

    // number of QA pairs at the moment
    var input_count = 0;

    const add_qa_input = function () {
      const current_idx = input_count;
      let question_text = $('<label>').text('question:');
      let question_input = $('<textarea>')
        .addClass('question-input')
        .addClass('mg-15')
        .attr({
          id: 'input-question' + input_count,
          name: 'input-question' + input_count,
          placeholder: 'write down your question',
          rows: 1,
          cols: 80,
        });
      question_input.on("input", function () {
        // if (is_wh_question(question_input.val())) {
        //     window.alert("It seems you are not writing a yes/no question, make sure " +
        //         "you are writing questions of which the answer is yes or no!")
        // }
        show();
      });
      let answer_text = $('<label>').text('answer:');
      let answer_input = $('<textarea>')
        .addClass('answer-input')
        .addClass('mg-15')
        .attr({
          id: 'input-answer' + input_count,
          name: 'input-answer' + input_count,
          placeholder: 'write down your answer',
          rows: 1,
          cols: 80,
        });
      answer_input.on("input", function () {
        show();
      });

      let input_fields = $(
        '<div>').addClass('input-fields')
        .append(question_text)
        .append(question_input)
        .append(answer_text)
        .append(answer_input)
      $('#input-area').append(input_fields);

      input_count += 1;
      show();
    };

    const remove_qa_input = function () {
      if (input_count <= 0) {
        return;
      }
      $('#input-area').children().last().remove();
      input_count -= 1;
      show();
    };

    var enable_button = function (button) {
      button.removeAttr("disabled");
      button.removeClass("btn-default");
      button.addClass("btn-success");
    };

    var disable_button = function (button) {
      button.attr("disabled", "disabled");
      button.removeClass("btn-success");
      button.addClass("btn-default");
    };

    var select_button = function (button) {
      button.removeClass("btn-default");
      button.addClass("btn-primary");
    };

    var deselect_button = function (button) {
      button.removeClass("btn-primary");
      button.addClass("btn-default");
    };

    var is_wh_question = function (question) {
      let tokens = question.split(' ');
      if (tokens.length <= 1) {
        return false;
      }
      console.log(tokens);

      // let wh_pattern = /^Wh\|wh\|How\|how/;
      let wh_pattern = /^wh|Wh|how|How/;
      // console.log(question.match(wh_pattern));
      return !!question.match(wh_pattern);
    };


    var show = function () {
      for (button of document.getElementById('button-bar').getElementsByTagName('*')) {
        if (page_num_set.has(parseInt(button.getAttribute('page-no'))))
          select_button($(button));
        else
          deselect_button($(button));
      }

      if (canSubmit()) {
        enable_button(submit);
        // enable_button($('#next-btn'));
      } else {
        disable_button(submit);
        // disable_button($('#next-btn'));
      }
    };

    // dynamically create buttons for each SRL arg
    triggers_list.forEach(function (trigger, i) {
      if (trigger.text.trim()) {
        console.log(trigger);
        var button = document.createElement("button");
        button.setAttribute("type", "button");
        button.setAttribute("id", "button-page-" + i);
        button.setAttribute("page-no", i);
        button.setAttribute("class", "btn btn-default");
        button.innerHTML = trigger.text + " @ token " + trigger.offset;
        button.onclick = function () {
          const pageno = parseInt(this.getAttribute("page-no"));
          // toggle button
          if (button.classList.contains('btn-default'))
            page_num_set.add(pageno);
          else
            page_num_set.delete(pageno);
          makeDom();
          let instruction = $('#instructionBody');
          if (instruction.is(':visible')) {
            instruction.toggle();
          }
          //window.scrollTo(0, 0); // scroll to top
          show();
        }
        document.getElementById('button-bar').appendChild(button);
      }

      // replace newlines with HTML line breaks
      const bootstrap = trigger.bootstrap;
      if (bootstrap !== undefined)
        trigger.bootstrap = bootstrap.replaceAll('\n', '<br>');

      // format template area with role mappings
      // if template not null or undefined
      if (trigger.template !== null) {
        const template_area = template_record[i];
        const template = $('<p>').text(trigger.template);
        template_area.append(template);
        trigger.role_text_map.forEach(function (pairing) {
          template_area.append(make_role_mapping_element(pairing.role, pairing.token?.text));
        });
      }
    })

    var clear_button = document.createElement("button");
    clear_button.setAttribute("type", "button");
    clear_button.setAttribute("class", "btn btn-default");
    clear_button.innerHTML = "Clear Triggers";
    clear_button.onclick = function () {
      page_num_set.clear();
      makeDom();
      show();
    }
    document.getElementById('button-bar').appendChild(clear_button);

    // ---------------------------------------------------------
    // Initialize
    // ---------------------------------------------------------

    makeDom(0);

    var save_all = function () {
      save_record.qapairs = [];
      save_record.triggers = [];
      // save all input
      triggers_list.forEach(function (trigger, idx) {
        // initialize record
        save_record.triggers[idx] = {
          event_id: trigger.event_id,
          trigger: {
            text: trigger.text,
            offset: trigger.offset
          },
          template: trigger.template,
          role_map: {},
        };

        // get input elements
        const template_input_area = template_record[idx];
        const template_inputs = template_input_area.children();

        // traverse over elements to get role mappings
        template_inputs.each(function (_, input) {
          const role = $(input).children('.role-field').attr('role');
          const text = $(input).children('.role-field').val();

          save_record.triggers[idx].role_map[role] = text;
        });
      });

      const trigger_input_area = $('#input-area');
      const trigger_inputs = trigger_input_area.children();

      // traverse over elements to get QA pairs
      trigger_inputs.each(function (_, input) {
        // save qa pairs
        const question = $(input).children('.question-input').val();
        const answer = $(input).children('.answer-input').val();
        save_record.qapairs.push({
          'question': question,
          'answer': answer
        });
      });

      console.log(save_record);
    };

    var submit_form = function () {
      save_all();

      const urlParams = new URLSearchParams(window.location.search)

      // create the form element and point it to the correct endpoint
      const form = document.createElement('form')
      form.action = (new URL('mturk/externalSubmit', urlParams.get('turkSubmitTo'))).href
      form.method = 'post'

      // attach the assignmentId
      const inputAssignmentId = document.createElement('input')
      inputAssignmentId.name = 'assignmentId'
      inputAssignmentId.value = urlParams.get('assignmentId')
      inputAssignmentId.hidden = true
      form.appendChild(inputAssignmentId)

      // attach data I want to send back
      const inputResults = document.createElement('input')
      inputResults.name = 'results'
      inputResults.value = JSON.stringify(save_record)
      inputResults.hidden = true
      form.appendChild(inputResults)

      // attach the form to the HTML document and trigger submission
      document.body.appendChild(form)
      form.submit()
    }

    $('#save').on('click', save_all);
    submit.on('click', submit_form);

    var popup_alert = function (alert_box, text) {
      alert_box.html(text);
      alert_box.css({
        'background-color': 'fec5bb',
        'padding': '5px',
        'border': '1px solid lightgray',
        'border-radius': '10px',
        'margin-top': '10px',
        'margin-bottom': '10px'
      });
      displaying = true;
      setTimeout(function () {
        alert_box.html('');
        alert_box.css({
          'padding': '0px',
          'border': '0px'
        });
        displaying = false;
      }, 7000);
    };

    // Instructions expand/collapse
    var content = $('#instructionBody');
    var instructions_trigger = $('#collapseTrigger');
    // content.hide();
    $('.collapse-text').text('(Click to collapse)');
    instructions_trigger.click(function () {
      content.toggle();
      var isVisible = content.is(':visible');
      if (isVisible) {
        $('.collapse-text').text('(Click to collapse)');
      } else {
        $('.collapse-text').text('(Click to expand)');
      }
    });

    show();

  </script>
</crowd-form>