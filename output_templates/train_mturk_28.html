<crowd-form answer-format="flatten-objects">
  <section class="container-fluid" id="Relevancy">
    <div class="row">
      <div class="col-xs-12 col-md-12">
        <div class="panel panel-primary">
          <a class="panel-heading" href="javascript:void(0);" id="collapseTrigger">
            <strong>Annotation Instructions</strong>
            <span class="collapse-text">(Click to expand)</span>
          </a>
          <div class="panel-body" id="instructionBody">
            {{INSTRUCTIONS}}
            {{LINK}}
          </div>
        </div>
      </div>
    </div>

    <h3>Document</h3>
    <div id="document-text" class="ann well well-sm">
      Oklahoma City Bombing Documentary Examines Growth of American Extremism WASHINGTON — The <role id='role-0-Place'trigno='0'>Oklahoma City</role> <trigger id='trigger-0'>bombing</trigger> nearly 22 years ago was an act of domestic terror by U. S. military veteran Timothy McVeigh and his accomplice, <role id='role-0-Attacker'trigno='0'>Terry Nichols</role>. The bombing destroyed one third of the Alfred P. Murrah Federal Building in downtown Oklahoma City, Oklahoma, <trigger id='trigger-1'>killing</trigger> 168 <role id='role-1-Victim'trigno='1'>people</role> and <trigger id='trigger-2'>injuring</trigger> 680 <role id='role-2-Victim'trigno='2'>others</role>. In his documentary, Oklahoma City, filmmaker Barak Goodman revisits the bombing as the first major domestic terrorist attack in the United States on April 19, 1995. It was the number of civilians killed-especially the 15 children, four of them infants, crushed inside the building's day care center-that made this terrorist attack by a massive fertilizer bomb so heinous for many Americans. Many films have recounted the story, but Goodman’s documentary treats the Oklahoma City <trigger id='trigger-3'>bombing</trigger> as a springboard to examine the roots of America's ultra-right militia and to analyze the makeup of homegrown American terrorism. History of suspicion “It goes all the way back to the founding of the Republic,” the filmmaker told VOA."The Republic was founded on the suspicion of government."Goodman says many of these extreme separatists believe in white supremacy and in unregulated freedom to keep and bear arms so that they can protect themselves from outsiders and the government. In the documentary, former militia member Kerry Noble explains the ideology. “The government is an enemy of the people, and in this war it’s an all or nothing. We’re either gonna win as the white race or we’re gonna lose.” FILE-In this April 21, 1995 file photo, Timothy McVeigh is led out of the Noble County Courthouse by state and federal law enforcement officials in Perry, Oklahoma, after being identified as a suspect in the bombing of the Oklahoma City Federal building. <role id='role-4-Defendant'trigno='4'>McVeigh</role> was eventually <trigger id='trigger-4'>convicted</trigger> of the bombing and executed. Oklahoma City points to two events in the late 20th century that bolstered separatist ideologies: The Ruby Ridge incident on August 21, 1992, and the Waco siege in Waco, Texas, between February 28 and April 19, 1993. In both cases, federal and local government agents clashed with American separatists. The deadly incidents were fueled by the authorities'demand to search the premises for illegal firearms. The Waco siege was particularly deadly. The compound belonged to a group known as the Branch Davidians, led by David Koresh. When federal authorities sent in armed agents and armored vehicles to end the standoff, a fire engulfed the compound, <trigger id='trigger-5'>killing</trigger> 82 people, including <role id='role-5-Victim'trigno='5'>David Koresh</role>. Sixty-two of the victims were women and children. Birth of an extremist Timothy McVeigh, a Gulf War veteran disillusioned by the government during his tour in Iraq, was among those who went to witness the siege. According to the documentary, McVeigh was radicalized by those events and by an extremist publication called The Turner Diaries. “It’s a Talisman for the far right, even to this day, but especially back in the'90s and'80s it was the ‘ Bible’of this movement,” says Goodman. “It’s a novel about a small group of ‘ patriots,’‘ white patriots’who retake the government from the Jews and blacks who have infiltrated it, essentially. It’s a racist creed and as I said, it is very poorly done. Intriguingly though, it describes the bombing of the FBI, the culmination of the novel, and it really lays out a recipe on how to <trigger id='trigger-6'>build</trigger> a <role id='role-6-Artifact'trigno='6'>bomb</role> like this."That bomb is very similar to the one McVeigh used in Oklahoma City."McVeigh was deeply, deeply influenced by this book,"Goodman adds."He sold it in gun shows, he quoted it, when <role id='role-7-Detainee'trigno='7'>he</role> was <trigger id='trigger-7'>arrested</trigger> he had several pages of it in a folder beside him in a car. And it wasn’t just McVeigh, it was all through this movement. People were really exorcised, impassioned, inflamed by this novel."FILE-In this May 5, 1995, photo, search and rescue personnel attend a memorial service in front of the Alfred P. Murrah Federal Building in Oklahoma, destroyed by a fertilizer bomb in what is considered the first major domestic terrorist attack in the U. S. The documentary shows McVeigh obsessed with his guns and with the idea that the government was going to take them away. The film also points out that his exposure to the war in Iraq accelerated his feeling of mistrust of the U. S. government. “The way he put it made it sound he was emphatic towards the dead Iraqi soldiers that he killed. I really don’t think that’s the case,” says Barak Goodman. Instead, says the filmmaker, it was McVeigh’s mistrust of the U. S. government, how it had blundered into Iraq and his idea of the U. S. government as a bully, and McVeigh, says Goodman, hated bullies. The Ruby Ridge and Waco stand-offs reinforced that idea in his mind. Homegrown extremism According to the documentary, there are 500 militia organizations in the U. S. today. Goodman believes they are as radicalized as ever. “Some of them have gotten rid of their camouflage outfits and put on suits and ties, but really the rhetoric has been virtually the same for 100 years or more. ‘ It’s a whites-only country, it should be a whites-only country, the federal government is in the hands of Jews, blacks, it’s a conspiracy.'” Goodman says it is a misconception to believe that this is a movement of white poor disenfranchised people. Certainly, he says, many are, but there also many professionals feeling a loss of entitlement, a loss of privilege and power. The filmmaker stresses that these people operate outside political parties and share a deep mistrust of the Washington political establishment. But Goodman cautions these extremists are not de facto terrorists. He says it takes a confluence of opportunity and a warped personality, often a lone individual, to commit a terrorist act of a scale such as the <role id='role-8-Target'trigno='8'>Oklahoma City</role> <trigger id='trigger-8'>bombing</trigger>. “McVeigh was a shock to most people in the FBI. It would be less of a shock today. But it’s very hard to prevent these things. One of the takeaways from our film and audiences who have seen it have been amazed at how really easy it was to do this. It cost about $6000, it was one guy, reading some literature,” says the filmmaker. FILE-A member of a white supremacy group gives a fascist salute during a gathering in West Allis, Wisconsin, Sept. 3, 2011."The number of hate groups in the United States rose for a second year in a row in 2016 as the radical right was energized by the candidacy of Donald Trump,” according to the Southern Law Poverty Center, a U. S. rights group. Goodman says in a politically polarized America, the possibility for future domestic terrorist attacks is high. “If you talk to people from the Southern Law Poverty Center, which tracks these groups, they are pounding on the wall, they are ringing the bell, they are saying, ‘ This is an ongoing threat, it’s threat level midnight, it's rising, it's whatever the highest color is on the chart,'” he says. The SPLC reports, “the number of hate groups in the United States rose for a second year in a row in 2016 as the radical right was energized by the candidacy of Donald Trump.” “The most dramatic growth,” it states, “was the near-tripling of anti-Muslim hate groups–from 34 in 2015 to 101 last year.” Also, a wave of bomb threats and vandalism has rattled Jewish institutions around the country, but especially in the South. “Right now, minorities feel particularly threatened,” says the Oklahoma City filmmaker. “There is a very big difference between even hard gun rights activists and terrorists. I want to make that clear,” says Goodman. “I would take issue with the idea that they have infiltrated the administration. But it is a little galling to see the really mono focus on terrorists from abroad, terrorists influenced by ideas from abroad, whatever those ideas might be, and not on any real discussion about home-grown terrorism which has always been with us and which is not going away and which is actually--if you look at the numbers of the incidents--rivaling or exceeding those by that other group,” he adds. Goodman hopes his film, Oklahoma City, will call attention to this rising threat and contribute to the conversation on the inherent dangers of domestic terrorism. 
    </div>

    <div id='events-data' hidden>
      [{"event_id": "7_VOA_EN_NW_2017.03.07.3753687-E1", "text": "bombing", "offset": 14, "length": 1, "template": "[Attacker] detonated or exploded [ExplosiveDevice] explosive device using [Instrument] to attack [Target] target at [Place] place", "role_text_map": [{"role": "Attacker", "token": {"text": "Terry Nichols", "entity_id": "7_VOA_EN_NW_2017.03.07.3753687-T50", "offset": 38, "length": 2}}, {"role": "Target", "token": null}, {"role": "Instrument", "token": null}, {"role": "ExplosiveDevice", "token": null}, {"role": "Place", "token": {"text": "Oklahoma City", "entity_id": "7_VOA_EN_NW_2017.03.07.3753687-T57", "offset": 12, "length": 2}}]}, {"event_id": "7_VOA_EN_NW_2017.03.07.3753687-E2", "text": "killing", "offset": 61, "length": 1, "template": "[Victim] died at [Place] place from [MedicalIssue] medical issue, killed by [Killer] killer", "role_text_map": [{"role": "Victim", "token": {"text": "people", "entity_id": "7_VOA_EN_NW_2017.03.07.3753687-T118", "offset": 63, "length": 1}}, {"role": "Place", "token": null}, {"role": "Killer", "token": null}, {"role": "MedicalIssue", "token": null}]}, {"event_id": "7_VOA_EN_NW_2017.03.07.3753687-E3", "text": "injuring", "offset": 65, "length": 1, "template": "[Victim] was injured by [Injurer] using [Instrument] in [BodyPart] body part with [MedicalCondition] medical issue at [Place] place", "role_text_map": [{"role": "Victim", "token": {"text": "others", "entity_id": "7_VOA_EN_NW_2017.03.07.3753687-T120", "offset": 67, "length": 1}}, {"role": "Injurer", "token": null}, {"role": "Instrument", "token": null}, {"role": "BodyPart", "token": null}, {"role": "MedicalCondition", "token": null}, {"role": "Place", "token": null}]}, {"event_id": "7_VOA_EN_NW_2017.03.07.3753687-E4", "text": "bombing", "offset": 159, "length": 1, "template": "[Attacker] attacked [Target] using [Instrument] at [Place] place", "role_text_map": [{"role": "Attacker", "token": null}, {"role": "Target", "token": null}, {"role": "Instrument", "token": null}, {"role": "Place", "token": null}]}, {"event_id": "7_VOA_EN_NW_2017.03.07.3753687-E5", "text": "convicted", "offset": 357, "length": 1, "template": "[JudgeCourt] court or judge convicted [Defendant] of [Crime] crime in [Place] place", "role_text_map": [{"role": "JudgeCourt", "token": null}, {"role": "Defendant", "token": {"text": "McVeigh", "entity_id": "7_VOA_EN_NW_2017.03.07.3753687-T106", "offset": 354, "length": 1}}, {"role": "Crime", "token": null}, {"role": "Place", "token": null}]}, {"event_id": "7_VOA_EN_NW_2017.03.07.3753687-E6", "text": "killing", "offset": 485, "length": 1, "template": "[Victim] died at [Place] place from [MedicalIssue] medical issue, killed by [Killer] killer", "role_text_map": [{"role": "Victim", "token": {"text": "David Koresh", "entity_id": "7_VOA_EN_NW_2017.03.07.3753687-T205", "offset": 490, "length": 2}}, {"role": "Place", "token": null}, {"role": "Killer", "token": null}, {"role": "MedicalIssue", "token": null}]}, {"event_id": "7_VOA_EN_NW_2017.03.07.3753687-E7", "text": "build", "offset": 675, "length": 1, "template": "[ManufacturerAssembler] manufactured or assembled or produced [Artifact] from [Components] components using [Instrument] at [Place] place", "role_text_map": [{"role": "ManufacturerAssembler", "token": null}, {"role": "Artifact", "token": {"text": "bomb", "entity_id": "7_VOA_EN_NW_2017.03.07.3753687-T28", "offset": 677, "length": 1}}, {"role": "Components", "token": null}, {"role": "Instrument", "token": null}, {"role": "Place", "token": null}]}, {"event_id": "7_VOA_EN_NW_2017.03.07.3753687-E8", "text": "arrested", "offset": 726, "length": 1, "template": "[Jailer] arrested or jailed [Detainee] for [Crime] crime at [Place] place", "role_text_map": [{"role": "Jailer", "token": null}, {"role": "Detainee", "token": {"text": "he", "entity_id": "7_VOA_EN_NW_2017.03.07.3753687-T96", "offset": 724, "length": 1}}, {"role": "Crime", "token": null}, {"role": "Place", "token": null}]}, {"event_id": "7_VOA_EN_NW_2017.03.07.3753687-E9", "text": "bombing", "offset": 1182, "length": 1, "template": "[Attacker] detonated or exploded [ExplosiveDevice] explosive device using [Instrument] to attack [Target] target at [Place] place", "role_text_map": [{"role": "Attacker", "token": null}, {"role": "Target", "token": {"text": "Oklahoma City", "entity_id": "7_VOA_EN_NW_2017.03.07.3753687-T212", "offset": 1180, "length": 2}}, {"role": "Instrument", "token": null}, {"role": "ExplosiveDevice", "token": null}, {"role": "Place", "token": null}]}]
    </div>

    <div id='relations-data' hidden>
      []
    </div>

    <p>
      You can navigate all of the triggers by clicking the following buttons. <br>
      You have to finish all the triggers before submitting. (Remember that you can't refresh the page otherwise
      the progress will be gone, <br>
      to prevent this from happening, we suggest that you write the QA pairs in the google doc and copy paste them
      here)
    </p>
    <!-- Tabs for each trigger -->
    <div class="btn-toolbar" id="button-bar">
    </div>

    <section>
      <div style="margin-top:10px;">
        <em>
          These are bootstrap question answer pairs generated by GPT. 
        </em>
        <div id='bootstrap-area' class='ann well well-sm'>
        </div>
      </div>

      <div style="margin-top:10px;">
        <em>
          These are relations between events.
        </em>
        <div id='relations-area' class='ann well well-sm'>
        </div>
      </div>

      <div style="margin-top:10px;">
        <em>
          KAIROS event arguments for triggers
        </em>
        <div id='template-area' class='ann well well-sm'>
        </div>
      </div>

      <div class="btn-container">
        <button id="addbtn" class="btn btn-success" type="button" onclick="add_qa_input()">+</button>
        <label for="addbtn">Add a QA pair</label>
      </div>
      <div class="btn-container">
        <button id="rmbtn" class="btn btn-danger" type="button" onclick="remove_qa_input()">-</button>
        <label for="rmbtn">Remove a QA pair</label>
      </div>

      <div id="input-area">

      </div>
    </section>

    <div title="Highlight all fields before submitting">
      <button id="save" class="btn btn-default" type="button">Save</button>
      <button id="submitButton" class="btn btn-default" type="button">Submit</button>
    </div>
  </section>


  <link crossorigin="anonymous" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
    integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.1.0.min.js"
    integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
    integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>

  <style>
    .mg-15 {
      margin-left: 15px;
      margin-right: 15px;
    }

    .mg-5 {
      margin: 5px;
    }

    .container-fluid {
      max-width: 1800px;
      margin: 30px;
    }

    .btn-container {
      display: inline-block;
      margin: 10px;
    }

    #collapseTrigger {
      color: #fff;
      display: block;
      text-decoration: none;
    }

    #submitButton {
      white-space: normal;
    }

    #input-area {
      display: block;
      margin: 10px;
    }

    #input-area>div {
      margin: 10px;
      background-color: #ffe3e3;
    }

    #bootstrap-area {
      background-color: #f7dec5;
    }

    #template-area {
      background-color: #eee;
      display: flex;
    }

    .template-map {
      border: 1px solid gray;
      padding: 5px;
    }

    .btn-container>button {
      min-width: 3em;
    }

    trigger {
      display: inline;
    }

    role {
      display: inline;
    }

    .highlight-trigger {
      background-color: lightgoldenrodyellow;
    }

    .highlight-role {
      background-color: lightblue;
    }

    .btn-group {
      vertical-align: middle;
    }

    .content {
      margin-bottom: 15px;
    }

    .ann {
      font-size: 16px;
    }

    .disp {
      font-size: 20px;
    }

    .ann>span.token {
      cursor: pointer;
    }

    .ann>span.token:hover {
      text-decoration: underline;
    }

    .ann>strong.annotation:hover {
      text-decoration: line-through;
    }

    input[disabled] {
      color: #000
    }
  </style>

  <script>
    // ---------------------------------------------------------
    // Global
    // ---------------------------------------------------------

    var page_num_set = new Set();

    // ---------------------------------------------------------
    // Create jQuery elements
    // ---------------------------------------------------------

    var submit = $('#submitButton');

    // list of text/offset objects 
    let events_data = JSON.parse($('#events-data').text().trim());
    let relations_data = JSON.parse($('#relations-data').text().trim());

    const empty_template_map = function () {
      return $('<div class="template-map">');
    }

    let save_record = [];
    let template_record = [];
    events_data.forEach(function (_, idx) {
      template_record[idx] = empty_template_map();
    });

    // implementation of string formatting
    if (!String.prototype.format) {
      String.prototype.format = function () {
        var args = arguments;
        return this.replace(/{(\d+)}/g, function (match, number) {
          return typeof args[number] != 'undefined'
            ? args[number]
            : match
            ;
        });
      };
    }

    // ---------------------------------------------------------
    // Create elements
    // ---------------------------------------------------------

    var makeDom = function () {
      highlightEvent();
      recoverUserInput();
    };

    var highlightEvent = function () {
      /* highlight trigger within document */

      // remove previous highlights
      $('trigger').removeClass('highlight-trigger');
      $('role').removeClass('highlight-role');

      page_num_set.forEach(trigger_num => {
        // highlight trigger
        $('#trigger-' + trigger_num).addClass('highlight-trigger');
        $('role[trigno=' + trigger_num + ']').addClass('highlight-role');
      })

      /* update bootstrap questions */
      //$('#bootstrap-area').html(trigger.bootstrap ?? 'no bootstrap available');

    }

    const relationTypes = [
      "BEFORE",
      "AFTER",
      "OVERLAPS",
      "RIGHT-AFTER",
      "RIGHT-BEFORE",
      "EQUAL",
      "CONTAINS",
      "CAUSALITY",
    ]

    // restore input from other trigger
    var recoverUserInput = function () {
      // insert template mapping
      const templateArea = $('#template-area');
      templateArea.empty()
      page_num_set.forEach(trigger_num => {
        templateArea.append(template_record[trigger_num]);
      });

      // relations
      const relationsArea = $('#relations-area');
      relationsArea.empty();

      const pagenos = Array.from(page_num_set);
      pagenos.forEach(i => {
        pagenos.forEach(j => {
          if (i == j) return;

          const event1 = events_data[i];
          const event2 = events_data[j];
          const select = makeRelationSelect(event1, event2);
          relationsArea.append(select);
        })
      })
    };

    function makeRelationSelect(event1, event2) {
      const id1 = event1.event_id;
      const id2 = event2.event_id;
      const relation = relations_data.find(r => 
        r.event1_id == id1 && 
        r.event2_id == id2
      );

      const selectInput =
        $(`<select class="relation-select mg-5">`);
      
      relationTypes.forEach(type => {
        const option = $(`<option value="${type}">${type.toLowerCase()}</option>`);
        selectInput.append(option);
      });
      selectInput.append($(`<option value="NONE">none</option>`));

      selectInput.val(relation?.type ?? "NONE");
      selectInput.on('change', function () {
        const type = $(this).val();
        const event1_id = id1;
        const event2_id = id2;
        const relation = relations_data.find(r => 
          r.event1_id == event1_id && 
          r.event2_id == event2_id
        );
        if (relation) {
          relation.type = type;
        } else {
          relations_data.push({
            event1_id,
            event2_id,
            type,
          });
        }
      });

      function describeEvent(event) {
        console.log(event)
        return `${event.text} @ ${event.offset}`;
      }

      const div = $('<div>')
        .append($('<label>').text(describeEvent(event1)))
        .append(selectInput)
        .append($('<label>').text(describeEvent(event2)))

      return div;
    }

    // ensure something is in the input box
    var canSubmit = function () {
      return true;
    };

    // template role fields
    const make_role_mapping_element = function (role, text) {
      const role_text = $('<label>').html('<b>' + role + '</b>:');
      const role_field = $('<span>')
        .addClass('role-field')
        .attr({
          role: role,
          rows: 1,
        })
        .text(text)

      const role_div = $('<div>')
        .addClass('role-container')
        .append(role_text)
        .append(role_field);

      return role_div;
    }

    // number of QA pairs at the moment
    var input_count = 0;

    const add_qa_input = function () {
      const current_idx = input_count;
      let question_text = $('<label>').text('question:');
      let question_input = $('<textarea>')
        .addClass('question-input')
        .addClass('mg-15')
        .attr({
          id: 'input-question' + input_count,
          name: 'input-question' + input_count,
          placeholder: 'write down your question',
          rows: 1,
          cols: 80,
        });
      question_input.on("input", function () {
        // if (is_wh_question(question_input.val())) {
        //     window.alert("It seems you are not writing a yes/no question, make sure " +
        //         "you are writing questions of which the answer is yes or no!")
        // }
        show();
      });
      let answer_text = $('<label>').text('answer:');
      let answer_input = $('<textarea>')
        .addClass('answer-input')
        .addClass('mg-15')
        .attr({
          id: 'input-answer' + input_count,
          name: 'input-answer' + input_count,
          placeholder: 'write down your answer',
          rows: 1,
          cols: 80,
        });
      answer_input.on("input", function () {
        show();
      });

      let input_fields = $(
        '<div>').addClass('input-fields')
        .append(question_text)
        .append(question_input)
        .append(answer_text)
        .append(answer_input)
      $('#input-area').append(input_fields);

      input_count += 1;
      show();
    };

    const remove_qa_input = function () {
      if (input_count <= 0) {
        return;
      }
      $('#input-area').children().last().remove();
      input_count -= 1;
      show();
    };

    var enable_button = function (button) {
      button.removeAttr("disabled");
      button.removeClass("btn-default");
      button.addClass("btn-success");
    };

    var disable_button = function (button) {
      button.attr("disabled", "disabled");
      button.removeClass("btn-success");
      button.addClass("btn-default");
    };

    var select_button = function (button) {
      button.removeClass("btn-default");
      button.addClass("btn-primary");
    };

    var deselect_button = function (button) {
      button.removeClass("btn-primary");
      button.addClass("btn-default");
    };

    var is_wh_question = function (question) {
      let tokens = question.split(' ');
      if (tokens.length <= 1) {
        return false;
      }
      console.log(tokens);

      // let wh_pattern = /^Wh\|wh\|How\|how/;
      let wh_pattern = /^wh|Wh|how|How/;
      // console.log(question.match(wh_pattern));
      return !!question.match(wh_pattern);
    };


    var show = function () {
      for (button of document.getElementById('button-bar').getElementsByTagName('*')) {
        if (page_num_set.has(parseInt(button.getAttribute('page-no'))))
          select_button($(button));
        else
          deselect_button($(button));
      }

      if (canSubmit()) {
        enable_button(submit);
        // enable_button($('#next-btn'));
      } else {
        disable_button(submit);
        // disable_button($('#next-btn'));
      }
    };

    // dynamically create buttons for each SRL arg
    events_data.forEach(function (trigger, i) {
      if (trigger.text.trim()) {
        //console.log(trigger);
        var button = document.createElement("button");
        button.setAttribute("type", "button");
        button.setAttribute("id", "button-page-" + i);
        button.setAttribute("page-no", i);
        button.setAttribute("class", "btn btn-default");
        button.innerHTML = trigger.text + " @ token " + trigger.offset;
        button.onclick = function () {
          const pageno = parseInt(this.getAttribute("page-no"));
          // toggle button
          if (button.classList.contains('btn-default'))
            page_num_set.add(pageno);
          else
            page_num_set.delete(pageno);
          makeDom();
          let instruction = $('#instructionBody');
          if (instruction.is(':visible')) {
            instruction.toggle();
          }
          //window.scrollTo(0, 0); // scroll to top
          show();
        }
        document.getElementById('button-bar').appendChild(button);
      }

      // replace newlines with HTML line breaks
      const bootstrap = trigger.bootstrap;
      if (bootstrap !== undefined)
        trigger.bootstrap = bootstrap.replaceAll('\n', '<br>');

      // format template area with role mappings
      // if template not null or undefined
      if (trigger.template !== null) {
        const template_area = template_record[i];
        const template = $('<p>').text(trigger.template);
        template_area.append(template);
        trigger.role_text_map.forEach(function (pairing) {
          template_area.append(make_role_mapping_element(pairing.role, pairing.token?.text));
        });
      }
    })

    var clear_button = document.createElement("button");
    clear_button.setAttribute("type", "button");
    clear_button.setAttribute("class", "btn btn-default");
    clear_button.innerHTML = "Clear Triggers";
    clear_button.onclick = function () {
      page_num_set.clear();
      makeDom();
      show();
    }
    document.getElementById('button-bar').appendChild(clear_button);

    // ---------------------------------------------------------
    // Initialize
    // ---------------------------------------------------------

    makeDom(0);

    var save_all = function () {
      save_record.qapairs = [];
      save_record.relations = relations_data.filter(r => r.type !== "NONE");

      const inputAreas = $('#input-area').children();

      // traverse over elements to get QA pairs
      inputAreas.each(function (_, input) {
        const $input = $(input);
        // save qa pairs
        const question = $input.children('.question-input').val();
        const answer = $input.children('.answer-input').val();
        save_record.qapairs.push({
          'question': question,
          'answer': answer
        });
      });

      console.log(save_record);
    };

    var submit_form = function () {
      save_all();

      const urlParams = new URLSearchParams(window.location.search)

      // create the form element and point it to the correct endpoint
      const form = document.createElement('form')
      form.action = (new URL('mturk/externalSubmit', urlParams.get('turkSubmitTo'))).href
      form.method = 'post'

      // attach the assignmentId
      const inputAssignmentId = document.createElement('input')
      inputAssignmentId.name = 'assignmentId'
      inputAssignmentId.value = urlParams.get('assignmentId')
      inputAssignmentId.hidden = true
      form.appendChild(inputAssignmentId)

      // attach data I want to send back
      const inputResults = document.createElement('input')
      inputResults.name = 'results'
      inputResults.value = JSON.stringify(save_record)
      inputResults.hidden = true
      form.appendChild(inputResults)

      // attach the form to the HTML document and trigger submission
      document.body.appendChild(form)
      form.submit()
    }

    $('#save').on('click', save_all);
    submit.on('click', submit_form);

    var popup_alert = function (alert_box, text) {
      alert_box.html(text);
      alert_box.css({
        'background-color': 'fec5bb',
        'padding': '5px',
        'border': '1px solid lightgray',
        'border-radius': '10px',
        'margin-top': '10px',
        'margin-bottom': '10px'
      });
      displaying = true;
      setTimeout(function () {
        alert_box.html('');
        alert_box.css({
          'padding': '0px',
          'border': '0px'
        });
        displaying = false;
      }, 7000);
    };

    // Instructions expand/collapse
    var content = $('#instructionBody');
    var instructions_trigger = $('#collapseTrigger');
    // content.hide();
    $('.collapse-text').text('(Click to collapse)');
    instructions_trigger.click(function () {
      content.toggle();
      var isVisible = content.is(':visible');
      if (isVisible) {
        $('.collapse-text').text('(Click to collapse)');
      } else {
        $('.collapse-text').text('(Click to expand)');
      }
    });

    show();

  </script>
</crowd-form>