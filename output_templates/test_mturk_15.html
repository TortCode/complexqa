<crowd-form answer-format="flatten-objects">
  <section class="container-fluid" id="Relevancy">
    <div class="row">
      <div class="col-xs-12 col-md-12">
        <div class="panel panel-primary">
          <a class="panel-heading" href="javascript:void(0);" id="collapseTrigger">
            <strong>Annotation Instructions</strong>
            <span class="collapse-text">(Click to expand)</span>
          </a>
          <div class="panel-body" id="instructionBody">
            {{INSTRUCTIONS}}
            {{LINK}}
          </div>
        </div>
      </div>
    </div>

    <h3>Document</h3>
    <div id="document-text" class="ann well well-sm">
      A wave of <trigger id='trigger-0'>attacks</trigger> across <role id='role-1-Place'trigno='1'>Iraq</role> on Monday <trigger id='trigger-1'>killed</trigger> 107 <role id='role-1-Victim'trigno='1'>people</role> in the country's deadliest day in more than two years after <role id='role-1-Killer'trigno='1'><role id='role-0-Attacker'trigno='0'>al-Qaida</role></role> warned it would mount new attacks and sought to retake territory. Officials said at least 214 people were wounded in 27 different attacks launched in 18 cities, shattering a relative calm which had held in the lead-up to the start on Saturday of the holy Muslim fasting month of Ramadan. In Monday's deadliest attack--a string of roadside <role id='role-2-ExplosiveDevice'trigno='2'>bombs</role> and a car bomb followed by a suicide <trigger id='trigger-2'>attack</trigger> targeting emergency <role id='role-2-Target'trigno='2'>responders</role> in the town of <role id='role-3-Place'trigno='3'><role id='role-2-Place'trigno='2'>Taji</role></role>--at least 42 <role id='role-3-Victim'trigno='3'>people</role> were <trigger id='trigger-3'>killed</trigger> and 40 wounded, according to two medical officials."I heard explosions in the distance so I left my house and I saw a car outside,"said 40-year-old Taji resident Abu Mohammed, who added that police inspectors concluded the vehicle was a car bomb."We asked the neighbors to leave their houses, but when they were leaving, the bomb went off."Abu Mohammed said he witnessed the <trigger id='trigger-4'>deaths</trigger> of an elderly woman carrying a newborn baby and of the <role id='role-4-Victim'trigno='4'>policeman</role> who had first concluded the car was packed with explosives. An Agence France Presse reporter at the scene said a row of houses were completely <trigger id='trigger-5'>destroyed</trigger>, and residents were rummaging through the rubble in search of <role id='role-5-Target'trigno='5'>victims</role> and their belongings. In <role id='role-6-Place'trigno='6'>Baghdad</role>, meanwhile, a car bomb outside a government office responsible for producing identity papers in the Shiite bastion of Sadr City <trigger id='trigger-6'>killed</trigger> at least 12 <role id='role-6-Victim'trigno='6'>people</role> and wounded 22 others, security and medical officials said."This attack is a terrible crime against humanity, because they did it during Ramadan, while people are fasting,"said one elderly witness who declined to be identified. An AFP journalist said eight nearby cars were badly burned and many of the victims of the 9: 30 am (0630 GMT) attack could not be identified because their papers were inside the offices that were targeted. Two other <trigger id='trigger-7'>explosions</trigger> in the Baghdad neighborhoods of Husseiniyah and Yarmouk killed at least four people and left 24 <role id='role-7-Target'trigno='7'>others</role> wounded, while a car <role id='role-7-ExplosiveDevice'trigno='7'>bomb</role> in the town of <role id='role-7-Place'trigno='7'>Tarmiyah</role>, just north of Baghdad, hurt nine people, officials said. Checkpoint shootings and <role id='role-8-ExplosiveDevice'trigno='8'>bomb</role> <trigger id='trigger-8'>blasts</trigger> in restive ethnically-mixed <role id='role-8-Place'trigno='8'>Diyala province</role> killed 11 people and left 40 <role id='role-8-Target'trigno='8'>others</role> wounded, security officials and doctor Ahmed Ibrahim from the main hospital in provincial capital Baquba said. <role id='role-11-Victim'trigno='11'><role id='role-10-Killer'trigno='10'><role id='role-9-Attacker'trigno='9'>Insurgents</role></role></role> also launched <trigger id='trigger-9'>attacks</trigger> on a <role id='role-9-Target'trigno='9'>military base</role> near the town of <role id='role-9-Place'trigno='9'>Dhuluiyah</role>, <trigger id='trigger-10'>killing</trigger> at least 15 Iraqi <role id='role-10-Victim'trigno='10'>soldiers</role> and leaving two others <trigger id='trigger-11'>wounded</trigger>, according to two security officials. Two other attacks in the same province--a <trigger id='trigger-12'>shooting</trigger> at a checkpoint and a car <role id='role-12-Instrument'trigno='12'>bomb</role> near a Shiite <role id='role-12-Place'trigno='12'>mosque</role>--left three <role id='role-12-Target'trigno='12'>people</role> dead and six wounded, officials said. Nine <role id='role-13-ExplosiveDevice'trigno='13'>bomb</role> <trigger id='trigger-13'>blasts</trigger>, some of them minutes apart, meanwhile killed seven <role id='role-13-Target'trigno='13'>people</role> and wounded 29 in <role id='role-13-Place'trigno='13'>Kirkuk city</role> and the eponymous province's towns of Dibis and Tuz Khurmatu. Three different attacks--a car <role id='role-14-ExplosiveDevice'trigno='14'>bomb</role>, a roadside <trigger id='trigger-14'>blast</trigger> and a shooting--in the main northern city of Mosul and the nearby <role id='role-15-Place'trigno='15'>town</role> of <role id='role-14-Place'trigno='14'>Baaj</role> left nine <role id='role-15-Victim'trigno='15'>people</role> <trigger id='trigger-15'>dead</trigger> and seven wounded, according to Iraqi army First Lieutenant Waad Mohammed and police Lieutenant Mohammed al-Juburi. A roadside bomb at a market in the center of the town of Diwaniyah, south of Baghdad, killed three people and left 25 hurt, provincial health chief Adnan Turki said. In the western town of <role id='role-16-Place'trigno='16'>Heet</role>, a car <role id='role-16-ExplosiveDevice'trigno='16'>bomb</role> <trigger id='trigger-16'>exploded</trigger> near an army patrol, killing one <role id='role-16-Target'trigno='16'>soldier</role> and wounding 10 others, according to an Iraqi army captain and doctor Abdulwahab al-Shammari from the town hospital. The attacks came a day after a spate of <trigger id='trigger-17'>bombings</trigger> across <role id='role-17-Place'trigno='17'>Iraq</role> killed at least 17 <role id='role-17-Target'trigno='17'>people</role> and wounded nearly 100 others. Monday's toll was the highest since May 10, 2010, when 110 people were killed. The latest violence comes after the country suffered a spike in unrest in June when at least 282 people were killed, according to an AFP tally based on figures supplied by officials and medics, although government figures said 131 Iraqis died. Although those figures are markedly lower than during the peak of Iraq's communal bloodshed from 2006 to 2008, attacks remain common. There was no immediate claim of responsibility for Monday's attacks, but al-Qaida's front group in Iraq has warned in recent days that it seeks to retake territory in the country. The Islamic State of Iraq warned in an audio message posted on various jihadist forums that it would begin targeting judges and prosecutors, and appealed for the help of Sunni tribes in its quest to recapture territory it once held."We are starting a new stage,"said the voice on the message, purportedly that of Abu Bakr al-Baghdadi, who has been leader of the Islamic State of Iraq since May 2010."The first priority in this is releasing Muslim prisoners everywhere, and chasing and eliminating judges and investigators and their guards."It was not possible to verify whether the voice was that of Baghdadi. The speaker added:"On the occasion of the beginning of the return of the state to the areas that we left, I urge you to carry out more efforts, and send your sons with the mujahedeen to defend your religion and obey God."
    </div>

    <div id='raw-data' hidden>
      [{"event_id": "wiki_mass_car_bombings_7_news_2-E1", "text": "attacks", "offset": 3, "length": 1, "template": "[Attacker] attacked [Target] using [Instrument] at [Place] place", "role_text_map": [{"role": "Attacker", "token": {"text": "al-Qaida", "offset": 24, "length": 3}}, {"role": "Target", "token": null}, {"role": "Instrument", "token": null}, {"role": "Place", "token": null}]}, {"event_id": "wiki_mass_car_bombings_7_news_2-E2", "text": "killed", "offset": 8, "length": 1, "template": "[Victim] died at [Place] place from [MedicalIssue] medical issue, killed by [Killer] killer", "role_text_map": [{"role": "Victim", "token": {"text": "people", "offset": 10, "length": 1}}, {"role": "Place", "token": {"text": "Iraq", "offset": 5, "length": 1}}, {"role": "Killer", "token": {"text": "al-Qaida", "offset": 24, "length": 3}}, {"role": "MedicalIssue", "token": null}]}, {"event_id": "wiki_mass_car_bombings_7_news_2-E3", "text": "attack", "offset": 102, "length": 1, "template": "[Attacker] detonated or exploded [ExplosiveDevice] explosive device using [Instrument] to attack [Target] target at [Place] place", "role_text_map": [{"role": "Attacker", "token": null}, {"role": "Target", "token": {"text": "responders", "offset": 105, "length": 1}}, {"role": "Instrument", "token": null}, {"role": "ExplosiveDevice", "token": {"text": "bombs", "offset": 93, "length": 1}}, {"role": "Place", "token": {"text": "Taji", "offset": 110, "length": 1}}]}, {"event_id": "wiki_mass_car_bombings_7_news_2-E4", "text": "killed", "offset": 117, "length": 1, "template": "[Victim] died at [Place] place from [MedicalIssue] medical issue, killed by [Killer] killer", "role_text_map": [{"role": "Victim", "token": {"text": "people", "offset": 115, "length": 1}}, {"role": "Place", "token": {"text": "Taji", "offset": 110, "length": 1}}, {"role": "Killer", "token": null}, {"role": "MedicalIssue", "token": null}]}, {"event_id": "wiki_mass_car_bombings_7_news_2-E5", "text": "deaths", "offset": 200, "length": 1, "template": "[Victim] died at [Place] place from [MedicalIssue] medical issue, killed by [Killer] killer", "role_text_map": [{"role": "Victim", "token": {"text": "policeman", "offset": 212, "length": 1}}, {"role": "Place", "token": null}, {"role": "Killer", "token": null}, {"role": "MedicalIssue", "token": null}]}, {"event_id": "wiki_mass_car_bombings_7_news_2-E6", "text": "destroyed", "offset": 239, "length": 1, "template": "[Attacker] detonated or exploded [ExplosiveDevice] explosive device using [Instrument] to attack [Target] target at [Place] place", "role_text_map": [{"role": "Attacker", "token": null}, {"role": "Target", "token": {"text": "victims", "offset": 251, "length": 1}}, {"role": "Instrument", "token": null}, {"role": "ExplosiveDevice", "token": null}, {"role": "Place", "token": null}]}, {"event_id": "wiki_mass_car_bombings_7_news_2-E7", "text": "killed", "offset": 280, "length": 1, "template": "[Victim] died at [Place] place from [MedicalIssue] medical issue, killed by [Killer] killer", "role_text_map": [{"role": "Victim", "token": {"text": "people", "offset": 284, "length": 1}}, {"role": "Place", "token": {"text": "Baghdad", "offset": 257, "length": 1}}, {"role": "Killer", "token": null}, {"role": "MedicalIssue", "token": null}]}, {"event_id": "wiki_mass_car_bombings_7_news_2-E8", "text": "explosions", "offset": 372, "length": 1, "template": "[Attacker] detonated or exploded [ExplosiveDevice] explosive device using [Instrument] to attack [Target] target at [Place] place", "role_text_map": [{"role": "Attacker", "token": null}, {"role": "Target", "token": {"text": "others", "offset": 389, "length": 1}}, {"role": "Instrument", "token": null}, {"role": "ExplosiveDevice", "token": {"text": "bomb", "offset": 395, "length": 1}}, {"role": "Place", "token": {"text": "Tarmiyah", "offset": 400, "length": 1}}]}, {"event_id": "wiki_mass_car_bombings_7_news_2-E9", "text": "blasts", "offset": 418, "length": 1, "template": "[Attacker] detonated or exploded [ExplosiveDevice] explosive device using [Instrument] to attack [Target] target at [Place] place", "role_text_map": [{"role": "Attacker", "token": null}, {"role": "Target", "token": {"text": "others", "offset": 432, "length": 1}}, {"role": "Instrument", "token": null}, {"role": "ExplosiveDevice", "token": {"text": "bomb", "offset": 417, "length": 1}}, {"role": "Place", "token": {"text": "Diyala province", "offset": 424, "length": 2}}]}, {"event_id": "wiki_mass_car_bombings_7_news_2-E10", "text": "attacks", "offset": 454, "length": 1, "template": "[Attacker] attacked [Target] using [Instrument] at [Place] place", "role_text_map": [{"role": "Attacker", "token": {"text": "Insurgents", "offset": 451, "length": 1}}, {"role": "Target", "token": {"text": "military base", "offset": 457, "length": 2}}, {"role": "Instrument", "token": null}, {"role": "Place", "token": {"text": "Dhuluiyah", "offset": 463, "length": 1}}]}, {"event_id": "wiki_mass_car_bombings_7_news_2-E11", "text": "killing", "offset": 465, "length": 1, "template": "[Victim] died at [Place] place from [MedicalIssue] medical issue, killed by [Killer] killer", "role_text_map": [{"role": "Victim", "token": {"text": "soldiers", "offset": 470, "length": 1}}, {"role": "Place", "token": null}, {"role": "Killer", "token": {"text": "Insurgents", "offset": 451, "length": 1}}, {"role": "MedicalIssue", "token": null}]}, {"event_id": "wiki_mass_car_bombings_7_news_2-E12", "text": "wounded", "offset": 475, "length": 1, "template": "[Victim] was injured by [Injurer] using [Instrument] in [BodyPart] body part with [MedicalCondition] medical issue at [Place] place", "role_text_map": [{"role": "Victim", "token": {"text": "Insurgents", "offset": 451, "length": 1}}, {"role": "Injurer", "token": null}, {"role": "Instrument", "token": null}, {"role": "BodyPart", "token": null}, {"role": "MedicalCondition", "token": null}, {"role": "Place", "token": null}]}, {"event_id": "wiki_mass_car_bombings_7_news_2-E13", "text": "shooting", "offset": 492, "length": 1, "template": "[Attacker] attacked [Target] using [Instrument] at [Place] place", "role_text_map": [{"role": "Attacker", "token": null}, {"role": "Target", "token": {"text": "people", "offset": 507, "length": 1}}, {"role": "Instrument", "token": {"text": "bomb", "offset": 499, "length": 1}}, {"role": "Place", "token": {"text": "mosque", "offset": 503, "length": 1}}]}, {"event_id": "wiki_mass_car_bombings_7_news_2-E14", "text": "blasts", "offset": 518, "length": 1, "template": "[Attacker] detonated or exploded [ExplosiveDevice] explosive device using [Instrument] to attack [Target] target at [Place] place", "role_text_map": [{"role": "Attacker", "token": null}, {"role": "Target", "token": {"text": "people", "offset": 529, "length": 1}}, {"role": "Instrument", "token": null}, {"role": "ExplosiveDevice", "token": {"text": "bomb", "offset": 517, "length": 1}}, {"role": "Place", "token": {"text": "Kirkuk city", "offset": 534, "length": 2}}]}, {"event_id": "wiki_mass_car_bombings_7_news_2-E15", "text": "blast", "offset": 559, "length": 1, "template": "[Attacker] detonated or exploded [ExplosiveDevice] explosive device using [Instrument] to attack [Target] target at [Place] place", "role_text_map": [{"role": "Attacker", "token": null}, {"role": "Target", "token": null}, {"role": "Instrument", "token": null}, {"role": "ExplosiveDevice", "token": {"text": "bomb", "offset": 555, "length": 1}}, {"role": "Place", "token": {"text": "Baaj", "offset": 576, "length": 1}}]}, {"event_id": "wiki_mass_car_bombings_7_news_2-E16", "text": "dead", "offset": 580, "length": 1, "template": "[Victim] died at [Place] place from [MedicalIssue] medical issue, killed by [Killer] killer", "role_text_map": [{"role": "Victim", "token": {"text": "people", "offset": 579, "length": 1}}, {"role": "Place", "token": {"text": "town", "offset": 574, "length": 1}}, {"role": "Killer", "token": null}, {"role": "MedicalIssue", "token": null}]}, {"event_id": "wiki_mass_car_bombings_7_news_2-E17", "text": "exploded", "offset": 645, "length": 1, "template": "[Attacker] detonated or exploded [ExplosiveDevice] explosive device using [Instrument] to attack [Target] target at [Place] place", "role_text_map": [{"role": "Attacker", "token": null}, {"role": "Target", "token": {"text": "soldier", "offset": 653, "length": 1}}, {"role": "Instrument", "token": null}, {"role": "ExplosiveDevice", "token": {"text": "bomb", "offset": 644, "length": 1}}, {"role": "Place", "token": {"text": "Heet", "offset": 640, "length": 1}}]}, {"event_id": "wiki_mass_car_bombings_7_news_2-E18", "text": "bombings", "offset": 685, "length": 1, "template": "[Attacker] detonated or exploded [ExplosiveDevice] explosive device using [Instrument] to attack [Target] target at [Place] place", "role_text_map": [{"role": "Attacker", "token": null}, {"role": "Target", "token": {"text": "people", "offset": 692, "length": 1}}, {"role": "Instrument", "token": null}, {"role": "ExplosiveDevice", "token": null}, {"role": "Place", "token": {"text": "Iraq", "offset": 687, "length": 1}}]}]
    </div>

    <p>
      You can navigate all of the triggers by clicking the following buttons. <br>
      You have to finish all the triggers before submitting. (Remember that you can't refresh the page otherwise
      the progress will be gone, <br>
      to prevent this from happening, we suggest that you write the QA pairs in the google doc and copy paste them
      here)
    </p>
    <!-- Tabs for each trigger -->
    <div class="btn-toolbar" id="button-bar">
    </div>

    <section>
      <div style="margin-top:10px;">
        <em>
          These are bootstrap question answer pairs generated by GPT. Not all QA
          pairs are correct or relevant, but feel free to copy/paste the samples that are accurate
          enough, and make edits on top.
        </em>
        <div id='bootstrap-area' class='ann well well-sm'>
        </div>
      </div>

      <div style="margin-top:10px;">
        <em>
          These are KAIROS event arguments for the trigger. You can use them to help you write QA pairs.
          The underlying meaning of such pairs should be "Q: What is arg X of the event? A: arg X is Y".
          But the formatting of the QA pairs must be as in the instructions.
        </em>
        <div id='template-area' class='ann well well-sm'>
        </div>
      </div>

      <div class="btn-container">
        <button id="addbtn" class="btn btn-success" type="button" onclick="add_qa_input()">+</button>
        <label for="addbtn">Add a QA pair</label>
      </div>
      <div class="btn-container">
        <button id="rmbtn" class="btn btn-danger" type="button" onclick="remove_qa_input()">-</button>
        <label for="rmbtn">Remove a QA pair</label>
      </div>

      <div id="input-area">

      </div>
    </section>

    <div title="Highlight all fields before submitting">
      <button id="save" class="btn btn-default" type="button">Save</button>
      <button id="submitButton" class="btn btn-default" type="button">Submit</button>
    </div>
  </section>


  <link crossorigin="anonymous" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
    integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.1.0.min.js"
    integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
    integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>

  <style>
    .mg-15 {
      margin-left: 15px;
      margin-right: 15px;
    }

    .container-fluid {
      max-width: 1800px;
      margin: 30px;
    }

    .btn-container {
      display: inline-block;
      margin: 10px;
    }

    #collapseTrigger {
      color: #fff;
      display: block;
      text-decoration: none;
    }

    #submitButton {
      white-space: normal;
    }

    #input-area {
      display: block;
      margin: 10px;
    }

    #input-area>div {
      margin: 10px;
      background-color: #ffe3e3;
    }

    #bootstrap-area {
      background-color: #f7dec5;
    }

    #template-area {
      background-color: #eee;
      display: flex;
    }

    .template-map {
      border: 1px solid gray;
      padding: 5px;
    }

    .btn-container>button {
      min-width: 3em;
    }

    trigger {
      display: inline;
      background-color: lightgoldenrodyellow;
    }

    role {
      display: inline;
      background-color: lightblue;
    }

    .highlight-trigger {
      background-color: palevioletred
    }

    .highlight-role {
      background-color: lightgreen;
    }

    .btn-group {
      vertical-align: middle;
    }

    .content {
      margin-bottom: 15px;
    }

    .ann {
      font-size: 16px;
    }

    .disp {
      font-size: 20px;
    }

    .ann>span.token {
      cursor: pointer;
    }

    .ann>span.token:hover {
      text-decoration: underline;
    }

    .ann>strong.annotation:hover {
      text-decoration: line-through;
    }

    input[disabled] {
      color: #000
    }
  </style>

  <script>
    // ---------------------------------------------------------
    // Global
    // ---------------------------------------------------------

    var page_num_set = new Set();

    // ---------------------------------------------------------
    // Create jQuery elements
    // ---------------------------------------------------------

    var submit = $('#submitButton');

    // list of text/offset objects 
    var triggers_list = JSON.parse($('#raw-data').text().trim());

    const empty_template_map = function () {
      return $('<div class="template-map">');
    }

    let save_record = [];
    let template_record = [];
    triggers_list.forEach(function (_, idx) {
      template_record[idx] = empty_template_map();
    });

    // implementation of string formatting
    if (!String.prototype.format) {
      String.prototype.format = function () {
        var args = arguments;
        return this.replace(/{(\d+)}/g, function (match, number) {
          return typeof args[number] != 'undefined'
            ? args[number]
            : match
            ;
        });
      };
    }

    // ---------------------------------------------------------
    // Create elements
    // ---------------------------------------------------------

    var makeDom = function () {
      make_trigger();
      recoverUserInput();
    };

    var make_trigger = function () {
      /* highlight trigger within document */

      // remove previous highlights
      $('trigger').removeClass('highlight-trigger');
      $('role').removeClass('highlight-role');

      page_num_set.forEach(trigger_num => {
        // highlight trigger
        $('#trigger-' + trigger_num).addClass('highlight-trigger');
        $('role[trigno=' + trigger_num + ']').addClass('highlight-role');
      })

      /* update bootstrap questions */
      //$('#bootstrap-area').html(trigger.bootstrap ?? 'no bootstrap available');

    }

    // restore input from other trigger
    var recoverUserInput = function () {
      const templateArea = $('#template-area');
      // simply swap out the input area DOM element!
      templateArea.empty()
      
      page_num_set.forEach(trigger_num => {
        templateArea.append(template_record[trigger_num]);
      });
    };

    // ensure something is in the input box
    var canSubmit = function () {
      return true;
    };

    // template role fields
    const make_role_mapping_element = function (role, text) {
      const role_text = $('<label>').html('<b>' + role + '</b>:');
      const role_field = $('<span>')
        .addClass('role-field')
        .attr({
          role: role,
          rows: 1,
        })
        .text(text)

      const role_div = $('<div>')
        .addClass('role-container')
        .append(role_text)
        .append(role_field);

      return role_div;
    }

    // number of QA pairs at the moment
    var input_count = 0;

    const add_qa_input = function () {
      const current_idx = input_count;
      let question_text = $('<label>').text('question:');
      let question_input = $('<textarea>')
        .addClass('question-input')
        .addClass('mg-15')
        .attr({
          id: 'input-question' + input_count,
          name: 'input-question' + input_count,
          placeholder: 'write down your question',
          rows: 1,
          cols: 80,
        });
      question_input.on("input", function () {
        // if (is_wh_question(question_input.val())) {
        //     window.alert("It seems you are not writing a yes/no question, make sure " +
        //         "you are writing questions of which the answer is yes or no!")
        // }
        show();
      });
      let answer_text = $('<label>').text('answer:');
      let answer_input = $('<textarea>')
        .addClass('answer-input')
        .addClass('mg-15')
        .attr({
          id: 'input-answer' + input_count,
          name: 'input-answer' + input_count,
          placeholder: 'write down your answer',
          rows: 1,
          cols: 80,
        });
      answer_input.on("input", function () {
        show();
      });

      let input_fields = $(
        '<div>').addClass('input-fields')
        .append(question_text)
        .append(question_input)
        .append(answer_text)
        .append(answer_input)
      $('#input-area').append(input_fields);

      input_count += 1;
      show();
    };

    const remove_qa_input = function () {
      if (input_count <= 0) {
        return;
      }
      $('#input-area').children().last().remove();
      input_count -= 1;
      show();
    };

    var enable_button = function (button) {
      button.removeAttr("disabled");
      button.removeClass("btn-default");
      button.addClass("btn-success");
    };

    var disable_button = function (button) {
      button.attr("disabled", "disabled");
      button.removeClass("btn-success");
      button.addClass("btn-default");
    };

    var select_button = function (button) {
      button.removeClass("btn-default");
      button.addClass("btn-primary");
    };

    var deselect_button = function (button) {
      button.removeClass("btn-primary");
      button.addClass("btn-default");
    };

    var is_wh_question = function (question) {
      let tokens = question.split(' ');
      if (tokens.length <= 1) {
        return false;
      }
      console.log(tokens);

      // let wh_pattern = /^Wh\|wh\|How\|how/;
      let wh_pattern = /^wh|Wh|how|How/;
      // console.log(question.match(wh_pattern));
      return !!question.match(wh_pattern);
    };


    var show = function () {
      for (button of document.getElementById('button-bar').getElementsByTagName('*')) {
        if (page_num_set.has(parseInt(button.getAttribute('page-no'))))
          select_button($(button));
        else
          deselect_button($(button));
      }

      if (canSubmit()) {
        enable_button(submit);
        // enable_button($('#next-btn'));
      } else {
        disable_button(submit);
        // disable_button($('#next-btn'));
      }
    };

    // dynamically create buttons for each SRL arg
    triggers_list.forEach(function (trigger, i) {
      if (trigger.text.trim()) {
        console.log(trigger);
        var button = document.createElement("button");
        button.setAttribute("type", "button");
        button.setAttribute("id", "button-page-" + i);
        button.setAttribute("page-no", i);
        button.setAttribute("class", "btn btn-default");
        button.innerHTML = trigger.text + " @ token " + trigger.offset;
        button.onclick = function () {
          const pageno = parseInt(this.getAttribute("page-no"));
          // toggle button
          if (button.classList.contains('btn-default'))
            page_num_set.add(pageno);
          else
            page_num_set.delete(pageno);
          makeDom();
          let instruction = $('#instructionBody');
          if (instruction.is(':visible')) {
            instruction.toggle();
          }
          //window.scrollTo(0, 0); // scroll to top
          show();
        }
        document.getElementById('button-bar').appendChild(button);
      }

      // replace newlines with HTML line breaks
      const bootstrap = trigger.bootstrap;
      if (bootstrap !== undefined)
        trigger.bootstrap = bootstrap.replaceAll('\n', '<br>');

      // format template area with role mappings
      // if template not null or undefined
      if (trigger.template !== null) {
        const template_area = template_record[i];
        const template = $('<p>').text(trigger.template);
        template_area.append(template);
        trigger.role_text_map.forEach(function (pairing) {
          template_area.append(make_role_mapping_element(pairing.role, pairing.token?.text));
        });
      }
    })

    var clear_button = document.createElement("button");
    clear_button.setAttribute("type", "button");
    clear_button.setAttribute("class", "btn btn-default");
    clear_button.innerHTML = "Clear Triggers";
    clear_button.onclick = function () {
      page_num_set.clear();
      makeDom();
      show();
    }
    document.getElementById('button-bar').appendChild(clear_button);

    // ---------------------------------------------------------
    // Initialize
    // ---------------------------------------------------------

    makeDom(0);

    var save_all = function () {
      save_record.qapairs = [];
      save_record.triggers = [];
      // save all input
      triggers_list.forEach(function (trigger, idx) {
        // initialize record
        save_record.triggers[idx] = {
          event_id: trigger.event_id,
          trigger: {
            text: trigger.text,
            offset: trigger.offset
          },
          template: trigger.template,
          role_map: {},
        };

        // get input elements
        const template_input_area = template_record[idx];
        const template_inputs = template_input_area.children();

        // traverse over elements to get role mappings
        template_inputs.each(function (_, input) {
          const role = $(input).children('.role-field').attr('role');
          const text = $(input).children('.role-field').val();

          save_record.triggers[idx].role_map[role] = text;
        });
      });

      const trigger_input_area = $('#input-area');
      const trigger_inputs = trigger_input_area.children();

      // traverse over elements to get QA pairs
      trigger_inputs.each(function (_, input) {
        // save qa pairs
        const question = $(input).children('.question-input').val();
        const answer = $(input).children('.answer-input').val();
        save_record.qapairs.push({
          'question': question,
          'answer': answer
        });
      });

      console.log(save_record);
    };

    var submit_form = function () {
      save_all();

      const urlParams = new URLSearchParams(window.location.search)

      // create the form element and point it to the correct endpoint
      const form = document.createElement('form')
      form.action = (new URL('mturk/externalSubmit', urlParams.get('turkSubmitTo'))).href
      form.method = 'post'

      // attach the assignmentId
      const inputAssignmentId = document.createElement('input')
      inputAssignmentId.name = 'assignmentId'
      inputAssignmentId.value = urlParams.get('assignmentId')
      inputAssignmentId.hidden = true
      form.appendChild(inputAssignmentId)

      // attach data I want to send back
      const inputResults = document.createElement('input')
      inputResults.name = 'results'
      inputResults.value = JSON.stringify(save_record)
      inputResults.hidden = true
      form.appendChild(inputResults)

      // attach the form to the HTML document and trigger submission
      document.body.appendChild(form)
      form.submit()
    }

    $('#save').on('click', save_all);
    submit.on('click', submit_form);

    var popup_alert = function (alert_box, text) {
      alert_box.html(text);
      alert_box.css({
        'background-color': 'fec5bb',
        'padding': '5px',
        'border': '1px solid lightgray',
        'border-radius': '10px',
        'margin-top': '10px',
        'margin-bottom': '10px'
      });
      displaying = true;
      setTimeout(function () {
        alert_box.html('');
        alert_box.css({
          'padding': '0px',
          'border': '0px'
        });
        displaying = false;
      }, 7000);
    };

    // Instructions expand/collapse
    var content = $('#instructionBody');
    var instructions_trigger = $('#collapseTrigger');
    // content.hide();
    $('.collapse-text').text('(Click to collapse)');
    instructions_trigger.click(function () {
      content.toggle();
      var isVisible = content.is(':visible');
      if (isVisible) {
        $('.collapse-text').text('(Click to collapse)');
      } else {
        $('.collapse-text').text('(Click to expand)');
      }
    });

    show();

  </script>
</crowd-form>