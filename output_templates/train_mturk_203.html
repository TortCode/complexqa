<crowd-form answer-format="flatten-objects">
  <section class="container-fluid" id="Relevancy">
    <div class="row">
      <div class="col-xs-12 col-md-12">
        <div class="panel panel-primary">
          <a class="panel-heading" href="javascript:void(0);" id="collapseTrigger">
            <strong>Annotation Instructions</strong>
            <span class="collapse-text">(Click to expand)</span>
          </a>
          <div class="panel-body" id="instructionBody">
            {{INSTRUCTIONS}}
            {{LINK}}
          </div>
        </div>
      </div>
    </div>

    <h3>Document</h3>
    <div id="document-text" class="ann well well-sm">
      President Nicolas Maduro remembered the fateful day and said that"like a phoenix,"the Venezuelan people resurfaced to proudly stand today. As Venezuelans commemorate the 82nd anniversary of the Bolivarian National Armed Forces, Aug. 4 also marks a critical day in the country’s recent history. One year ago, in a <trigger id='trigger-9'>speech</trigger> during the 81st anniversary, President <role id='role-9-Communicator'trigno='9'><role id='role-0-Victim'trigno='0'>Nicolas Maduro</role></role> was the target of a failed <trigger id='trigger-0'>assassination</trigger> attempt."They not only came for me, but they also came for everyone, for the people, and for our country, wanting to undermine the peace and sovereignty of the nation,"<role id='role-10-Communicator'trigno='10'>the president</role> said Sunday remembering the frustrated attempt in a <trigger id='trigger-10'>speech</trigger> from the Military Academy in Caracas."But God intervened and like the phoenix, we resurfaced from the ashes of a terrorist <trigger id='trigger-11'>attack</trigger> and today a year later I can say that we are standing,"he added, affirming, once again, the masterminds were the Colombian and United States government. On Aug. 4, 2018, an explosive-loaded drone <trigger id='trigger-3'>detonated</trigger> before reaching a stage where President <role id='role-4-Communicator'trigno='4'>Maduro</role> was <trigger id='trigger-4'>delivering</trigger> a speech during a military parade in the capital. At that time, the Venezuelan right-wing opposition and its allies, one of which was the U. S. National Security Advisor John Bolton, said the <trigger id='trigger-5'>explosion</trigger> was"a montage."“After the brief moment of confusion, <role id='role-6-Identifier'trigno='6'>we</role> <trigger id='trigger-6'>knew</trigger> it was an attack. There were many speculations and lies afterward in the networks but we insisted that it had been an <trigger id='trigger-1'>assassination</trigger> attempt,” Mariela Lopez, a freelance videographer for HispanTV and Xinhua, remembered; as her images, taken in the precise moment of the explosion and the security team's response, were shown around the world. Despite the evidence, global mainstream media <trigger id='trigger-12'>ridiculed</trigger> the drone attack using qualifiers such as"presumed","supposed","confusing event"and"alleged drones". On Aug. 5, 2018, for instance, CNN Spanish titled an article"the world reacts to the alleged attack against Nicolas Maduro."New videos obtained by CNN provide insight into last year's drone <trigger id='trigger-7'>attack</trigger> against #Venezuela's sitting president Nicolas #Maduro. It may be the world's first known attempt to kill a head of state with a retail drone. @ npwcnn reports: https: / / t. co / A0qJ1Vd3cf — Michael Rios (@ MikeRiosNews) March 14, 2019 However, as time went on truth surfaced and on March 2019, CNN revealed unpublished images of how such <trigger id='trigger-13'>attack</trigger> was prepared on a Colombian farm, information which was provided by one of whom were involved in the attempted attack. The report agreed with the government's assertions about the attack. CNN then published an interview with a Venezuelan dissident who organized the <trigger id='trigger-14'>attack</trigger>. <role id='role-15-Identifier'trigno='15'><role id='role-2-Perpetrator'trigno='2'>He</role></role> <trigger id='trigger-15'>admitted</trigger> that the objective was to <trigger id='trigger-2'>assassinate</trigger> <role id='role-2-Victim'trigno='2'>Maduro</role>, an outcome which involved expecting some"collateral damages.""[Killing other people] was the risk we had to take,"the attack organizer said in response to questions and explained that the drones were purchased online and imported to a Colombian farm, where plotters were training day and night in the handling of the devices. The Venezuelan conspirator also assured that U. S. government officials had three meetings with the plotters after the assassination attempt occurred. In those meetings, according to CNN, these officials only"took notes"on the background of the plan and its failure. On June 11, Venezuela’s Attorney General, Tarek William Saab, informed that 38 <role id='role-8-Defendant'trigno='8'>suspects</role> have been <trigger id='trigger-8'>indicted</trigger> in the case of the frustrated assassination attempt and as investigations continue, of the 38 linked so far, 31 are deprived of liberty and seven received substitutive measures. 
    </div>

    <div id='events-data' hidden>
      [{"event_id": "scenario_en_122-E1", "text": "assassination", "offset": 75, "length": 1, "template": "[Perpetrator] committed a crime against [Victim] at [Place] place", "role_text_map": [{"role": "Perpetrator", "token": null}, {"role": "Victim", "token": {"text": "Nicolas Maduro", "entity_id": "scenario_en_122-T30", "offset": 67, "length": 2}}, {"role": "Place", "token": null}]}, {"event_id": "scenario_en_122-E2", "text": "assassination", "offset": 285, "length": 1, "template": "[Perpetrator] committed a crime against [Victim] at [Place] place", "role_text_map": [{"role": "Perpetrator", "token": null}, {"role": "Victim", "token": null}, {"role": "Place", "token": null}]}, {"event_id": "scenario_en_122-E3", "text": "assassinate", "offset": 536, "length": 1, "template": "[Perpetrator] committed a crime against [Victim] at [Place] place", "role_text_map": [{"role": "Perpetrator", "token": {"text": "He", "entity_id": "scenario_en_122-T73", "offset": 529, "length": 1}}, {"role": "Victim", "token": {"text": "Maduro", "entity_id": "scenario_en_122-T32", "offset": 537, "length": 1}}, {"role": "Place", "token": null}]}, {"event_id": "scenario_en_122-E4", "text": "detonated", "offset": 194, "length": 1, "template": "[Attacker] detonated or exploded [ExplosiveDevice] explosive device using [Instrument] to attack [Target] target at [Place] place", "role_text_map": [{"role": "Attacker", "token": null}, {"role": "Target", "token": null}, {"role": "Instrument", "token": null}, {"role": "ExplosiveDevice", "token": null}, {"role": "Place", "token": null}]}, {"event_id": "scenario_en_122-E5", "text": "delivering", "offset": 203, "length": 1, "template": "[Communicator] communicated to [Recipient] about [Topic] topic using [Instrument] at [Place] place (one-way communication)", "role_text_map": [{"role": "Communicator", "token": {"text": "Maduro", "entity_id": "scenario_en_122-T31", "offset": 201, "length": 1}}, {"role": "Recipient", "token": null}, {"role": "Instrument", "token": null}, {"role": "Topic", "token": null}, {"role": "Place", "token": null}]}, {"event_id": "scenario_en_122-E6", "text": "explosion", "offset": 245, "length": 1, "template": "[Attacker] detonated or exploded [ExplosiveDevice] explosive device using [Instrument] to attack [Target] target at [Place] place", "role_text_map": [{"role": "Attacker", "token": null}, {"role": "Target", "token": null}, {"role": "Instrument", "token": null}, {"role": "ExplosiveDevice", "token": null}, {"role": "Place", "token": null}]}, {"event_id": "scenario_en_122-E7", "text": "knew", "offset": 261, "length": 1, "template": "[Identifier] identified [IdentifiedObject] as [IdentifiedRole] at [Place] place", "role_text_map": [{"role": "Identifier", "token": {"text": "we", "entity_id": "scenario_en_122-T7", "offset": 260, "length": 1}}, {"role": "IdentifiedObject", "token": null}, {"role": "IdentifiedRole", "token": null}, {"role": "Place", "token": null}]}, {"event_id": "scenario_en_122-E8", "text": "attack", "offset": 402, "length": 1, "template": "[Attacker] attacked [Target] using [Instrument] at [Place] place", "role_text_map": [{"role": "Attacker", "token": null}, {"role": "Target", "token": null}, {"role": "Instrument", "token": null}, {"role": "Place", "token": null}]}, {"event_id": "scenario_en_122-E9", "text": "indicted", "offset": 671, "length": 1, "template": "[Prosecutor] charged or indicted [Defendant] before [JudgeCourt] court or judge for [Crime] crime in [Place] place", "role_text_map": [{"role": "Prosecutor", "token": null}, {"role": "Defendant", "token": {"text": "suspects", "entity_id": "scenario_en_122-T90", "offset": 668, "length": 1}}, {"role": "JudgeCourt", "token": null}, {"role": "Crime", "token": null}, {"role": "Place", "token": null}]}, {"event_id": "scenario_en_122-E10", "text": "speech", "offset": 60, "length": 1, "template": "[Communicator] communicated to [Recipient] about [Topic] topic using [Instrument] at [Place] place (one-way communication)", "role_text_map": [{"role": "Communicator", "token": {"text": "Nicolas Maduro", "entity_id": "scenario_en_122-T30", "offset": 67, "length": 2}}, {"role": "Recipient", "token": null}, {"role": "Instrument", "token": null}, {"role": "Topic", "token": null}, {"role": "Place", "token": null}]}, {"event_id": "scenario_en_122-E11", "text": "speech", "offset": 124, "length": 1, "template": "[Communicator] communicated to [Recipient] about [Topic] topic using [Instrument] at [Place] place (one-way communication)", "role_text_map": [{"role": "Communicator", "token": {"text": "the president", "entity_id": "scenario_en_122-T41", "offset": 114, "length": 2}}, {"role": "Recipient", "token": null}, {"role": "Instrument", "token": null}, {"role": "Topic", "token": null}, {"role": "Place", "token": null}]}, {"event_id": "scenario_en_122-E12", "text": "attack", "offset": 149, "length": 1, "template": "[Attacker] attacked [Target] using [Instrument] at [Place] place", "role_text_map": [{"role": "Attacker", "token": null}, {"role": "Target", "token": null}, {"role": "Instrument", "token": null}, {"role": "Place", "token": null}]}, {"event_id": "scenario_en_122-E13", "text": "ridiculed", "offset": 335, "length": 1, "template": "[Identifier] identified [IdentifiedObject] as [IdentifiedRole] at [Place] place", "role_text_map": [{"role": "Identifier", "token": null}, {"role": "IdentifiedObject", "token": null}, {"role": "IdentifiedRole", "token": null}, {"role": "Place", "token": null}]}, {"event_id": "scenario_en_122-E14", "text": "attack", "offset": 479, "length": 1, "template": "[Attacker] attacked [Target] using [Instrument] at [Place] place", "role_text_map": [{"role": "Attacker", "token": null}, {"role": "Target", "token": null}, {"role": "Instrument", "token": null}, {"role": "Place", "token": null}]}, {"event_id": "scenario_en_122-E15", "text": "attack", "offset": 527, "length": 1, "template": "[Attacker] attacked [Target] using [Instrument] at [Place] place", "role_text_map": [{"role": "Attacker", "token": null}, {"role": "Target", "token": null}, {"role": "Instrument", "token": null}, {"role": "Place", "token": null}]}, {"event_id": "scenario_en_122-E16", "text": "admitted", "offset": 530, "length": 1, "template": "[Identifier] identified [IdentifiedObject] as [IdentifiedRole] at [Place] place", "role_text_map": [{"role": "Identifier", "token": {"text": "He", "entity_id": "scenario_en_122-T73", "offset": 529, "length": 1}}, {"role": "IdentifiedObject", "token": null}, {"role": "IdentifiedRole", "token": null}, {"role": "Place", "token": null}]}]
    </div>

    <div id='relations-data' hidden>
      []
    </div>

    <p>
      You can navigate all of the triggers by clicking the following buttons. <br>
      You have to finish all the triggers before submitting. (Remember that you can't refresh the page otherwise
      the progress will be gone, <br>
      to prevent this from happening, we suggest that you write the QA pairs in the google doc and copy paste them
      here)
    </p>
    <!-- Tabs for each trigger -->
    <div class="btn-toolbar" id="button-bar">
    </div>

    <section>
      <div style="margin-top:10px;">
        <em>
          These are bootstrap question answer pairs generated by GPT. 
        </em>
        <div id='bootstrap-area' class='ann well well-sm'>
        </div>
      </div>

      <div style="margin-top:10px;">
        <em>
          These are relations between events.
        </em>
        <div id='relations-area' class='ann well well-sm'>
        </div>
      </div>

      <div style="margin-top:10px;">
        <em>
          KAIROS event arguments for triggers
        </em>
        <div id='template-area' class='ann well well-sm'>
        </div>
      </div>

      <div class="btn-container">
        <button id="addbtn" class="btn btn-success" type="button" onclick="add_qa_input()">+</button>
        <label for="addbtn">Add a QA pair</label>
      </div>
      <div class="btn-container">
        <button id="rmbtn" class="btn btn-danger" type="button" onclick="remove_qa_input()">-</button>
        <label for="rmbtn">Remove a QA pair</label>
      </div>

      <div id="input-area">

      </div>
    </section>

    <div title="Highlight all fields before submitting">
      <button id="save" class="btn btn-default" type="button">Save</button>
      <button id="submitButton" class="btn btn-default" type="button">Submit</button>
    </div>
  </section>


  <link crossorigin="anonymous" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
    integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.1.0.min.js"
    integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
    integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>

  <style>
    .mg-15 {
      margin-left: 15px;
      margin-right: 15px;
    }

    .mg-5 {
      margin: 5px;
    }

    .container-fluid {
      max-width: 1800px;
      margin: 30px;
    }

    .btn-container {
      display: inline-block;
      margin: 10px;
    }

    #collapseTrigger {
      color: #fff;
      display: block;
      text-decoration: none;
    }

    #submitButton {
      white-space: normal;
    }

    #input-area {
      display: block;
      margin: 10px;
    }

    #input-area>div {
      margin: 10px;
      background-color: #ffe3e3;
    }

    #bootstrap-area {
      background-color: #f7dec5;
    }

    #template-area {
      background-color: #eee;
      display: flex;
    }

    .template-map {
      border: 1px solid gray;
      padding: 5px;
    }

    .btn-container>button {
      min-width: 3em;
    }

    trigger {
      display: inline;
    }

    role {
      display: inline;
    }

    .highlight-trigger {
      background-color: lightgoldenrodyellow;
    }

    .highlight-role {
      background-color: lightblue;
    }

    .btn-group {
      vertical-align: middle;
    }

    .content {
      margin-bottom: 15px;
    }

    .ann {
      font-size: 16px;
    }

    .disp {
      font-size: 20px;
    }

    .ann>span.token {
      cursor: pointer;
    }

    .ann>span.token:hover {
      text-decoration: underline;
    }

    .ann>strong.annotation:hover {
      text-decoration: line-through;
    }

    input[disabled] {
      color: #000
    }
  </style>

  <script>
    // ---------------------------------------------------------
    // Global
    // ---------------------------------------------------------

    var page_num_set = new Set();

    // ---------------------------------------------------------
    // Create jQuery elements
    // ---------------------------------------------------------

    var submit = $('#submitButton');

    // list of text/offset objects 
    let events_data = JSON.parse($('#events-data').text().trim());
    let relations_data = JSON.parse($('#relations-data').text().trim());

    const empty_template_map = function () {
      return $('<div class="template-map">');
    }

    let save_record = [];
    let template_record = [];
    events_data.forEach(function (_, idx) {
      template_record[idx] = empty_template_map();
    });

    // implementation of string formatting
    if (!String.prototype.format) {
      String.prototype.format = function () {
        var args = arguments;
        return this.replace(/{(\d+)}/g, function (match, number) {
          return typeof args[number] != 'undefined'
            ? args[number]
            : match
            ;
        });
      };
    }

    // ---------------------------------------------------------
    // Create elements
    // ---------------------------------------------------------

    var makeDom = function () {
      highlightEvent();
      recoverUserInput();
    };

    var highlightEvent = function () {
      /* highlight trigger within document */

      // remove previous highlights
      $('trigger').removeClass('highlight-trigger');
      $('role').removeClass('highlight-role');

      page_num_set.forEach(trigger_num => {
        // highlight trigger
        $('#trigger-' + trigger_num).addClass('highlight-trigger');
        $('role[trigno=' + trigger_num + ']').addClass('highlight-role');
      })

      /* update bootstrap questions */
      //$('#bootstrap-area').html(trigger.bootstrap ?? 'no bootstrap available');

    }

    const relationTypes = [
      "BEFORE",
      "AFTER",
      "OVERLAPS",
      "RIGHT-AFTER",
      "RIGHT-BEFORE",
      "EQUAL",
      "CONTAINS",
      "CAUSALITY",
    ]

    // restore input from other trigger
    var recoverUserInput = function () {
      // insert template mapping
      const templateArea = $('#template-area');
      templateArea.empty()
      page_num_set.forEach(trigger_num => {
        templateArea.append(template_record[trigger_num]);
      });

      // relations
      const relationsArea = $('#relations-area');
      relationsArea.empty();

      const pagenos = Array.from(page_num_set);
      pagenos.forEach(i => {
        pagenos.forEach(j => {
          if (i == j) return;

          const event1 = events_data[i];
          const event2 = events_data[j];
          const select = makeRelationSelect(event1, event2);
          relationsArea.append(select);
        })
      })
    };

    function makeRelationSelect(event1, event2) {
      const id1 = event1.event_id;
      const id2 = event2.event_id;
      const relation = relations_data.find(r => 
        r.event1_id == id1 && 
        r.event2_id == id2
      );

      const selectInput =
        $(`<select class="relation-select mg-5">`);
      
      relationTypes.forEach(type => {
        const option = $(`<option value="${type}">${type.toLowerCase()}</option>`);
        selectInput.append(option);
      });
      selectInput.append($(`<option value="NONE">none</option>`));

      selectInput.val(relation?.type ?? "NONE");
      selectInput.on('change', function () {
        const type = $(this).val();
        const event1_id = id1;
        const event2_id = id2;
        const relation = relations_data.find(r => 
          r.event1_id == event1_id && 
          r.event2_id == event2_id
        );
        if (relation) {
          relation.type = type;
        } else {
          relations_data.push({
            event1_id,
            event2_id,
            type,
          });
        }
      });

      function describeEvent(event) {
        console.log(event)
        return `${event.text} @ ${event.offset}`;
      }

      const div = $('<div>')
        .append($('<label>').text(describeEvent(event1)))
        .append(selectInput)
        .append($('<label>').text(describeEvent(event2)))

      return div;
    }

    // ensure something is in the input box
    var canSubmit = function () {
      return true;
    };

    // template role fields
    const make_role_mapping_element = function (role, text) {
      const role_text = $('<label>').html('<b>' + role + '</b>:');
      const role_field = $('<span>')
        .addClass('role-field')
        .attr({
          role: role,
          rows: 1,
        })
        .text(text)

      const role_div = $('<div>')
        .addClass('role-container')
        .append(role_text)
        .append(role_field);

      return role_div;
    }

    // number of QA pairs at the moment
    var input_count = 0;

    const add_qa_input = function () {
      const current_idx = input_count;
      let question_text = $('<label>').text('question:');
      let question_input = $('<textarea>')
        .addClass('question-input')
        .addClass('mg-15')
        .attr({
          id: 'input-question' + input_count,
          name: 'input-question' + input_count,
          placeholder: 'write down your question',
          rows: 1,
          cols: 80,
        });
      question_input.on("input", function () {
        // if (is_wh_question(question_input.val())) {
        //     window.alert("It seems you are not writing a yes/no question, make sure " +
        //         "you are writing questions of which the answer is yes or no!")
        // }
        show();
      });
      let answer_text = $('<label>').text('answer:');
      let answer_input = $('<textarea>')
        .addClass('answer-input')
        .addClass('mg-15')
        .attr({
          id: 'input-answer' + input_count,
          name: 'input-answer' + input_count,
          placeholder: 'write down your answer',
          rows: 1,
          cols: 80,
        });
      answer_input.on("input", function () {
        show();
      });

      let input_fields = $(
        '<div>').addClass('input-fields')
        .append(question_text)
        .append(question_input)
        .append(answer_text)
        .append(answer_input)
      $('#input-area').append(input_fields);

      input_count += 1;
      show();
    };

    const remove_qa_input = function () {
      if (input_count <= 0) {
        return;
      }
      $('#input-area').children().last().remove();
      input_count -= 1;
      show();
    };

    var enable_button = function (button) {
      button.removeAttr("disabled");
      button.removeClass("btn-default");
      button.addClass("btn-success");
    };

    var disable_button = function (button) {
      button.attr("disabled", "disabled");
      button.removeClass("btn-success");
      button.addClass("btn-default");
    };

    var select_button = function (button) {
      button.removeClass("btn-default");
      button.addClass("btn-primary");
    };

    var deselect_button = function (button) {
      button.removeClass("btn-primary");
      button.addClass("btn-default");
    };

    var is_wh_question = function (question) {
      let tokens = question.split(' ');
      if (tokens.length <= 1) {
        return false;
      }
      console.log(tokens);

      // let wh_pattern = /^Wh\|wh\|How\|how/;
      let wh_pattern = /^wh|Wh|how|How/;
      // console.log(question.match(wh_pattern));
      return !!question.match(wh_pattern);
    };


    var show = function () {
      for (button of document.getElementById('button-bar').getElementsByTagName('*')) {
        if (page_num_set.has(parseInt(button.getAttribute('page-no'))))
          select_button($(button));
        else
          deselect_button($(button));
      }

      if (canSubmit()) {
        enable_button(submit);
        // enable_button($('#next-btn'));
      } else {
        disable_button(submit);
        // disable_button($('#next-btn'));
      }
    };

    // dynamically create buttons for each SRL arg
    events_data.forEach(function (trigger, i) {
      if (trigger.text.trim()) {
        //console.log(trigger);
        var button = document.createElement("button");
        button.setAttribute("type", "button");
        button.setAttribute("id", "button-page-" + i);
        button.setAttribute("page-no", i);
        button.setAttribute("class", "btn btn-default");
        button.innerHTML = trigger.text + " @ token " + trigger.offset;
        button.onclick = function () {
          const pageno = parseInt(this.getAttribute("page-no"));
          // toggle button
          if (button.classList.contains('btn-default'))
            page_num_set.add(pageno);
          else
            page_num_set.delete(pageno);
          makeDom();
          let instruction = $('#instructionBody');
          if (instruction.is(':visible')) {
            instruction.toggle();
          }
          //window.scrollTo(0, 0); // scroll to top
          show();
        }
        document.getElementById('button-bar').appendChild(button);
      }

      // replace newlines with HTML line breaks
      const bootstrap = trigger.bootstrap;
      if (bootstrap !== undefined)
        trigger.bootstrap = bootstrap.replaceAll('\n', '<br>');

      // format template area with role mappings
      // if template not null or undefined
      if (trigger.template !== null) {
        const template_area = template_record[i];
        const template = $('<p>').text(trigger.template);
        template_area.append(template);
        trigger.role_text_map.forEach(function (pairing) {
          template_area.append(make_role_mapping_element(pairing.role, pairing.token?.text));
        });
      }
    })

    var clear_button = document.createElement("button");
    clear_button.setAttribute("type", "button");
    clear_button.setAttribute("class", "btn btn-default");
    clear_button.innerHTML = "Clear Triggers";
    clear_button.onclick = function () {
      page_num_set.clear();
      makeDom();
      show();
    }
    document.getElementById('button-bar').appendChild(clear_button);

    // ---------------------------------------------------------
    // Initialize
    // ---------------------------------------------------------

    makeDom(0);

    var save_all = function () {
      save_record.qapairs = [];
      save_record.relations = relations_data.filter(r => r.type !== "NONE");

      const inputAreas = $('#input-area').children();

      // traverse over elements to get QA pairs
      inputAreas.each(function (_, input) {
        const $input = $(input);
        // save qa pairs
        const question = $input.children('.question-input').val();
        const answer = $input.children('.answer-input').val();
        save_record.qapairs.push({
          'question': question,
          'answer': answer
        });
      });

      console.log(save_record);
    };

    var submit_form = function () {
      save_all();

      const urlParams = new URLSearchParams(window.location.search)

      // create the form element and point it to the correct endpoint
      const form = document.createElement('form')
      form.action = (new URL('mturk/externalSubmit', urlParams.get('turkSubmitTo'))).href
      form.method = 'post'

      // attach the assignmentId
      const inputAssignmentId = document.createElement('input')
      inputAssignmentId.name = 'assignmentId'
      inputAssignmentId.value = urlParams.get('assignmentId')
      inputAssignmentId.hidden = true
      form.appendChild(inputAssignmentId)

      // attach data I want to send back
      const inputResults = document.createElement('input')
      inputResults.name = 'results'
      inputResults.value = JSON.stringify(save_record)
      inputResults.hidden = true
      form.appendChild(inputResults)

      // attach the form to the HTML document and trigger submission
      document.body.appendChild(form)
      form.submit()
    }

    $('#save').on('click', save_all);
    submit.on('click', submit_form);

    var popup_alert = function (alert_box, text) {
      alert_box.html(text);
      alert_box.css({
        'background-color': 'fec5bb',
        'padding': '5px',
        'border': '1px solid lightgray',
        'border-radius': '10px',
        'margin-top': '10px',
        'margin-bottom': '10px'
      });
      displaying = true;
      setTimeout(function () {
        alert_box.html('');
        alert_box.css({
          'padding': '0px',
          'border': '0px'
        });
        displaying = false;
      }, 7000);
    };

    // Instructions expand/collapse
    var content = $('#instructionBody');
    var instructions_trigger = $('#collapseTrigger');
    // content.hide();
    $('.collapse-text').text('(Click to collapse)');
    instructions_trigger.click(function () {
      content.toggle();
      var isVisible = content.is(':visible');
      if (isVisible) {
        $('.collapse-text').text('(Click to collapse)');
      } else {
        $('.collapse-text').text('(Click to expand)');
      }
    });

    show();

  </script>
</crowd-form>